---
title: "Civilian Contract Statistics Model Complete"
author: "Greg Sanders"
date: "Monday, March 23, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#*************************************Required Libraries******************************************
require(plyr)
require(grid)
require(reshape2)
require(stringr)
require(ggplot2)
library(Hmisc)
library(readr)
#*************************************Options*****************************************************
options(error=recover)
options(warn=1)

#*************************************Lookup Files*****************************************************

Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"

# Path<-"~\\FPDS\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source("ContractCleanup.r")
source(paste(Path,"helper.r",sep=""))
source(paste(Path,"lookups.r",sep=""))

```

#Combining Source Files
##Sample Criteria
```{r DetailCustomer}

FederalModelAndDetail <-readr::read_delim(
  "Data\\Civilian_contract_SP_ContractSampleCriteriaDetailsCustomer.csv",
  col_names=TRUE, 
  delim=",",
  # , dec=".",
  trim_ws=TRUE,
  na=c("NULL","NA")
  # stringsAsFactors=FALSE
)

FederalModelAndDetail<-csis360::standardize_variable_names(FederalModelAndDetail)


#Limit to completed contracts that start in 2007 or later
FederalModelAndDetail$LastCurrentCompletionDate<-strptime(FederalModelAndDetail$LastCurrentCompletionDate,"%Y-%m-%d") 
#Drop contracts starting before the study period
FederalModelAndDetail<-subset(FederalModelAndDetail,
  StartFiscal_Year>=2007 
  &
    (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1)
)



# FederalModelAndDetail<-subset(FederalModelAndDetail,select=-c(StartFiscal_Year
# ,IsClosed
# ,LastSignedLastDateToOrder
#                                                       ,LastUltimateCompletionDate
# ))
save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)


```

##Details

```{r ContractDetailsCustomer}

FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail,
    lookup_file="Civilian_Contract_SP_ContractDetailsCustomer.csv",
  path="",
  directory = "Data/",
  by="CSIScontractID",
  new_var_checked=FALSE
)

FederalModelAndDetail<-csis360::standardize_variable_names(FederalModelAndDetail)

FederalModelAndDetail<-subset(FederalModelAndDetail,select=-c(
  Number.Of.Actions,
  #     Action.Obligation,
  StartFiscal_Year
  #     MinOfSignedDate,
  #     ,LastCurrentCompletionDate
))
# FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
#     c(
#         # Number.Of.Actions,
#   #     Action.Obligation,
#   # StartFiscal_Year
#   #     MinOfSignedDate,
#   #     ,LastCurrentCompletionDate
#     )]

save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)
```

## ContractingDelta
```{r ContractingDelta}

#Civilian_contract_SP_ContractModificationDeltaCustomer.csv
FederalModelAndDetail<-csis360::read_and_join_experiment(FederalModelAndDetail,
  "Civilian_contract_SP_ContractModificationDeltaCustomer.csv",
  "",
  "Data\\",
  by="CSIScontractID",
  new_var_checked=FALSE
)

FederalModelAndDetail<-csis360::standardize_variable_names(FederalModelAndDetail)

FederalModelAndDetail$ChangeOrderObligatedAmount<-FactorToNumber(FederalModelAndDetail$ChangeOrderObligatedAmount)
FederalModelAndDetail$ChangeOrderBaseAndAllOptionsValue<-FactorToNumber(FederalModelAndDetail$ChangeOrderBaseAndAllOptionsValue)


FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
    "ChangeOrderObligatedAmount"             ,
    "ChangeOrderBaseAndExercisedOptionsValue",
#     ChangeOrderBaseAndAllOptionsValue      ,
    "NewWorkObligatedAmount",
    "NewWorkBaseAndExercisedOptionsValue"    
    # "NewWorkBaseAndAllOptionsValue",
    )]
save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)
```
##Location
```{r Location}

#Civilian_contract_SP_ContractLocationCustomer.csv
FederalModelAndDetail<-csis360::read_and_join_experiment(FederalModelAndDetail,
  "Civilian_contract_SP_ContractLocationCustomer.txt"
  ,""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

FederalModelAndDetail<-csis360::standardize_variable_names(FederalModelAndDetail)

FederalModelAndDetail$ObligatedAmountIsInternational<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsInternational)
FederalModelAndDetail$pIsInternational<-FederalModelAndDetail$ObligatedAmountPlaceIsInternational/
  FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsInternational[is.na(FederalModelAndDetail$ObligatedAmountPlaceIsInternational)] <- 0

if(is.numeric(FederalModelAndDetail$AnyPlaceInternational)){
  FederalModelAndDetail$AnyPlaceInternational<-factor(FederalModelAndDetail$AnyPlaceInternational,
    exclude=NULL,
    levels=c(0,1,NA),
    labels=c("Just U.S.","Any International","Unlabeled")
  )
}
FederalModelAndDetail$AnyPlaceInternational[FederalModelAndDetail$pIsInternational<=0 & 
    FederalModelAndDetail$AnyPlaceInternational=="Any International" &
    FederalModelAndDetail$UnmodifiedPlaceIsInternational==0]<-"Just U.S."

FederalModelAndDetail$UnmodifiedPlaceCountryISO3<-factor(FederalModelAndDetail$UnmodifiedPlaceCountryISO3)
FederalModelAndDetail$UnmodifiedVendorCountryISO3<-factor(FederalModelAndDetail$UnmodifiedVendorCountryISO3)
FederalModelAndDetail$VendorCountryISO3<-factor(FederalModelAndDetail$VendorCountryISO3)
FederalModelAndDetail$UnmodifiedOriginCountryISO3<-factor(FederalModelAndDetail$UnmodifiedOriginCountryISO3)
FederalModelAndDetail$OriginCountryISO3<-factor(FederalModelAndDetail$OriginCountryISO3)
UnmodifiedVendorCountryISO3


FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
  "UnmodifiedPlaceIsInternational",
  "PlaceIsInternational",
  "ObligatedAmountPlaceIsInternational",
        # "UnmodifiedVendorIsInternational",
  # "VendorIsInternational",
  "ObligatedAmountVendorIsInternational",
      # "UnmodifiedOriginIsInternational",
  # "OriginIsInternational",
  "ObligatedAmountOriginIsInternational",
  # "UnmodifiedPlaceCountryISO3",
  "PlaceCountryISO3"
    )]
# load(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata")



save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)


```

##Outcome
```{r Outcome}
#"data\\Civilian_contract_SP_ContractUnmodifiedandOutcomeDetailsCustomer.csv"

FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail
  ,"Civilian_Contract_SP_ContractUnmodifiedAndOutcomeDetailsCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

FederalModelAndDetail<-csis360::standardize_variable_names(FederalModelAndDetail)


FederalModelAndDetail$UnmodifiedCurrentCompletionDate<-
  strptime(FederalModelAndDetail$UnmodifiedCurrentCompletionDate,"%Y-%m-%d") 

#Calculate the number of days the contract lasts.
FederalModelAndDetail$UnmodifiedDays<-as.numeric(
  difftime(strptime(FederalModelAndDetail$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
    , strptime(FederalModelAndDetail$MinOfEffectiveDate,"%Y-%m-%d")
    , unit="days"
  ))+1

# 
# CDuration<-as.duration(strptime(FederalModelAndDetail$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
#                 strptime(FederalModelAndDetail$MinOfEffectiveDate,"%Y-%m-%d"))
# 
# CPeriod<-as.period(
#     CInterval<-new_interval(ymd(FederalModelAndDetail$UnmodifiedCurrentCompletionDate),
#                 ymd(FederalModelAndDetail$MinOfEffectiveDate))
# 
# 
# 
# summary(dYears)

#Break the count of days into four categories.
FederalModelAndDetail$qDuration<-cut2(FederalModelAndDetail$UnmodifiedDays,cuts=c(61,214,366,732))





if (levels(FederalModelAndDetail$qDuration)[[2]]=="[   61,  214)"){
  FederalModelAndDetail$qDuration<-factor(FederalModelAndDetail$qDuration, 
    
    levels=c("[    0,   61)",
      "[   61,  214)",
      "[  214,  366)",
      "[  366,  732)",
      "[  732,33192]"),
    labels=c("[0 months,~2 months)",
      "[~2 months,~7 months)",
      "[~7 months-~1 year]",
      "(~1 year,~2 years]",
      "(~2 years+]"),
    ordered=TRUE
  )
}


lowroundedcutoffs<-c(15000,100000,1000000,30000000)
highroundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
FederalModelAndDetail$qLowCeiling <- cut2(FederalModelAndDetail$UnmodifiedContractBaseAndAllOptionsValue,cuts=lowroundedcutoffs)
FederalModelAndDetail$qHighCeiling <- cut2(FederalModelAndDetail$UnmodifiedContractBaseAndAllOptionsValue,cuts=highroundedcutoffs)
rm(lowroundedcutoffs,highroundedcutoffs)




if (all(levels(FederalModelAndDetail$qHighCeiling)==c("[0.00e+00,1.50e+04)",
  "[1.50e+04,1.00e+05)",
  "[1.00e+05,1.00e+06)",
  "[1.00e+06,1.00e+07)",
  "[1.00e+07,7.50e+07)",
  "[7.50e+07,3.36e+12]"))){
  FederalModelAndDetail$qHighCeiling<-factor(FederalModelAndDetail$qHighCeiling, 
    
    levels=c("[0.00e+00,1.50e+04)",
      "[1.50e+04,1.00e+05)",
      "[1.00e+05,1.00e+06)",
      "[1.00e+06,1.00e+07)",
      "[1.00e+07,7.50e+07)",
      "[7.50e+07,3.36e+12]"),
    labels=c("[0,15k)",
      "[15k,100k)",
      "[100k,1m)",
      "[1m,10m)",
      "[10m,75m)",
      "[75m+]"),
    ordered=TRUE
  )
}

if (all(levels(FederalModelAndDetail$qLowCeiling)==c("[0.00e+00,1.50e+04)",
  "[1.50e+04,1.00e+05)",
  "[1.00e+05,1.00e+06)",
  "[1.00e+06,3.00e+07)",
  "[3.00e+07,3.36e+12]"))){
  FederalModelAndDetail$qLowCeiling<-factor(FederalModelAndDetail$qLowCeiling, 
    
    levels=c("[0.00e+00,1.50e+04)",
      "[1.50e+04,1.00e+05)",
      "[1.00e+05,1.00e+06)",
      "[1.00e+06,3.00e+07)",
      "[3.00e+07,3.36e+12]"),
    labels=c("[0,15k)",
      "[15k,100k)",
      "[100k,1m)",
      "[1m,30m)",
      "[30m+]"),
    ordered=TRUE
  )
}



FederalModelAndDetail$qNChg <- cut2(FederalModelAndDetail$SumOfisChangeOrder,c(1,2,3))


# FederalModelAndDetail$pChangeOrderObligated<-FederalModelAndDetail$ChangeOrderObligatedAmount/
#   FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pChangeOrderObligated[is.na(FederalModelAndDetail$pChangeOrderObligated)&
#     FederalModelAndDetail$SumOfisChangeOrder==0]<-0
FederalModelAndDetail$pChangeOrderUnmodifiedBaseAndAll<-FederalModelAndDetail$ChangeOrderBaseAndAllOptionsValue/
  FederalModelAndDetail$UnmodifiedContractBaseAndAllOptionsValue
FederalModelAndDetail$pChangeOrderUnmodifiedBaseAndAll[
  is.na(FederalModelAndDetail$pChangeOrderUnmodifiedBaseAndAll) & FederalModelAndDetail$SumOfisChangeOrder==0]<-0


FederalModelAndDetail$qCRais <- cut2(
  FederalModelAndDetail$pChangeOrderUnmodifiedBaseAndAll,c(
    -0.001,
    0.001,
    0.15)
)
#                                               min(subset(
#                                                   FederalModelAndDetail$pChangeOrderObligated,
#                                                   FederalModelAndDetail$pChangeOrderObligated>0)),

summary(subset(FederalModelAndDetail$qCRais,FederalModelAndDetail$SumOfisChangeOrder>0    ))


FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
  #     UnmodifiedDays,
  #     UnmodifiedCurrentCompletionDate
  #     MinOfEffectiveDate,
  "MinOfSignedDate",
  "LastUltimateCompletionDate"
    )]

save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)
```

##BucketPlatform
```{r BucketPlatform}
FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail
  ,"Civilian_Contract_SP_ContractBucketPlatformCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)
# 
# FederalModelAndDetail$ObligatedAmountIsProducts<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsProducts)
# 
# FederalModelAndDetail$ObligatedAmountIsServices<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsServices)
# 
# FederalModelAndDetail$ObligatedAmountIsRnD<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsRnD)
# 
# FederalModelAndDetail$pIsProducts <- FederalModelAndDetail$ObligatedAmountIsProducts/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsProducts[is.na(FederalModelAndDetail$ObligatedAmountIsProducts)] <- 0
# 
# FederalModelAndDetail$pIsServices <- FederalModelAndDetail$ObligatedAmountIsServices/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsServices[is.na(FederalModelAndDetail$ObligatedAmountIsServices)] <- 0
# 
# FederalModelAndDetail$pIsRnD <- FederalModelAndDetail$ObligatedAmountIsRnD/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsRnD[is.na(FederalModelAndDetail$ObligatedAmountIsRnD)] <- 0

#Need to update these to the new platform portfolios
# 
# 
# FederalModelAndDetail$ObligatedAmountIsLand<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsLand)
# 
# FederalModelAndDetail$ObligatedAmountIsVessel<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsVessel)
# 
# 
# FederalModelAndDetail$ObligatedAmountIsVessel<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsAir)
# 
# FederalModelAndDetail$ObligatedAmountIsVessel<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsOtherPP)
# 
# FederalModelAndDetail$ObligatedAmountIsWnA<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsWnA)
# 
# FederalModelAndDetail$ObligatedAmountIsMnS<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsMnS)
# 
# FederalModelAndDetail$ObligatedAmountIsEnC<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsEnC)
# 
# FederalModelAndDetail$ObligatedAmountIsFRSnC<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsFRSnC)
# 
# 
# FederalModelAndDetail$pIsLand <- FederalModelAndDetail$ObligatedAmountIsLand/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsLand[is.nan(FederalModelAndDetail$pIsLand)|is.infinite(FederalModelAndDetail$pIsLand)|is.na(FederalModelAndDetail$ObligatedAmountIsLand)] <- 0
# 
# FederalModelAndDetail$pIsVessel <- FederalModelAndDetail$ObligatedAmountIsVessel/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsVessel[is.nan(FederalModelAndDetail$pIsVessel)|is.infinite(FederalModelAndDetail$pIsVessel)|is.na(FederalModelAndDetail$ObligatedAmountIsVessel)] <- 0
# 
# FederalModelAndDetail$pIsOtherPP <- FederalModelAndDetail$ObligatedAmountIsOtherPP/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsOtherPP[is.nan(FederalModelAndDetail$pIsOtherPP)|is.infinite(FederalModelAndDetail$pIsOtherPP)|is.na(FederalModelAndDetail$ObligatedAmountIsOtherPP)] <- 0
# 
# FederalModelAndDetail$pIsAir <- FederalModelAndDetail$ObligatedAmountIsAir/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsAir[is.nan(FederalModelAndDetail$pIsAir)|is.infinite(FederalModelAndDetail$pIsAir)|is.na(FederalModelAndDetail$ObligatedAmountIsAir)] <- 0
# 
# FederalModelAndDetail$pIsEnC <- FederalModelAndDetail$ObligatedAmountIsEnC/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsEnC[is.nan(FederalModelAndDetail$pIsEnC)|is.infinite(FederalModelAndDetail$pIsEnC)|is.na(FederalModelAndDetail$ObligatedAmountIsEnC)] <- 0
# 
# FederalModelAndDetail$pIsFRSnC <- FederalModelAndDetail$ObligatedAmountIsFRSnC/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsFRSnC[is.nan(FederalModelAndDetail$pIsFRSnC)|is.infinite(FederalModelAndDetail$pIsFRSnC)|is.na(FederalModelAndDetail$ObligatedAmountIsFRSnC)] <- 0
# 
# 
# FederalModelAndDetail$pIsMnS <- FederalModelAndDetail$ObligatedAmountIsMnS/FederalModelAndDetail$Action.Obligation
# FederalModelAndDetail$pIsMnS[is.nan(FederalModelAndDetail$pIsMnS)|is.infinite(FederalModelAndDetail$pIsMnS)|is.na(FederalModelAndDetail$ObligatedAmountIsMnS)] <- 0


# TempList<-c("PlatformPortfolio","UnmodifiedPlatformPortfolio","ObligatedAmountIsAir","ObligatedAmountIsEnC","ObligatedAmountIsFRSnC","ObligatedAmountIsLand","ObligatedAmountIsMnS","ObligatedAmountIsOtherPP","ObligatedAmountIsVessel","ObligatedAmountIsWnA","ProductOrServiceArea","UnmodifiedProductOrServiceArea","SimpleArea","UnmodifiedSimpleArea","ObligatedAmountIsProducts","ObligatedAmountIsServices","ObligatedAmountIsRnD","MaxOfIsPossibleSoftwareEngineering")

# TempList<-TempList[TempList %in% names(FederalModelAndDetail)]
# FederalModelAndDetail<-subset(FederalModelAndDetail,select=-c(PlatformPortfolio,
#                                                       UnmodifiedPlatformPortfolio,
#                                                       SimpleArea,UnmodifiedSimpleArea ))

NASimpleArea<-(FederalModelAndDetail$SimpleArea=="Mixed or Unlabeled" | is.na(FederalModelAndDetail$SimpleArea))&
  !is.na(FederalModelAndDetail$UnmodifiedSimpleArea) & FederalModelAndDetail$UnmodifiedSimpleArea!="NULL"
FederalModelAndDetail$SimpleArea[NASimpleArea]<-FederalModelAndDetail$UnmodifiedSimpleArea[NASimpleArea]
# FederalModelAndDetail$SimpleArea[FederalModelAndDetail$SimpleArea=="Mixed or Unlabeled" & FederalModelAndDetail$pIsProducts>0.5]<-"Products"
# FederalModelAndDetail$SimpleArea[FederalModelAndDetail$SimpleArea=="Mixed or Unlabeled" & FederalModelAndDetail$pIsServices>0.5]<-"Services"
# FederalModelAndDetail$SimpleArea[FederalModelAndDetail$SimpleArea=="Mixed or Unlabeled" & FederalModelAndDetail$pIsRnD>0.5]<-"R&D"



# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsLand>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Land Vehicles"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsVessel>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Ships & Submarines"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsAir>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Aircraft and Drones"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsOtherPP>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Other"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsWnA>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Weapons and Ammunition"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsMnS>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Missile and Space Systems"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsEnC>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Electronics and Communications"
# FederalModelAndDetail$PlatformPortfolio.sum[FederalModelAndDetail$pIsFRSnC>=0.75&
#     FederalModelAndDetail$PlatformPortfolio.sum=="Unlabeled"]<-"Facilities and Construction"
# 
# FederalModelAndDetail$SoftwareEng<-factor(FederalModelAndDetail$MaxOfIsPossibleSoftwareEngineering,
#   levels=c(0,1),
#   labels=c("Not Software Eng.","Possible Software Eng.")
# )
# 
# FederalModelAndDetail$SoftwareEng[is.na(FederalModelAndDetail$SoftwareEng)&
#     !is.na(FederalModelAndDetail$SimpleArea)]<-"Not Software Eng."



FederalModelAndDetail$PlatformPortfolio<-factor(FederalModelAndDetail$PlatformPortfolio)
FederalModelAndDetail$UnmodifiedPlatformPortfolio<-factor(FederalModelAndDetail$UnmodifiedPlatformPortfolio)

FederalModelAndDetail$ProductOrServiceArea<-factor(FederalModelAndDetail$ProductOrServiceArea)
FederalModelAndDetail$UnmodifiedProductOrServiceArea<-factor(FederalModelAndDetail$UnmodifiedProductOrServiceArea)

FederalModelAndDetail$SimpleArea<-factor(FederalModelAndDetail$SimpleArea)
FederalModelAndDetail$UnmodifiedSimpleArea<-factor(FederalModelAndDetail$UnmodifiedSimpleArea)


FederalModelAndDetail<-subset(FederalModelAndDetail,select=-c(
  # UnmodifiedSimpleArea,
  # SimpleArea,
  MaxOfIsPossibleSoftwareEngineering
  # ObligatedAmountIsProducts,
  # ObligatedAmountIsServices,
  # ObligatedAmountIsRnD,
  # ObligatedAmountIsLand,
  # ObligatedAmountIsVessel,
  # ObligatedAmountIsOtherPP,
  # ObligatedAmountIsAir,
  # ObligatedAmountIsEnC,
  # ObligatedAmountIsFRSnC,
  # ObligatedAmountIsMnS,
  # ObligatedAmountIsWnA
  
  
))


FederalModelAndDetail$AnyPlaceInternational<-droplevels(FederalModelAndDetail$AnyPlaceInternational)


FederalModelAndDetail$SimpleArea<-droplevels(FederalModelAndDetail$SimpleArea)


save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)

```

##Competition Vehicle
```{r CompetitionVehicle}
#data\\Civilian_contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.csv
debug(read_and_join_experiment)
FederalModelAndDetail<-read_and_join_experiment(data=FederalModelAndDetail
  ,"Civilian_contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

#Civilian_contract_SP_ContractCompetitionVehicleCustomer.csv
FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail
  ,"Civilian_contract_SP_ContractCompetitionVehicleCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

FederalModelAndDetail$UnmodifiedNumberOfOffersReceived<-FactorToNumber(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived)

FederalModelAndDetail$NumberOfOffersReceived<-FactorToNumber(FederalModelAndDetail$NumberOfOffersReceived)
FederalModelAndDetail$UnmodifiedNumberOfOffersReceived[is.null(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived)]<-NA
FederalModelAndDetail$NumberOfOffersReceived[is.null(FederalModelAndDetail$NumberOfOffersReceived)]<-NA

NAnumberOfOffers<-is.na(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived)&
  !is.na(FederalModelAndDetail$NumberOfOffersReceived)
FederalModelAndDetail$UnmodifiedNumberOfOffersReceived[NAnumberOfOffers]<-
  FederalModelAndDetail$NumberOfOffersReceived[NAnumberOfOffers]
rm(NAnumberOfOffers)

FederalModelAndDetail$qOffers <- cut2(FederalModelAndDetail$NumberOfOffersReceived,cuts=c(1,2,3,5))

if(is.numeric(FederalModelAndDetail$IsIDV)){
  FederalModelAndDetail$IsIDV<-factor(FederalModelAndDetail$IsIDV,levels=c(0,1),labels=c("Def/Pur","IDV"))
}



FederalModelAndDetail$UnmodifiedNumberOfOffersReceived[is.na(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived)&
    !is.na(FederalModelAndDetail$UnmodifiedIsSomeCompetition)&
    FederalModelAndDetail$UnmodifiedIsSomeCompetition=="No Comp."
  ]<-1





FederalModelAndDetail$SingleOffer<-factor(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived==1,
  levels=c(TRUE,FALSE),
  labels=c("Single","Multi")
)

FederalModelAndDetail$SingleOffer[is.na(FederalModelAndDetail$UnmodifiedNumberOfOffersReceived)]<-NA

FederalModelAndDetail$SimpleVehicle<-NA
FederalModelAndDetail$SimpleVehicle[FederalModelAndDetail$AwardOrIDVcontractActionType %in% c("Definitive Contract",
  "Purchase Order")]<-"Def/Pur"
FederalModelAndDetail$SimpleVehicle[FederalModelAndDetail$AwardOrIDVcontractActionType 
  %in% c("Basic Ordering Agreement",
    "Blanket Purchase Agreement",
    "Federal Supply Schedule",
    "Government Wide Acquisition Contract")]<-"Other IDV"
FederalModelAndDetail$SimpleVehicle[FederalModelAndDetail$AwardOrIDVcontractActionType == "Letter Contract"]<-"Letter"
FederalModelAndDetail$SimpleVehicle[FederalModelAndDetail$AwardOrIDVcontractActionType %in%
    c("Indefinite Delivery Contract",
      "Delivery Order")]<-
  as.character(FederalModelAndDetail$multipleorsingleawardidc[FederalModelAndDetail$AwardOrIDVcontractActionType %in%
      c("Indefinite Delivery Contract",
        "Delivery Order")])

FederalModelAndDetail$SimpleVehicle<-factor(FederalModelAndDetail$SimpleVehicle)
summary(FederalModelAndDetail$SimpleVehicle)
str(FederalModelAndDetail$SimpleVehicle)

summary(FederalModelAndDetail[is.na(FederalModelAndDetail$SimpleVehicle),"AwardOrIDVcontractActionType"])


FederalModelAndDetail$UCA<-factor(FederalModelAndDetail$MaxOfIsUndefinitizedAction,
  levels=c(0,1),
  labels=c("Not UCA","UCA")
)

#IsSomeCompetition Impute missing values when labeled entries have a consistent value.
NAisSomeCompetition<-(is.na(FederalModelAndDetail$UnmodifiedIsSomeCompetition)|
    FederalModelAndDetail$UnmodifiedIsSomeCompetition=="Unlabeled")&
  (FederalModelAndDetail$IsSomeCompetition!="Mixed or \nUnlabeled"&
      !is.na(FederalModelAndDetail$IsSomeCompetition))
FederalModelAndDetail$UnmodifiedIsSomeCompetition[NAisSomeCompetition]<-
  FederalModelAndDetail$IsSomeCompetition[NAisSomeCompetition]
rm(NAisSomeCompetition)
#Calculate Comp
FederalModelAndDetail$Comp[FederalModelAndDetail$UnmodifiedIsSomeCompetition=="No Comp."]<-"No Comp."
FederalModelAndDetail$Comp[FederalModelAndDetail$UnmodifiedIsSomeCompetition=="Comp." &
                           FederalModelAndDetail$UnmodifiedIsFullAndOpen=="Not Full & Open"]<-"Comp."
FederalModelAndDetail$Comp[FederalModelAndDetail$UnmodifiedIsSomeCompetition=="Comp." &
                           FederalModelAndDetail$UnmodifiedIsFullAndOpen=="Comp."]<-"Comp."
FederalModelAndDetail$Comp[FederalModelAndDetail$UnmodifiedIsSomeCompetition=="Comp."]<-"Comp."


FederalModelAndDetail$Comp<-factor(FederalModelAndDetail$Comp,
                               levels=c("No Comp.","Comp.")
                               )



if (all(levels(FederalModelAndDetail$qOffers)==c("  1","  2","[  3,  5)","[  5,999]"))){
  FederalModelAndDetail$qOffers<-factor(FederalModelAndDetail$qOffers, 
    levels=c("  1","  2","[  3,  5)","[  5,999]"),
    labels=c("1","2","3-4","5+"),
    ordered=TRUE
  )
}


FederalModelAndDetail$qOffers[is.na(FederalModelAndDetail$qOffers)&
    !is.na(FederalModelAndDetail$UnmodifiedIsSomeCompetition)&
    FederalModelAndDetail$UnmodifiedIsSomeCompetition=="No Comp."
  ]<-"1"



FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
  #     UnmodifiedIsFullAndOpen,
  "UnmodifiedIsOnlyOneSource",
  "UnmodifiedIsFollowonToCompetedAction",
  #     Unmodifiedmultipleorsingleawardidc,
  #     Unmodifiedaddmultipleorsingawardidc,
  "IsFullAndOpen",
  "IsFollowonToCompetedAction"
  #     multipleorsingleawardidc,
  #     AddMultipleOrSingleAwardIDC
)]

  
save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)

```


##Pricing
```{r Pricing}

   c(
  "Pricing.Mechanism.Code",
  "UnmodifiedTypeOfContractPricing",
  "IsLabeledPricing",
  "ObligatedAmountIsFixedPrice",
  "IsFixedPrice",
  "UnmodifiedIsFixedPrice",
  "ObligatedAmountIsCostBased",
  "IsCostBased",
  "UnmodifiedIsCostBased",
  "ObligatedAmountIsCombination",
  "IsCombination",
  "UnmodifiedIsCombination",
  "ObligatedAmountIsIncentive",
  "IsIncentive",
  "UnmodifiedIsIncentive",
  "ObligatedAmountIsAwardFee",
  "IsAwardFee",
  "UnmodifiedIsAwardFee",
  "ObligatedAmountIsFFPorNoFee",
  "IsFFPorNoFee",
  "UnmodifiedIsFFPorNoFee",
  "ObligatedAmountIsFixedFee",
  "IsFixedFee",
  "UnmodifiedIsFixedFee",
  "ObligatedAmountIsOtherFee",
  "IsOtherFee",
  "UnmodifiedIsOtherFee",
  "pIsFixedPrice",
  "pIsCostBased",
  "pIsCombination",
  "pIsIncentive",
  "pIsAwardFee",
  "pIsFFPorNoFee",
  "pIsFixedFee",
  "pIsOtherFee",
  "FixedOrCost",
  "Fee"
    )]

FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail
  ,"Contract.SP_ContractPricingCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

#IsLabeledPricing Can drop this the next time we download, as there's an Isnull(,0 there now)
FederalModelAndDetail$IsLabeledPricing[is.nan(FederalModelAndDetail$IsLabeledPricing)|is.na(FederalModelAndDetail$IsLabeledPricing)] <- 0

#Process FixedOrCost
FederalModelAndDetail$ObligatedAmountIsFixedPrice<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsFixedPrice)
FederalModelAndDetail$pIsFixedPrice <- FederalModelAndDetail$ObligatedAmountIsFixedPrice/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsFixedPrice[is.nan(FederalModelAndDetail$ObligatedAmountIsFixedPrice)|is.na(FederalModelAndDetail$ObligatedAmountIsFixedPrice)] <- 0


FederalModelAndDetail$ObligatedAmountIsCostBased<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsCostBased)
FederalModelAndDetail$pIsCostBased <- FederalModelAndDetail$ObligatedAmountIsCostBased/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsCostBased[is.nan(FederalModelAndDetail$ObligatedAmountIsCostBased)|is.na(FederalModelAndDetail$ObligatedAmountIsCostBased)] <- 0

FederalModelAndDetail$ObligatedAmountIsCombination<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsCombination)
FederalModelAndDetail$pIsCombination <- FederalModelAndDetail$ObligatedAmountIsCombination/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsCombination[is.nan(FederalModelAndDetail$ObligatedAmountIsCombination)|is.na(FederalModelAndDetail$ObligatedAmountIsCombination)] <- 0

#Assign FixedOrCost
FederalModelAndDetail$FixedOrCost[FederalModelAndDetail$pIsFixedPrice>0  |
    FederalModelAndDetail$pIsCostBased>0 | 
    FederalModelAndDetail$pIsCombination>0]<-"Combination or Other"

FederalModelAndDetail$FixedOrCost[FederalModelAndDetail$pIsFixedPrice>=0.95|(FederalModelAndDetail$IsFixedPrice==1 & (FederalModelAndDetail$pIsCombination<=0.05))]<-"Fixed-Price"
FederalModelAndDetail$FixedOrCost[FederalModelAndDetail$pIsCostBased>=0.95|(FederalModelAndDetail$IsCostBased==1 & (FederalModelAndDetail$pIsCombination<=0.05))]<-"Cost-Based"
FederalModelAndDetail$FixedOrCost<-factor(FederalModelAndDetail$FixedOrCost,levels=c("Fixed-Price","Cost-Based","Combination or Other"))

#Process Fee
FederalModelAndDetail$ObligatedAmountIsIncentive<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsIncentive)
FederalModelAndDetail$pIsIncentive <- FederalModelAndDetail$ObligatedAmountIsIncentive/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsIncentive[is.nan(FederalModelAndDetail$ObligatedAmountIsIncentive)|is.na(FederalModelAndDetail$ObligatedAmountIsIncentive)] <- 0

FederalModelAndDetail$ObligatedAmountIsAwardFee<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsAwardFee)
FederalModelAndDetail$pIsAwardFee <- FederalModelAndDetail$ObligatedAmountIsAwardFee/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsAwardFee[is.nan(FederalModelAndDetail$ObligatedAmountIsAwardFee)|is.na(FederalModelAndDetail$ObligatedAmountIsAwardFee)] <- 0

FederalModelAndDetail$ObligatedAmountIsFFPorNoFee<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsFFPorNoFee)
FederalModelAndDetail$pIsFFPorNoFee <- FederalModelAndDetail$ObligatedAmountIsFFPorNoFee/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsFFPorNoFee[is.nan(FederalModelAndDetail$ObligatedAmountIsFFPorNoFee)|is.na(FederalModelAndDetail$ObligatedAmountIsFFPorNoFee)] <- 0


FederalModelAndDetail$ObligatedAmountIsFixedFee<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsFixedFee)
FederalModelAndDetail$pIsFixedFee <- FederalModelAndDetail$ObligatedAmountIsFixedFee/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsFixedFee[is.nan(FederalModelAndDetail$ObligatedAmountIsFixedFee)|is.na(FederalModelAndDetail$ObligatedAmountIsFixedFee)] <- 0

FederalModelAndDetail$ObligatedAmountIsOtherFee<-FactorToNumber(FederalModelAndDetail$ObligatedAmountIsOtherFee)
FederalModelAndDetail$pIsOtherFee <- FederalModelAndDetail$ObligatedAmountIsOtherFee/FederalModelAndDetail$Action.Obligation
FederalModelAndDetail$pIsOtherFee[is.nan(FederalModelAndDetail$ObligatedAmountIsOtherFee)|is.na(FederalModelAndDetail$ObligatedAmountIsOtherFee)] <- 0


#AssignFee
FederalModelAndDetail$Fee<-NA
FederalModelAndDetail$Fee[FederalModelAndDetail$pIsAwardFee>=0.9|(FederalModelAndDetail$IsAwardFee==1
  & FederalModelAndDetail$pIsCombination<=0.05)]<-"Award Fee"
FederalModelAndDetail$Fee[FederalModelAndDetail$pIsIncentive>=0.9|(FederalModelAndDetail$IsIncentive==1
  & FederalModelAndDetail$pIsCombination<=0.05)]<-"Incentive"
FederalModelAndDetail$Fee[FederalModelAndDetail$pIsFFPorNoFee>=0.9|(FederalModelAndDetail$IsFFPorNoFee==1
  & FederalModelAndDetail$pIsCombination<=0.05)]<-"FFP or No Fee"
FederalModelAndDetail$Fee[FederalModelAndDetail$pIsFixedFee>=0.9|(FederalModelAndDetail$IsFixedFee==1
  & FederalModelAndDetail$pIsCombination<=0.05)]<-"Fixed Fee"

FederalModelAndDetail$Fee[FederalModelAndDetail$pIsOtherFee>=0.9|
    FederalModelAndDetail$IsOtherFee==1 | 
    FederalModelAndDetail$pIsCombination>0.1|
    (is.na(FederalModelAndDetail$Fee) & FederalModelAndDetail$IsLabeledPricing==1)]<-
  "Combination or Other Fee"
FederalModelAndDetail$Fee<-ordered(FederalModelAndDetail$Fee,
  levels=c("Incentive","Fixed Fee","Award Fee",
    "FFP or No Fee","Combination or Other Fee"))

FederalModelAndDetail<-subset(FederalModelAndDetail,select=-c(
 
)
)

FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
  # Pricing.Mechanism.Code,
  "UnmodifiedTypeOfContractPricing",
  "IsLabeledPricing",
  "ObligatedAmountIsFixedPrice",
  # IsFixedPrice,
  "UnmodifiedIsFixedPrice",
  "ObligatedAmountIsCostBased",
  # IsCostBased,
  "UnmodifiedIsCostBased",
  "ObligatedAmountIsCombination",
  # IsCombination,
  "UnmodifiedIsCombination",
  "ObligatedAmountIsIncentive",
  # IsIncentive,
  "UnmodifiedIsIncentive",
  "ObligatedAmountIsAwardFee",
  # IsAwardFee,
  "UnmodifiedIsAwardFee",
  "ObligatedAmountIsFFPorNoFee",
  # IsFFPorNoFee,
  "UnmodifiedIsFFPorNoFee",
  "ObligatedAmountIsFixedFee",
  # IsFixedFee,
  "UnmodifiedIsFixedFee",
  "ObligatedAmountIsOtherFee",
  # IsOtherFee,
  "UnmodifiedIsOtherFee"
  # pIsFixedPrice,
  # pIsCostBased,
  # pIsCombination,
  # pIsIncentive,
  # pIsAwardFee,
  # pIsFFPorNoFee,
  # pIsFixedFee,
  # pIsOtherFee,
  # FixedOrCost,
  # Fee
    )]
# load(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata")



save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)

```

## Details
```{r Details}
# load(file="Data\\Federal_contract_CSIScontractID_detail.Rdata")
FederalModelAndDetail<-plyr::join(FederalModelAndDetail,test)
test<-read_delim("Data\\Contract.SP_ContractTopPSCofficeNAICS.txt",delim="\t",
                 na=c("NA","NULL"),
                 col_types="icdcdcdcd")
                   # c(col_integer(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double()))
FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail
  ,"Contract.SP_ContractTopPSCofficeNAICS.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

FederalModelAndDetail$topContractingOfficeAgencyID<-factor(
  FederalModelAndDetail$topContractingOfficeAgencyID
)
FederalModelAndDetail$topContractingOfficeID<-factor(
  FederalModelAndDetail$topContractingOfficeID
)
FederalModelAndDetail$topProductOrServiceCode<-factor(
  FederalModelAndDetail$topProductOrServiceCode
)
FederalModelAndDetail$topPrincipalNAICScode<-factor(
  FederalModelAndDetail$topPrincipalNAICScode
)


FederalModelAndDetail<-FederalModelAndDetail[,!colnames(FederalModelAndDetail) %in% 
    c(
      # "topContractingOfficeAgencyID",
      "topContractingOfficeAgencyIDamount"      ,
      # "topContractingOfficeID",
      "topContractingOfficeAmount"  ,
      # "topProductOrServiceCode",
      "topProductOrServiceAmount"               ,
      # "topPrincipalNAICScode",
      "topPrincipalNAICSamount")]
# load(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata")


```

#Final Cleanup and Output
##Applying lookups
```{r PostApply}
# debug(apply_lookups)


FederalModelAndDetail<-apply_lookups(Path,FederalModelAndDetail)




# FederalModelAndDetail<-csis360::read_and_join(
#   FederalModelAndDetail,
#   "Lookup_SubCustomer.csv",
#   by=c("Customer","SubCustomer"),
#   # replace_na_var=NULL,
#   # overlap_var_replaced=TRUE,
#   add_var="SubCustomer.sum"
#   # new_var_checked=TRUE,
#   # skip_check_var="CHPKisCrisisFunding"
#   )

# FederalModelAndDetail$SubCustomer.sum<-factor(FederalModelAndDetail$SubCustomer.sum)
# FederalModelAndDetail$SubCustomer.sum<-droplevels(FederalModelAndDetail$SubCustomer.sum)
# FederalModelAndDetail$SubCustomer.sum<-droplevels(FederalModelAndDetail$SubCustomer.sum)


FederalModelAndDetail<-csis360::read_and_join(
  FederalModelAndDetail,
  "LOOKUP_PlatformPortfolio.csv",
  by="PlatformPortfolio",
  # replace_na_var=NULL,
  # overlap_var_replaced=TRUE,
  add_var="PlatformPortfolio.sum"
  # new_var_checked=TRUE,
  # skip_check_var="CHPKisCrisisFunding"
  )
FederalModelAndDetail$PlatformPortfolio.sum<-factor(FederalModelAndDetail$PlatformPortfolio.sum)

    FederalModelAndDetail$IsTerminated<-factor(FederalModelAndDetail$IsTerminated,
                                levels = c(0,1),
                                labels = c("Unterminated", "Terminated")
    )

FederalModelAndDetail<-rename_dataset(FederalModelAndDetail)

save(file="Data\\Civilian_contract_CSIScontractID_complete.Rdata",FederalModelAndDetail)
# FederalModelAndDetail<-rename_dataset(FederalModelAndDetail)

```
##Dataset Output

```{r DetailedOutput}

CivilianModelAndDetail<-subset(FederalModelAndDetail,select=c(CSIScontractID,
  # IsIDV,
  FxCb,
  Fee,
  # Comp,
  # MDAP,
  # unmodifiedSystemequipmentcode,
  # Who,
  What,
  Intl,
  PSR,
  LowCeil,
  Ceil,
  Dur,
  SingleOffer,
  Offr,
  # IsIDV,
  # Soft,
  UCA,
  CRai,
  NChg,
  Veh,
  UnmodifiedNumberOfOffersReceived,
  Term,
  UnmodifiedContractBaseAndAllOptionsValue,
  SumOfisChangeOrder,
  pChangeOrderUnmodifiedBaseAndAll,
  # pChangeOrderObligated,
  UnmodifiedDays,
  MinOfEffectiveDate,
  Action.Obligation,
  Agency,
  Office,
  ProdServ,
  NAICS
)
)
# 

    # CivilianModelAndDetail$Term<-factor(CivilianModelAndDetail$Term,
    #                             levels = c(0,1),
    #                             labels = c("Unterminated", "Terminated")
    # )


write.table(CivilianModelAndDetail
  ,file=paste("data\\Civilian_contract_CSIScontractID_detail.csv"
    ,sep=""
  )
  #   ,header=TRUE
  , sep=","
  , row.names=FALSE
  , append=FALSE
)
save(CivilianModelAndDetail,file="Data\\Civilian_contract_CSIScontractID_detail.Rdata")


#Strip out the cuts



```

##Merging up Civilian and Defense
```{r CombineDefenseAndCivil}

load(file="Data\\Defense_contract_CSIScontractID_detail.Rdata")


DefenseModelAndDetail$Who<-factor(DefenseModelAndDetail$Who,
  levels=c("Civilian",levels(DefenseModelAndDetail$Who)))
CivilianModelAndDetail$Who<-factor("Civilian",levels(DefenseModelAndDetail$Who))
FederalModelAndDetail<-rbind(DefenseModelAndDetail,CivilianModelAndDetail)
summary(CivilianModelAndDetail$Term)
summary(DefenseModelAndDetail$Term)
summary(CivilianModelAndDetail$Veh)
summary(DefenseModelAndDetail$Veh)


summary(DefenseModelAndDetail)
summary(CivilianModelAndDetail)
 
CivilianModelAndDetail$Term<-factor(CivilianModelAndDetail$Term,
                                levels = c(0,1),
                                labels = c("Unterminated", "Terminated")
    )




DefenseModelAndDetail<-DefenseModelAndDetail[,!colnames(DefenseModelAndDetail) %in% 
    c(
"LowCeil",
      "Ceil",
      "CRai",
      "NChg",
      "Dur"
      
)]
CivilianModelAndDetail<-CivilianModelAndDetail[,!colnames(CivilianModelAndDetail) %in% 
    c(
"LowCeil",
      "Ceil",
      "CRai",
      "NChg",
      "Dur"
      
)]

DefenseModelAndDetail$Is.Defense<-"Defense"
CivilianModelAndDetail$Is.Defense<-"Civilian"

FederalModelAndDetail<-rbind(DefenseModelAndDetail,CivilianModelAndDetail)

debug(FormatContractModel)
FederalModelAndDetail<-FormatContractModel(FederalModelAndDetail)

FederalModelAndDetail<-csis360::read_and_join_experiment(data=FederalModelAndDetail,
    lookup_file="Overall_Contract_SP_ContractBudgetDecisionTree.txt",
  path="",
  directory = "Data/",
  by="CSIScontractID",
  new_var_checked=FALSE
)
FederalModelAndDetail$MaxOfDecisionTree<-factor(FederalModelAndDetail$MaxOfDecisionTree)
FederalModelAndDetail$MaxOfDecisionTreeStep4 <-factor(FederalModelAndDetail$MaxOfDecisionTreeStep4 )
FederalModelAndDetail$MinOfDecisionTree <-factor(FederalModelAndDetail$MinOfDecisionTree )
FederalModelAndDetail$MinOfDecisionTreeStep4 <-factor(FederalModelAndDetail$MinOfDecisionTreeStep4 )


summary(FederalModelAndDetail)
save(FederalModelAndDetail,file="Data\\Federal_contract_CSIScontractID_detail.Rdata")




```