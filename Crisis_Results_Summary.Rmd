---
title: "Crisis Funding Results"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination or Ceiling Breach
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(arm)
library(R2WinBUGS)
library(dplyr)
library(Hmisc)
library(texreg)
library(reshape2)
library(reshape2)
library(lubridate)
library(showtext)
library(extrafont)
library(tidyverse)
# font_import()

source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/DIIGstat.r")
source("ContractCleanup.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/lookups.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/helper.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-2

main.text.size<-1
note.text.size<-1.40


```


# Transaction Data

##Import Data

### Loading Files
```{r Import}
# read in data    

load(file="Data//full_data_after_step_6.Rdata")
full_data$CrisisDisplay<-as.character(full_data$CrisisFunding)
full_data$CrisisDisplay[full_data$CrisisDisplay  %in% c("Unlabeled","Excluded")]<-"All Other"
full_data$CrisisDisplay<-factor(full_data$CrisisDisplay)

full_data$SAMcrisisFunding[full_data$SAMcrisisFunding==""]<-NA
full_data$isUndefinitizedAction<-factor(full_data$isUndefinitizedAction)

# full_data<-full_data %>% select(-SubCustomer,-SubCustomer.detail)
#There's 53 some subcustomers to add at some point.
# full_data$NoCompOffr<-factor(full_data$NoCompOffr)
# full_data$Competition.multisum<-factor(full_data$Competition.multisum)
# full_data$SupplyServiceERS<-factor(full_data$SupplyServiceERS)

```

### Grouping for Display



```{r Summary}

# CrisisProductOrServiceArea
# SupplyServiceConstruction
# Pricing
# Vehicle
# Dur.Simple (but no raw)
# Ceiling
#ContractingOfficeCode
full_data$OfficeOCOcrisisPercentRound1


summary_data<-full_data%>%
  dplyr::group_by(Fiscal.Year,
    Is.Defense,
    CrisisDisplay,
    International,
    NoCompOffr,
    Theater,
    isUndefinitizedAction,
    Customer,
    # SupplyServiceERS,     #Should switch this to CrisisProdServ
    ProductOrServiceArea, 
    # Reachback,            #Swap in OffPlace
    Dur.Simple,
    UnmodifiedUltimateDurationCategory,
    dFYear,
    PlaceCountryText)%>%
  dplyr::summarise( Obligation.2017=sum(Obligation.2017))

summary_data$isUCA<-factor(summary_data$isUndefinitizedAction,levels=c(1,0,NA),labels=c("UCA","Not UCA"))
summary_data$isUCA<-addNA(summary_data$isUCA,ifany=TRUE)
levels(summary_data$isUCA)[is.na(levels(summary_data$isUCA))] <- "Unlabeled"
summary(summary_data$isUCA)


summary_data$DecisionTreeDisplay<-as.character( summary_data$CrisisDisplay)

summary_data$DecisionTreeDisplay[summary_data$CrisisDisplay=="All Other" &
                                   summary_data$International=="Domestic" &
                                   summary_data$Is.Defense==FALSE & 
                                   summary_data$Fiscal.Year>=2007
                                 ]<-"Other U.S. Civilian"

summary_data$DecisionTreeDisplay[summary_data$CrisisDisplay=="All Other" &
                                   summary_data$International=="Domestic" &
                                   summary_data$Is.Defense==TRUE & 
                                   summary_data$Fiscal.Year>=2007
                                 ]<-"Other U.S. Defense"

summary_data$DecisionTreeDisplay[summary_data$CrisisDisplay=="All Other" &
                                   summary_data$International=="International" &
                                   summary_data$Is.Defense==FALSE & 
                                   summary_data$Fiscal.Year>=2007
                                 ]<-"Other Intl. Civilian"

summary_data$DecisionTreeDisplay[summary_data$CrisisDisplay=="All Other" &
                                   summary_data$International=="International" &
                                   summary_data$Is.Defense==TRUE & 
                                   summary_data$Fiscal.Year>=2007
                                 ]<-"Other Intl. Defense"

summary_data$DecisionTreeDisplay[summary_data$Fiscal.Year<2007]<-  "Not in Sample"

summary_data$DecisionTreeDisplay[(is.na(summary_data$International)) |
                                   is.na(summary_data$Is.Defense) &
                                   summary_data$CrisisDisplay=="All Other" 
                                 ]<-"Not in Sample"

summary_data$DecisionTreeDisplay<-ordered(summary_data$DecisionTreeDisplay,
                                          levels=c("Disaster",
                                                   "ARRA",
                                                   "OCO",
                                                   "Other U.S. Civilian",
                                                   "Other Intl. Civilian",
                                                   "Other U.S. Defense",
                                                   "Other Intl. Defense",
                                                   "Not in Sample"
                                          ))

summary(summary_data$DecisionTreeDisplay)

summary_data<-summary_data %>% group_by(DecisionTreeDisplay) %>%
                    dplyr::mutate(
                    pDatasetObligation=Obligation.2017/sum(Obligation.2017,na.rm=TRUE))

summary_data<-summary_data %>% group_by(DecisionTreeDisplay,Fiscal.Year) %>%
                    dplyr::mutate(
                    pAnnualDatasetObligation=Obligation.2017/sum(Obligation.2017,na.rm=TRUE))


```


#### Labels/Colors and Output to Shiny
```{r Output }


summary_data<-replace_nas_with_unlabeled(summary_data,"UnmodifiedUltimateDurationCategory")
summary_data<-replace_nas_with_unlabeled(summary_data,"isUndefinitizedAction")
summary_data<-replace_nas_with_unlabeled(summary_data,"Theater")
summary_data<-replace_nas_with_unlabeled(summary_data,"International")
# summary_data<-replace_nas_with_unlabeled(summary_data,"Reachback")

labels_and_colors<-prepare_labels_and_colors(summary_data,na_replaced=TRUE)
column_key<-csis360::get_column_key(summary_data)

complete_summary_data<-summary_data 
summary_data<-subset(summary_data,DecisionTreeDisplay != "Not in Sample")

save(labels_and_colors,column_key,complete_summary_data,file="Shiny/Crisis_Funding.RData")
```


## Transaction Data Display

### Crisis History
```{r Toplevel}

(
chapter4topline<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Customer",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $ Billions)",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(complete_summary_data,!is.na(International) & International!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="dFYear", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="Is.Defense", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="International", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
  DataLabels=FALSE
)+  facet_grid(primary ~ secondary
              , scales="free_y" 
              , space="fixed")+theme(legend.position = 'bottom')+get_caption()+
  scale_x_date("Fiscal Year",labels = date_format("'%y"), date_breaks="3 years")+
  geom_vline(xintercept=as.numeric(as.Date("2006-07-01")))
)

ggsave600dpi("Output//chapter4topline.png", chapter4topline, width=6.5, height= 4, units="in")

ggsave("Output//chapter4topline.eps", chapter4topline, width=6.5, height= 4, units="in")

```


### Country
```{r Country}

Country<-ddply(summary_data,
                .(Fiscal.Year,
                  DecisionTreeDisplay,
                  PlaceCountryText,
                  Theater
                  ),
                plyr::summarise,
                Obligation.2017=sum(Obligation.2017)
                )

write.csv(Country,file.path("Output","Country.csv"))

# LatticePlotWrapper_csis360(
#   VAR.color.legend.label="OCO labeling detail",
#   VAR.main.label="All Defense Contracts",
#   VAR.X.label="Fiscal Year",
#   VAR.Y.label="Obligation (2017 $ Billions)",
#   VAR.Coloration=labels_and_colors,
#   VAR.long.DF=summary_data  ,
#   # NA, #VAR.ncol
#   VAR.x.variable="Fiscal.Year", #VAR.x.variable
#   VAR.y.variable="Obligation.2017", #VAR.y.variable
#   VAR.y.series="OCOlabelDetail", #VAR.y.series
#   VAR.facet.primary="DecisionTreeDisplay" #VAR.facet.primary
#   # VAR.facet.secondary= NULL # VAR.facet.secondary=NA
#   # ,MovingAverage=0
#   # ,MovingSides=1
#   ,DataLabels=FALSE
#   #                       ,VAR.override.coloration=NA
# )+theme(legend.position="bottom")

# OCOdetailZoom<-LatticePlotWrapper_csis360(
#   VAR.color.legend.label="OCO labeling detail",
#   VAR.main.label="Confident OCO or International Defense Contracts",
#   VAR.X.label="Fiscal Year",
#   VAR.Y.label="Obligation (2017 $ Billions)",
#   VAR.Coloration=labels_and_colors,
#   VAR.long.DF=subset(summary_data,
#                      (DecisionTreeDisplay=="Confident OCO" | 
#                        International=="International") & 
#                        !is.na(International)),
#   # NA, #VAR.ncol
#   VAR.x.variable="Fiscal.Year", #VAR.x.variable
#   VAR.y.variable="Obligation.2017", #VAR.y.variable
#   VAR.y.series="OCOlabelDetail", #VAR.y.series
#   VAR.facet.primary="International", #VAR.facet.primary
#   VAR.facet.secondary="DecisionTreeDisplay" # VAR.facet.secondary=NA
#   # ,MovingAverage=0
#   # ,MovingSides=1
#   # ,DataLabels=NA
#   #                       ,VAR.override.coloration=NA
# )

# OCOdetailZoom+theme(legend.position="bottom")

```


### Study Variables
#### Competition

```{r Competition}

geom.text.size<-2.5
(
CompOverall<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(summary_data,
                     DecisionTreeDisplay!="Not in Sample"),
  # NA, #VAR.ncol
  VAR.x.variable="DecisionTreeDisplay", #VAR.x.variable
  VAR.y.variable="pDatasetObligation", #VAR.y.variable
  VAR.y.series="DecisionTreeDisplay", #VAR.y.series
  VAR.facet.primary="NoCompOffr" #VAR.facet.primary
  # VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=TRUE
  #                       ,VAR.override.coloration=NA
)+
  # theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    scale_y_continuous( labels = percent_format())+
  facet_grid(primary ~ .#,scales="free_y", space="free_y"
             )
    )


ggsave600dpi("Output//CompOverall.png", CompOverall, 
             width=4, height= 6, units="in"
             )


ggsave("Output//CompOverall.eps", CompOverall, 
             width=4, height= 6, units="in"
             )

(
CompAnnual<-build_plot(
  data=summary_data %>% filter(DecisionTreeDisplay %in% c("Disaster","ARRA","OCO")),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Obligation.2017", #VAR.y.variable
  color_var="NoCompOffr", #color_var
  facet_var="DecisionTreeDisplay", #facet_var
  column_key=column_key,
  format=TRUE
)+labs(line="Competition",
  title=NULL,
  xlab="Fiscal Year",
  ylab="Percent of Obligations (Variable Scale")+
  # +theme(legend.position = "bottom")+
  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270),
        legend.position = "bottom")+
    guides(fill=guide_legend(ncol=2))+
    facet_grid(DecisionTreeDisplay~ ., scales = "free_y")
)

ggsave600dpi("Output//CompAnnual.png", CompAnnual, 
             width=2.5, height= 4, units="in"
             )


ggsave("Output//CompAnnual.eps", CompAnnual, 
             width=2.5, height= 4, units="in"
             )


```


#### Undefinitized Contract Actions
```{r UCA}
 # summary_data$isUCA<-"Not UCA" 

geom.text.size<-3
(
UCAoverall<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(summary_data,
                     DecisionTreeDisplay!="Not in Sample"),
  # NA, #VAR.ncol
  VAR.x.variable="DecisionTreeDisplay", #VAR.x.variable
  VAR.y.variable="pDatasetObligation", #VAR.y.variable
  VAR.y.series="DecisionTreeDisplay", #VAR.y.series
  VAR.facet.primary="isUCA" #VAR.facet.primary
  # VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=TRUE
  #                       ,VAR.override.coloration=NA
)+
# +theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    scale_y_continuous( labels = percent_format())+
  facet_grid(primary ~ .)
    # )
)
  
ggsave600dpi("Output//UCAoverall.png", UCAoverall, width=4, height= 5, units="in")


(
UCAannual<-build_plot(
  labels_and_colors=labels_and_colors,
    chart_geom = "Line Chart",
  share = FALSE,
  data=summary_data %>% filter( isUCA!="Not UCA" & 
                                  DecisionTreeDisplay %in% c("Disaster","ARRA","OCO")),
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="pAnnualDatasetObligation", #y_var
  color_var="isUCA", #color_var
  facet_var="DecisionTreeDisplay", #facet_var
  column_key=column_key,
  format=TRUE
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+labs(line="Is Undefinitized Contract Action (UCA)",
  # title="Defense Contracts with Labeled Cector",
  xlab="Fiscal Year",
  ylab="Percent of Obligations")+
  theme(legend.position = "right")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
    scale_y_continuous(labels = scales::percent)+coord_cartesian(ylim=c(0,0.3))+
  theme(strip.text.y = element_text(angle=270))
)
ggsave600dpi("Output//UCAannual.png", UCAannual, width=4.5, height= 2, units="in")



(
UCAoverall<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(summary_data,
                      #isUCA!="Not UCA" & 
                     DecisionTreeDisplay!="Not in Sample"),
  # NA, #VAR.ncol
  VAR.x.variable="NoCompOffr", #VAR.x.variable
  VAR.y.variable="pDatasetObligation", #VAR.y.variable
  VAR.y.series="NoCompOffr", #VAR.y.series
  VAR.facet.primary="isUCA", #VAR.facet.primary
  VAR.facet.secondary="DecisionTreeDisplay" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+
# +theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    scale_y_continuous( labels = percent_format())#+
  # facet_grid(primary ~ .)
    # )
)




```



#### Reachback
```{r Reachback}

geom.text.size<-2.5
ReachbackComp<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(summary_data,
                     !DecisionTreeDisplay %in% c("Not in Sample",
                       "Disaster ('07+)",
                       "ARRA ('09-'13)") &
      Is.Defense==TRUE &
      !is.na(Reachback)),
  # NA, #VAR.ncol
  VAR.x.variable="DecisionTreeDisplay", #VAR.x.variable
  VAR.y.variable="pDatasetReachbackObligation", #VAR.y.variable
  VAR.y.series="DecisionTreeDisplay", #VAR.y.series
  VAR.facet.primary="NoCompOffr", #Competition.multisum", #VAR.facet.primary
  VAR.facet.secondary="Reachback" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=TRUE
  #                       ,VAR.override.coloration=NA
)+
  # theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    scale_y_continuous( labels = percent_format())+
  facet_grid(primary ~ secondary)
    # )
ReachbackComp
ggsave600dpi("Output//ReachbackComp.png", ReachbackComp, width=4.5, height= 8, units="in")



```

### Other Variables
#### Product Or Service Area
```{r ProductOrService}
 # summary_data$isUCA<-"Not UCA" 

geom.text.size<-3
ProductOrServiceArea
summary_data$ProductOrServiceArea
(
ProductOrServiceArea<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $, Variable Scale)",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=summary_data %>% filter(DecisionTreeDisplay %in% c("Disaster","ARRA","OCO")),
  # NA, #VAR.ncol
  VAR.x.variable="ProductOrServiceArea", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="ProductOrServiceArea", #VAR.y.series
  VAR.facet.primary="DecisionTreeDisplay" #VAR.facet.primary
  # VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+
# +theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
  facet_grid(primary ~ ., scales="free_y")
    # )
)
 

 
ggsave600dpi("Output//ProductService.png", UCAoverall, width=4, height= 5, units="in")
ggsave("Output//ProductService.eps", UCAoverall, width=4, height= 5, units="in")
```


#### Customer
```{r Customer}
 # summary_data$isUCA<-"Not UCA" 

geom.text.size<-3


(
Customer<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $, Variable Scale)",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=summary_data %>% filter(DecisionTreeDisplay %in% c("Disaster","ARRA","OCO")),
  # NA, #VAR.ncol
  VAR.x.variable="Customer", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="Customer", #VAR.y.series
  VAR.facet.primary="DecisionTreeDisplay"#, #VAR.facet.primary
  # VAR.facet.secondary="Is.Defense" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+
# +theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    facet_wrap(primary ~ . , scales="free_y", ncol=1)
  # facet_grid(. ~ primary +secondary, scales="free", space = "free_x")
)
 

 
ggsave600dpi("Output//Customer.png", Customer, width=4, height= 5, units="in")
ggsave("Output//Customer.eps", Customer, width=4, height= 5, units="in")
```


#### Duration
```{r Duration}
 # summary_data$isUCA<-"Not UCA" 

(
Duration<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=subset(summary_data,
                     DecisionTreeDisplay!="Not in Sample"),
  # NA, #VAR.ncol
  VAR.x.variable="DecisionTreeDisplay", #VAR.x.variable
  VAR.y.variable="pDatasetObligation", #VAR.y.variable
  VAR.y.series="DecisionTreeDisplay", #VAR.y.series
  VAR.facet.primary="Dur.Simple" #VAR.facet.primary
  # VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+
  # theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))+
    scale_y_continuous( labels = percent_format())+
  facet_grid(primary ~ .#,scales="free_y", space="free_y"
             )
    )
 
ggsave600dpi("Output//Duration.png", Duration, width=4, height= 5, units="in")
ggsave("Output//Duration.eps", Duration, width=4, height= 5, units="in")



(
DurationComp<-  LatticePlotWrapper_csis360(
  VAR.color.legend.label="Dataset",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $, Variable Scale)",
  VAR.Coloration=labels_and_colors,
  VAR.long.DF=summary_data  %>% filter( 
                                  DecisionTreeDisplay %in% c("Disaster","ARRA","OCO")),
  # NA, #VAR.ncol
  VAR.x.variable="Dur.Simple", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="NoCompOffr", #VAR.y.series
  VAR.facet.primary="DecisionTreeDisplay", #VAR.facet.primary
  VAR.facet.secondary="NoCompOffr" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
   ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+
  # theme(legend.position = "bottom")+
  #  scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=0))+
  theme(axis.text.x = element_text(angle=90))#+
  # facet_grid(primary ~ .#,scales="free_y", space="free_y"
             # )
    )
 


```

# Modeling






##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


```{r ReadInData, echo = TRUE}
# load(file="Data/Federal_contract_CSIScontractID_detail.Rdata")

# debug(transform_contract)
# fed<-transform_contract(fed)

# save(fed,file="Data/fed_transformed.Rdata")
load(file="Data/fed_transformed.Rdata")

```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

### Contract Data Summary

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  


* b_CBre is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(fed$b_CBre)
NA_stats(fed,"b_CBre")')     "the original variable is CBre(None/Ceiling Breach"

```{r grouped barplot for variable: b_CBre}
#the original variable for b_CBre is CBre(None/Ceiling Breach)

statsummary_discrete("CBre", fed)
grouped_barplot("CBre", fed)

```

```{r grouped barplot for variable: b_Term}
#The original variable for b_Term is Term

statsummary_discrete("Term", fed)
grouped_barplot("Term", fed)

```


* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(fed$b_Comp);         "the original variable is Comp(No Comp./Comp.)"
NA_stats(fed,"b_Comp")'

```{r grouped barplot for variable: b_Comp}
#the original variable for b_Comp is Comp(No Comp./Comp.)

statsummary_discrete("Comp", fed)
grouped_barplot("Comp", fed)

```

* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(fed$EffComp);
NA_stats(fed,"n_Comp")' "the original variable is EffComp(No Comp./1 Offer/2+ offers)"    
```{r grouped barplot for variable: n_Comp}
#the original variable for n_Comp is EffComp(No Comp./1 offer/2+ offers)

statsummary_discrete("EffComp", fed)
grouped_barplot("EffComp", fed)

```


* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(fed$n_Offr);
NA_stats(fed,"n_Offr")' 



* b_Urg is a categorical variable.
It has a value of 0, stands for "Not Urgency", and 1 stands for "Urgency Except." 
summary(fed$Urg);
NA_stats(fed,"b_Urg")' 

```{r grouped barplot for variable: b_Urg}
#The original variable for b_Urg is Urg(Not Urgency/Urgency Except.)

statsummary_discrete("Urg", fed)
grouped_barplot("Urg", fed)

```


* cl_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(fed$l_Offr)
NA_stats(fed,"l_Offr")'

```{r statistical summary table for variable cl_Offer}
#The original variable for cl_Offer is UnmodifiedNumberOfOffersReceived
 
statsummary_continuous(("UnmodifiedNumberOfOffersReceived"), fed)

```


* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(fed$l_Ceil,"dollars")
NA_stats(fed,"l_Ceil")'

```{r statistical summary table for variable cl_Ceil}
#The original variable for cl_Ceil is UnmodifiedContractBaseAndAllOptionsValue

statsummary_continuous(("UnmodifiedContractBaseAndAllOptionsValue"), fed)

```


* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(fed$l_Days,"days");
NA_stats(fed,"l_Days")' 

```{r statistical summary table for variable cl_Days}
#The original variable for cl_Days is UnmodifiedDays

fed$capped_UnmodifiedDays[fed$UnmodifiedDays > 3650] <- NA
statsummary_continuous(("capped_UnmodifiedDays"), fed)

```


* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(fed$SIDV);
summary(fed$MIDV);
summary(fed$FSSGWAC);
summary(fed$BPABOA);
NA_stats(fed,"Veh")'

```{r grouped bar plot for variable Veh}

statsummary_discrete("Veh", fed)
grouped_barplot("Veh", fed)

```


* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(fed$n_Fixed);
NA_stats(fed,"n_Fixed")')

```{r grouped bar plot for variable n_Fixed}
#The original variable for n_Fixed is FxCb

statsummary_discrete("FxCb", fed)
grouped_barplot("FxCb", fed)

```


* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 for "combination or other", 0 for all remaining types. ('r summary(fed$n_Incent);
NA_stats(fed,"n_Incent")')

```{r grouped barplot for variable n_Incent}
#The original variable for n_Incent is Fee

statsummary_discrete("Fee", fed)
grouped_barplot("Fee", fed)

```


* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(fed$b_UCA);
NA_stats(fed,"b_UCA")'

```{r grouped bar plot for variable b_UCA}
#The original variable for b_UCA is UCA

statsummary_discrete("UCA", fed)
grouped_barplot("UCA", fed)

```


* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(fed$b_Intl);
NA_stats(fed,"b_Intl")'


```{r grouped bar plot for variable b_Intl}
#The original variable for b_Intl is Intl

statsummary_discrete("Intl", fed)
grouped_barplot("Intl", fed)

```

```{r c_OffCri}
#The original variable for c_OffCri is OffCri
debug(statsummary_continuous)
statsummary_continuous("OffCri", fed,log=FALSE)

```


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.

```{r grouped bar plot for variable Agency, NAICS, ProdServ, Office, PlaceCountryISO3}

#############################################
#Group bar plot for discrete variable: Agency
#############################################

Agency_Freq <- freq_table("Agency", fed)
#Add detail description to unique Agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
Agency_Freq$Description <- as.character(Agency_Freq$Description)

#Get the top 10 most frequently appeared Agencies
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Percent_Freq),]
Agency_Freq <- Agency_Freq[1:10,]
Agency_Freq$Description <- paste(Agency_Freq$Agency, " - ", Agency_Freq$Description)
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Percent_Obli),]

#Add a row representing all other Agency categories
percent_freq_rest <- 100 - sum(Agency_Freq$Percent_Freq, na.rm = TRUE)
percent_obli_rest <- 100 - sum(Agency_Freq$Percent_Obli, na.rm = TRUE)
Agency_Freq[11,] <- c("All Other", "NA", percent_freq_rest, percent_obli_rest, "All Other")
Agency_Freq[,c(3,4)] <- lapply(Agency_Freq[,c(3,4)], function(x) as.numeric(x))
Agency_Freq$Description <- factor(Agency_Freq$Description, levels = rev(Agency_Freq$Description))

#Reshape the dataframe to long format for plot
Agency_Freq <- melt(Agency_Freq, id = c("Agency", "Count_Freq", "Description"))

#Generate the plot and add title manually
part_grouped_barplot("Agency",Agency_Freq) + 
  ggtitle("Top 10 of the most frequently appeared Agency")





############################################
#Group bar plot for discrete variable: NAICS
############################################

NAICS_Freq <- freq_table("NAICS", fed)   #need long time to run

#Add detail description to unique Agency code
NAICS_Lookup <- read.csv(file = "https://raw.githubusercontent.com/CSISdefense/Vendor/master/Lookup/Lookup_NAICS_code.csv")
colnames(NAICS_Lookup) <- c("NAICS", "Description")
NAICS_Freq <- left_join(NAICS_Freq, NAICS_Lookup, by = "NAICS")
NAICS_Freq$Description <- as.character(NAICS_Freq$Description)
NAICS_Freq$Description <- paste(NAICS_Freq$NAICS, " - ", NAICS_Freq$Description)

#Get the top 19 most frequently appeared NAICS
NAICS_Freq_top10Freq <- NAICS_Freq[order(-NAICS_Freq$Percent_Freq),]
NAICS_Freq_top10Freq <- NAICS_Freq_top10Freq[2:11, ]   #THE first records has NA ID nor description
NAICS_Freq_top10Obli <- NAICS_Freq[order(-NAICS_Freq$Percent_Obli),]
NAICS_Freq_top10Obli <- NAICS_Freq_top10Obli[1:10, ]
NAICS_Freq_TOP <- rbind(NAICS_Freq_top10Obli, NAICS_Freq_top10Freq)
NAICS_Freq_TOP <- unique(NAICS_Freq_TOP)  #19 records in total
NAICS_Freq_TOP <- NAICS_Freq_TOP[order(-NAICS_Freq_TOP$Percent_Obli),]
NAICS_Freq_TOP$Description <- factor(NAICS_Freq_TOP$Description, rev(NAICS_Freq_TOP$Description))

#Reshape the dataframe to long format for plot
NAICS_Freq_TOP <- melt(NAICS_Freq_TOP, id = c("NAICS", "Count_Freq", "Description"))

#Generate the plot and add title manually
part_grouped_barplot("NAICS", NAICS_Freq_TOP) + 
  ggtitle("Top 19 of the most frequently appeared NAICS")




###############################################
#Group bar plot for discrete variable: ProdServ
###############################################

ProdServ_Freq <- freq_table("ProdServ", fed)   #need long time to run

#Add detail description to unique Agency code
ProdServ_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/ProductOrServiceCodes.csv")
ProdServ_Lookup <- ProdServ_Lookup[, 1:2]
colnames(ProdServ_Lookup) <- c("ProdServ", "Description")
ProdServ_Freq <- left_join(ProdServ_Freq, ProdServ_Lookup, by = "ProdServ")
ProdServ_Freq$Description <- as.character(ProdServ_Freq$Description)
ProdServ_Freq$Description <- paste(ProdServ_Freq$ProdServ, " - ", ProdServ_Freq$Description)

#Get the top 19 most frequently appeared ProdServ
ProdServ_Freq_top10Freq <- ProdServ_Freq[order(-ProdServ_Freq$Percent_Freq), ]
ProdServ_Freq_top10Freq <- ProdServ_Freq_top10Freq[1:10, ]
ProdServ_Freq_top10Obli <- ProdServ_Freq[order(-ProdServ_Freq$Percent_Obli), ]
ProdServ_Freq_top10Obli <- ProdServ_Freq_top10Obli[1:10, ]
ProdServ_Freq_TOP <- rbind(ProdServ_Freq_top10Obli, ProdServ_Freq_top10Freq)
ProdServ_Freq_TOP <- unique(ProdServ_Freq_TOP)
ProdServ_Freq_TOP <- ProdServ_Freq_TOP[order(-ProdServ_Freq_TOP$Percent_Obli), ]
ProdServ_Freq_TOP$Description <- factor(ProdServ_Freq_TOP$Description, rev(ProdServ_Freq_TOP$Description))

#Reshape the dataframe to long format for plot
ProdServ_Freq_TOP <- melt(ProdServ_Freq_TOP, id = c("ProdServ", "Count_Freq", "Description"))

#Generate the plot and add title manually
part_grouped_barplot("ProdServ", ProdServ_Freq_TOP) + 
  ggtitle("Top 19 of the most frequently appeared ProdServ")





#############################################
#Group bar plot for discrete variable: Office
#############################################

#Add detail description to unique Agency code
Office_Lookup <- read.delim("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/office/Office.ContractingOfficeCode.txt")
fed_dup <- fed
Total_Obli <- sum(fed_dup$Action.Obligation, na.rm = TRUE)
memory.limit(56000)
Office_Lookup <- subset(Office_Lookup, select = c("AgencyID", "ContractingOfficeCode", "ContractingOfficeName"))
fed_dup <- left_join(fed_dup, Office_Lookup, by = c("Agency" = "AgencyID", "Office" = "ContractingOfficeCode"))
fed_dup <- subset(fed_dup, select = c("Office", "ContractingOfficeName"))
Office_Freq <- fed_dup %>% group_by(Office, ContractingOfficeName) %>% summarise(n())
colnames(Office_Freq) <- c("Office", "Description", "Count_Freq")
Office_Freq$Percent_Freq <- round(Office_Freq$Count_Freq/sum(Office_Freq$Count_Freq),4)*100

#Add percent Obligation information into dataframe
Percent_Obli <- c()
for (i in Office_Freq$Office) {
  Percent_Obligation <- round(sum(fed$Action.Obligation[fed$Office == i], na.rm = TRUE)/Total_Obli,5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
  print(i)
}
Office_Freq$Percent_Obli <- Percent_Obli * 100
#Office_Freq_dup <- Office_Freq

#Get Top 20 most frequently appeared Office
Office_Freq_top10Freq <- Office_Freq[order(-Office_Freq$Percent_Freq),]
Office_Freq_top10Freq <- Office_Freq_top10Freq[1:10, ]  #including NULL category
Office_Freq_top10Obli <- Office_Freq[order(-Office_Freq$Percent_Obli),]
Office_Freq_top10Obli <- Office_Freq_top10Obli[1:10, ]  #including NULL category
Office_Freq_TOP <- rbind(Office_Freq_top10Obli, Office_Freq_top10Freq)
Office_Freq_TOP <- unique(Office_Freq_TOP)  #20 records in total
Office_Freq_TOP$Description[is.na(Office_Freq_TOP$Description)] <- "NULL"
Office_Freq_TOP$Description <- paste(Office_Freq_TOP$Office, " - ", Office_Freq_TOP$Description)
Office_Freq_TOP$Description <- factor(Office_Freq_TOP$Description, levels = rev(Office_Freq_TOP$Description))

#reshape the dataframe into long format for plot
Office_Freq_TOP <- melt(Office_Freq_TOP, id = c("Office", "Description", "Count_Freq"))

#Generate the plot and add title manually
part_grouped_barplot("Office", Office_Freq_TOP) + 
  ggtitle("Top 20 of the most frequently appeared Office")




#######################################################
#Group bar plot for discrete variable: PlaceCountryISO3
#######################################################

Place_Freq <- freq_table("PlaceCountryISO3", fed)
Place_Freq <- Place_Freq[order(-Place_Freq$Percent_Obli),]
Place_Freq <- Place_Freq[1:10, ]

#Add a row representing all other PlaceCountry categories
percent_freq_rest <- 100 - sum(Place_Freq$Percent_Freq, na.rm = TRUE)
percent_obli_rest <- 100 - sum(Place_Freq$Percent_Obli, na.rm = TRUE)
Place_Freq$PlaceCountryISO3 <- as.character(Place_Freq$PlaceCountryISO3)
Place_Freq[11,] <- c("All other", "NA", percent_freq_rest, percent_obli_rest)
Place_Freq[, c(3,4)] <- lapply(Place_Freq[, c(3,4)], function(x) as.numeric(x))
Place_Freq$PlaceCountryISO3 <- factor(Place_Freq$PlaceCountryISO3, levels = rev(Place_Freq$PlaceCountryISO3))

#Reshape the dataframe to long format for plot
Place_Freq <- melt(Place_Freq, id <- c("PlaceCountryISO3", "Count_Freq"))

#Generate the plot and add title manually
part_barplot <- ggplot(data = Place_Freq, 
                       aes(x = PlaceCountryISO3, 
                           y = value, 
                           fill=factor(variable))) + 
                geom_bar(stat = "identity", 
                         position= "dodge", 
                         width = 0.8) + 
                xlab("") + 
                ylab("") + 
                coord_flip() + 
                theme_grey() +
                scale_fill_grey(labels = c("% of records", "% of obligation"),
                                guide = guide_legend(reverse = TRUE)) +
                theme(legend.title = element_blank(),
                      legend.position = "bottom",
                      legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                      legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                      plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm")) +
                ggtitle("Top 10 of the most frequently appeared PlaceCountry")
part_barplot 
```






Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.


## Sample Creation
```{r Sample}
load("Data\\crisis_smp.Rdata")

# crisis_smp<-add_col_from_transformed(crisis_smp,fed)
# crisis_with_na<-add_col_from_transformed(crisis_with_na,fed)
# large_crisis_smp<-add_col_from_transformed(large_crisis_smp,fed)  
# large_crisis_with_na<-add_col_from_transformed(large_crisis_with_na,fed)  
    
    # large_crisis_with_na<-update_sample_col_CSIScontractID(sample=large_crisis_with_na,full=fed_full,
#                                  col=c("PlaceCountryISO3","VendorCountryISO3","OriginCountryISO3"))
# crisis_with_na<-update_sample_col_CSIScontractID(sample=crisis_with_na,full=fed_full,
#                                  col=c("PlaceCountryISO3","VendorCountryISO3","OriginCountryISO3"))

#save(fed,file="Data/fed_transformed.Rdata")
# head(fed)

    
# crisis_all<-rbind(oco,recovery,disaster)
# crisis_all_with_na<-rbind(oco_with_na,recovery,disaster)
summary(crisis_all$Crisis)
crisis_all$Crisis<-factor(crisis_all$Crisis,c("Other","OCO" ,"ARRA",  "Dis"     ))

# colnames(fed)[colnames(fed)=="PlaceCountryISO3"]<-"alpha.3"
# fed<-csis360::read_and_join( fed, #contract,
#                                       "Location_CountryCodes.csv",
#                                       path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
#                                       directory="location\\",
#                                       by="alpha.3",
#                                       add_var=c("PlaceIntlPercent","CrisisPercent"),
#                                       new_var_checked=FALSE)
# colnames(fed)[colnames(fed)=="alpha.3"]<-"PlaceCountryISO3"

fed$ProdServ[fed$ProdServ==""]<-NA


# fed<-fed[get_complete_list(fed),]
# fed<-fed[!fed$CSIScontractID %in% fed_1m$CSIScontractID,]
# count<-1000000-997374

# summary(factor(fed_1m$AgencyID[is.na(fed_1m$Customer)]))
# summary(factor(fed_1m$ProdServ[is.na(fed_1m$CrisisProductOrServiceArea)]))
# summary(factor(fed_1m$ProdServ[is.na(fed_1m$CrisisProductOrServiceArea)]))
# fed_1m$ProdServ[fed_1m$ProdServ==""]<-NA
fed_1m<-fed_1m[get_complete_list(fed_1m),]
fed_250k<-fed_250k[get_complete_list(fed_250k),]


# fed_1m$Customer<-factor(fed_1m$Customer)
# fed_1m$CrisisProductOrServiceArea<-factor(fed_1m$CrisisProductOrServiceArea)
# fed_complete<-fed[get_complete_list(fed),]
# fed_1m<-fed_complete[sample(nrow(fed_complete),1000000),]
# fed_250k<-fed_complete[sample(nrow(fed_complete),250000),]
# save(fed_1m,fed_250k,file="output//fed_sample.rdata")
load(file="output//fed_sample.rdata")
#Percent of records incomplete
nrow(fed[!fed_complete,])/nrow(fed) #0.2760521
nrow(fed[is.na(fed$UCA),])/nrow(fed) #0.2760521
#Percent of dollars incomplete
sum(fed[!fed_complete,]$Action.Obligation,na.rm=TRUE)/
  sum(fed$Action.Obligation,na.rm=TRUE) #0.1217748




# undebug(get_crisis_sample_with_na)
crisis_with_na<-get_crisis_sample_with_na(fed)
crisis_smp<-crisis_with_na[get_complete_list(crisis_with_na),]



summary(crisis_all$Crisis)

#Percent of records incomplete
nrow(crisis_with_na[!get_complete_list(crisis_with_na),])/
  nrow(crisis_with_na)
#Percent of dollars incomplete
sum(crisis_with_na[!get_complete_list(crisis_with_na),]$Action.Obligation,na.rm=TRUE)/
  sum(crisis_with_na$Action.Obligation,na.rm=TRUE)



# large_crisis_with_na<-get_crisis_sample_with_na(fed,large=TRUE)
nrow(large_crisis_with_na[!get_complete_list(large_crisis_with_na),])/
  nrow(large_crisis_with_na)
# #Percent of dollars incomplete
  sum(large_crisis_with_na[!get_complete_list(large_crisis_with_na),]$Action.Obligation,na.rm=TRUE)/
    sum(large_crisis_with_na$Action.Obligation,na.rm=TRUE)
  # large_crisis_smp<-large_crisis_with_na[get_complete_list(large_crisis_with_na),]
# 
# 
# # 
#   
# 
save(crisis_smp,crisis_with_na,
     large_crisis_with_na,large_crisis_smp,
     crisis_all,crisis_all_with_na,file="Data\\crisis_smp.Rdata")



#
# large_crisis_smp$OffPl99<-Hmisc::cut2(large_crisis_smp$OffIntl,c(0.01,0.50))
# summary(large_crisis_smp$OffPl99)
#   levels(large_crisis_smp$OffPl99) <-
#     list("US99"=c("[0.00,0.01)"),
#          "Mixed"=c("[0.01,0.50)"),
#          "Intl"=c("[0.50,1.00]"))
#   large_crisis_smp$Reach<-factor(paste(large_crisis_smp$OffPl99,large_crisis_smp$Intl,sep="-"))
#
#
#      levels(crisis_smp$Reach) <-
#     list( "US50-Dom"=c("US99-Just U.S.","Mixed-Just U.S."),
#          "Mixed-Dom"=c(),
#          "Intl-Dom"=c("Intl-Just U.S."),
#          "US50-Intl"=c("Mixed-Any International","US99-Any International"),
#          "Intl-Intl"=c("Intl-Any International"))
#
# large_crisis_smp$PSA<-as.character(large_crisis_smp$ProductOrServiceArea)
# large_crisis_smp$PSA<-gsub(" & ","+",large_crisis_smp$PSA)
# load("Data\\large_crisis_smp.Rdata")
# save(large_crisis_smp,large_crisis_with_na,file="Data\\large_crisis_smp.Rdata")
# save(fed,file="Data\\transformed_fed.Rdata")
# load(file="Data\\transformed_fed.Rdata")

# extra_large_crisis_with_na<-fed[fed$Crisis %in% c("ARRA","Dis","OCO"),]
# other_intl<-fed[fed$Crisis %in% c("Other")&fed$OffIntl>=0.5,]
# other_dom<-fed[fed$Crisis %in% c("Other")&(fed$OffIntl<0.5
#                                            |is.na(fed$OffIntl)),]
# other_dom<-other_dom[sample(nrow(other_dom),1000000),]
# extra_large_crisis_with_na<-rbind(extra_large_crisis_with_na,other_dom,other_intl)
# rm(other_dom,other_intl)
# 
# extra_large_crisis_with_na<-(extra_large_crisis_with_na)
# extra_large_complete<-get_complete_list(extra_large_crisis_with_na)
# extra_large_crisis_smp<-extra_large_crisis_with_na[extra_large_complete,]
# # # summary(large_crisis_with_na$Crisis)
# # #
# #
# extra_large_crisis_smp$OffPl99<-Hmisc::cut2(extra_large_crisis_smp$OffIntl,c(0.01,0.50))
# summary(extra_large_crisis_smp$OffPl99)
#   levels(extra_large_crisis_smp$OffPl99) <-
#     list("US99"=c("[0.00,0.01)"),
#          "Mixed"=c("[0.01,0.50)"),
#          "Intl"=c("[0.50,1.00]"))
#   extra_large_crisis_smp$Reach<-factor(paste(extra_large_crisis_smp$OffPl99,extra_large_crisis_smp$Intl,sep="-"))
# 
# 
#      levels(extra_large_crisis_smp$Reach) <-
#     list( "US50-Dom"=c("US99-Just U.S.","Mixed-Just U.S."),
#          "Mixed-Dom"=c(),
#          "Intl-Dom"=c("Intl-Just U.S."),
#          "US50-Intl"=c("Mixed-Any International","US99-Any International"),
#          "Intl-Intl"=c("Intl-Any International"))
# 
# save(extra_large_crisis_smp,extra_large_crisis_with_na,file="Data\\extra_large_crisis_smp.Rdata")
# load("Data\\extra_large_crisis_smp.Rdata")
summary(fed_1m)
```

## Output: Models

###Federal-Wide 21B Term
```{r Model21B}
# summary(large_crisis_smp$ServCommCons)
# summary(large_crisis_smp$CPSA)
    

load("Output//Model21B.rdata")

if(!exists("Term_21B"))
  Term_21B <- glmer (data=fed_1m,
                   b_Term ~ Crisis +NoCompOffr2+
                     b_UCA+
                     c_OffCri+
                     OffPlace+
                    cl_Ceil+
                     capped_cl_Days+
                     Veh+
                     PricingFee+
                          #Crisis:NoCompOffr+
                     # b_UCA:Crisis+
                     # b_UCA:NoCompOffr2,
  
                     (1 | CrisisProductOrServiceArea/ProdServ) + 
                     (1 | Customer/Office)+
                     (1 + OffPlace| PlaceCountryISO3), 
                   family=binomial(link="logit"),
                   verbose=1,
     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))
  glmer_examine(Term_21B)
  
stargazer::stargazer(Term_21B,type="text",#Term_20A,#Term_20C
                        digits=2)

summary_residual_compare(Term_21B,bins=50)

  CBre_22F.all<-allFit_save(CBre_22F,filename="output/CBre_22F_allfit.rdata")
```


### Federal-Wide 21C: CBre
```{r Model21C}


load("Output//Model21C_CBre.rdata")
if(!exists("CBre_21C"))
  CBre_21C <- glmer (data=fed_1m,
                   b_CBre ~ Crisis +NoCompOffr2 +
                     b_UCA+
                     
                     OffPlace+
                     cl_Ceil+
                     capped_cl_Days+
                     Veh+
                     PricingFee+
                     #Crisis:NoCompOffr+
                     # b_UCA:Crisis+
                     # Veh:cl_Ceil+
                     b_UCA:NoCompOffr2+
                     cl_Ceil:NoCompOffr2+
                   #   capped_cl_Days:NoCompOffr+
                   # NoCompOffr:Veh,
    

                     (1 | CrisisProductOrServiceArea/ProdServ) + 
                     (1 | Customer/Office) + 
                     (1 + OffPlace | PlaceCountryISO3) + 
                     (1 | StartFY)
               , 
                   family=binomial(link="logit"),
                verbose=1)
  glmer_examine(CBre_21C)

  
# Plot the model and Vehicle 
stargazer::stargazer(CBre_21C,type="text",#Term_20A,#Term_20C
                        digits=2)

summary_residual_compare(CBre_21C,bins=50)


  CBre_21C.all<-allFit_save(CBre_21C,filename="output/CBre_21C_allfit.rdata")
```


### Crisis-Only 22E Term
```{r Model22E}
# summary(large_crisis_smp$ServCommCons)
# summary(large_crisis_smp$CPSA)

load("Output//Model22E.rdata")

  
if(!exists("Term_22E"))
  Term_22E <- glmer (data=crisis_all,
                   b_Term ~ Crisis +NoCompOffr2+
                     b_UCA+
                     c_OffCri+
                     OffPlace+
                    cl_Ceil+
                     capped_cl_Days+
                     Veh+
                     PricingFee+
                          #Crisis:NoCompOffr+
                     # b_UCA:Crisis+
                     # b_UCA:NoCompOffr2+
                     (1 | CrisisProductOrServiceArea/ProdServ) + 
                     (1 | Customer/Office)+
                     (1 + OffPlace| PlaceCountryISO3), 
                   family=binomial(link="logit"),
                     control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))
  glmer_examine(Term_22E)
  
  
  source(system.file("utils", "allFit.R", package="lme4"))
  
  
  Term_22E.all<-allFit_save(Term_22E,filename="output/Term_22E_allfit.rdata")
  Term_22E_ss_cons <- summary(Term_22E.all) 

    structure(res, class = "allfit", fit = m, sessionInfo =  sessionInfo(),
              data = data # is dropped if NULL
              )
  
  # odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B")
# if(!exists("CBre_Cons_13B_1m_restart")){
#   pars<-get_pars(CBre_Cons_13B_1m)
#   CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
#                                      start=pars,
#                                      verbose=1)
    
      
# Plot the model and Vehicle 
stargazer::stargazer(Term_22E,type="text",#Term_20A,#Term_20C
                        digits=2)

summary_residual_compare(Term_22E,bins=50)
```

```{r Xinyi: Plot Countries with top20 frequencies and their multilevel intercept}
load("Output//Model22E.rdata")
coef(Term_22E)$PlaceCountryISO3[1]
Country_Intercept <- as.data.frame(coef(Term_22E)$PlaceCountryISO3[1])
Country_Intercept$Countries <- row.names(Country_Intercept)
row.names(Country_Intercept) <- NULL
colnames(Country_Intercept) <- c("Intercept", "Countries")

library(dplyr)
#Get the Top 20 countries in crisis_all with highest frequency
Top20_Countries <- as.data.frame(table(crisis_all$PlaceCountryISO3)) %>% `colnames<-`(c("Countries", "Freq"))
Top20_Countries <- Top20_Countries[order(-Top20_Countries$Freq),]
Top20_Countries <- Top20_Countries[1:20,] %>% `row.names<-`(NULL)
Top20_Countries$Countries <- as.character(Top20_Countries$Countries)
#Extract Top 20 frequent countries from Country_Intercept
Country_Intercept20 <- Country_Intercept[which(Country_Intercept$Countries %in% Top20_Countries$Countries),] %>% `row.names<-`(NULL)
Country_Intercept20 <- Country_Intercept20[order(Country_Intercept20$Intercept),] %>% `row.names<-`(NULL)
Country_Intercept20$Countries <- as.character(Country_Intercept20$Countries)
Country_Intercept20$Countries <- factor(Country_Intercept20$Countries, 
                                        levels = unique(Country_Intercept20$Countries))

#build the intercept-T20 countries barplot
library(ggplot2)
ggplot(data = Country_Intercept20,
       aes(x = Country_Intercept20$Countries,
           y = Country_Intercept20$Intercept)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) +
  xlab("") +
  ylab("") +
  ggtitle("Multi-level logit intercept") + 
  theme_grey() +
  scale_fill_grey() +
  theme(plot.margin = margin(t=1,
                             r=0.5,
                             b=1,
                             l=0.5,
                             unit = "cm"),
        plot.title = element_text(hjust = 0.5))
```




### Crisis-Only 22F CBre
```{r Model22F}
# summary(large_crisis_smp$ServCommCons)
# summary(large_crisis_smp$CPSA)

load("Output//Model22F_CBre.RData")


fed_1m$ProdServ<-factor(fed_1m$ProdServ)
fed_1m$Customer<-factor(fed_1m$Customer)
summary(fed_1m[,colnames(fed_1m) %in% 
                 c("Crisis",
                   "NoCompOffr2", 
                     "b_UCA",
                     "OffPlace",
                     "cl_Ceil",
                     "capped_cl_Days",
                     "Veh",
                     "PricingFee",
                     #Crisis:NoCompOffr+
                     # b_UCA:Crisis+
                     # Veh:cl_Ceil+
                       "NoCompOffr2",
                     "cl_Ceil",
                     "b_UCA",
                     "NoCompOffr2",
                     "CrisisProductOrServiceArea",
                     "ProdServ",
                     "Customer",
                     "Office",
                     "OffPlace",
                     "PlaceCountryISO3",
                     "StartFY")])


if(!exists("CBre_22F"))
  CBre_22F <- glmer (data=crisis_all,
                     b_CBre ~ Crisis +NoCompOffr2 +
                     b_UCA+
                     OffPlace+
                     cl_Ceil+
                     capped_cl_Days+
                     Veh+
                     PricingFee+
                     #Crisis:NoCompOffr+
                     # b_UCA:Crisis+
                     # Veh:cl_Ceil+
                       NoCompOffr2:cl_Ceil+
                     b_UCA:NoCompOffr2+
                     (1 | CrisisProductOrServiceArea/ProdServ) + 
                     (1 | Customer/Office) + 
                     (1 + OffPlace | PlaceCountryISO3) + 
                     (1 | StartFY)
               , 
                   family=binomial(link="logit")
     # control = glmerControl(optimizer = "optimx", calc.derivs = FALSE,
     # optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE))
     )

  glmer_examine(CBre_22F)
  load("Output//CBre_22F_allfit.rdata")

# Plot the model and Vehicle 
stargazer::stargazer(CBre_22F,res[1],res[2],res[3],#res[4],
                     res[5],#res[6],res[7],
                     type="text",#Term_20A,#Term_20C
                        digits=2)

length(res[[6]])
res[[5]]

summary_residual_compare(CBre_22F,bins=50)


  CBre_22F.all<-allFit_save(CBre_22F,filename="output/CBre_22F_allfit.rdata")
```

# Tables for Paper
## Moel Results Directly
```{r Output-Direct}
# Plot the model and Vehicle 
stargazer::stargazer(CBre_21C,CBre_22F,Term_21B,Term_22E,type="text",
                       digits=2)


summary_residual_compare(CBre_21C,CBre_22F,Term_21B,Term_22E,bins=50)


texreg::htmlreg(list(CBre_21C,CBre_22F,Term_21B,Term_22E),file="Output//Both_Model.html",
                single.row = TRUE,
                custom.model.name=c("Federal-Wide<br>Ceiling Breach",
                                    "Crisis-Only<br>Ceiling Breach",
                                    "Federal-Wide<br>Termination",
                                    "Crisis-Only<br>Termination"
                                    ),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:9,
                              "Crisis Category" = 10:12,
                              "Contract Characteristics"=13:23,
"Interactions" = 24:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                                     "NoCompOffrUrgency"="No Comp, Urgency",
                                     "NoCompOffr2Urgency"="No Comp, Urgency",
"NoCompOffr2Other No"="No Comp, Other",

"NoCompOffr1 offer"="Comp=1 offer",
"NoCompOffr2-4 offers"="Comp=2-4 offers",
"NoCompOffr5+ offers"="Comp=5+ offers",
"NoCompOffr21 offer"="Comp=1 offer",
"NoCompOffr25+ offers"="Comp=5+ offers",
"b_UCA"="UCA",
"c_OffCri"="Cont. Office Crisis %",
"OffPlaceMixed"="Cont. Office 50-99% Intl.",
"OffPlaceIntl"="Cont. Office 99%+ Intl.",
"CrisisOCO"="Crisis=OCO",
"CrisisARRA"="Crisis=Recovery Act",
"CrisisDis"="Crisis=Disaster Relief",
# "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
# "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
# "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
# "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"capped_cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
# "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"NoCompOffrUrgency:cl_Ceil"="No Comp, Urgency:Log(Init. Ceiling)",
"NoCompOffr2Urgency:cl_Ceil"="No Comp, Urgency:Log(Init. Ceiling)",
"NoCompOffr2Other No:cl_Ceil"="No Comp, Other:Log(Init. Ceiling)",
"NoCompOffr1 offer:cl_Ceil"="Comp=1 offer:Log(Init. Ceiling)",
"NoCompOffr21 offer:cl_Ceil"="Comp=1 offer:Log(Init. Ceiling)",
"NoCompOffr2-4 offers:cl_Ceil"="Comp=2-4 offers:Log(Init. Ceiling)",
"NoCompOffr5+ offers:cl_Ceil"="Comp=5+ offers:Log(Init. Ceiling)",
"NoCompOffr25+ offers:cl_Ceil"="Comp=5+ offers:Log(Init. Ceiling)",
"NoCompOffrUrgency:b_UCA"="No Comp, Urgency:UCA",
"NoCompOffr2Urgency:b_UCA"="No Comp, Urgency:UCA",
"NoCompOffr2Other No:b_UCA"="No Comp, Other:UCA",
"NoCompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"NoCompOffr21 offer:b_UCA"="Comp=1 offer:UCA",
"NoCompOffr2-4 offers:b_UCA"="Comp=2-4 offers:UCA",
"NoCompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA",
"NoCompOffr25+ offers:b_UCA"="Comp=5+ offers:UCA",
"cl_Ceil:VehS-IDC"="Vehicle=S-IDC:Log(Init. Ceiling)",
"cl_Ceil:VehM-IDC"="Vehicle=M-IDC:Log(Init. Ceiling)",
"cl_Ceil:VehFSS/GWAC"="Vehicle=FSS/GWAC:Log(Init. Ceiling)",
"cl_Ceil:VehBPA/BOA"="Vehicle=BPA/BOA:Log(Init. Ceiling)"


),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Performance Models",
caption.above=TRUE)


```

## Model Odds Ratio
```{r Output-Odds Ratio}
or1<-odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C,"CBre_Comp_13C","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="Output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)


write.csv(get_study_variables_odds_ratio(comp.or),file="Output//ceiling_breach_study_odds_ratio_1m.csv",row.names=FALSE)
get_icc(CBre_Cons_Comp_15A_1m)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(CBre_Cons_13B.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```