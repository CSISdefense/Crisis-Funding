---
title: "Crisis Funding Exploration"
author: "Greg Sanders"
date: "March 28, 2017"
output:
  html_document: 
  keep_md: yes
pdf_document: default
---
  
#Setup
```{r setup, include=FALSE}

library(dplyr)
library(tidyr)
library(reshape2)
library(Hmisc)
library(csis360)
library(scales)


# diigtheme1:::diiggraph()


axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-1

main.text.size<-1
note.text.size<-1.40


load(
     file="Data//budget_SP_LocationVendorCrisisFundingHistoryBucketCustomerDetail.Rdata")

```

#Decision Tree
#Step 1: Direct Crisis Labels 
##Step 1A: Is this an ARRA labled contract (or a CSIS labeled one)
```{r Step1A}

full_data$CrisisFunding1A<-"Unlabeled"
#Labeled contracts
full_data$CrisisFunding1A<-ordered(full_data$CrisisFunding1A,levels=c("OCO","Disaster","ARRA","Unlabeled"))
#Also captures the account flag variable in FPDS
full_data$CrisisFunding1A[full_data$CrisisFunding1A=="Unlabeled" & !is.na(full_data$ContractCrisisFunding)]<-
  full_data$ContractCrisisFunding[full_data$CrisisFunding1A=="Unlabeled" & !is.na(full_data$ContractCrisisFunding)]
full_data$CrisisFunding1A[full_data$CrisisFunding1A=="Unlabeled" & full_data$IsARRAcrisisFunding==1]<-
  "ARRA"


library(showtext)

Tree1A<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="ARRA/CSIS Labeled Contract",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=full_data,
  # NA, #VAR.ncol
  VAR.x.variable="dFYear", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1A", #VAR.y.series
  VAR.facet.primary= "ContractCrisisFunding", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed") +
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))

font_add_google("Open Sans")


summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding1A)


windowsFonts()

Tree1A
ggsave600dpi("Output//Figure1_Tree1A.png", Tree1A, width=6.5, height= 3, units="in")
ggsave("Output//Figure1_Tree1A.eps", Tree1A, width=6.5, height= 3, units="in")
```

##Step 1B: Contingency or Humanitarian Peaclaekeeping Operation
```{r Step1B}
full_data$contingencyhumanitarianpeacekeepingoperationText[
  full_data$contingencyhumanitarianpeacekeepingoperationText=="Not Applicable"]<-"Unlabeled"

# ConHumIsOCOcrisisFunding=1
# ,[ContingencyHumanitarianPeacekeepingOperation]

  share_data <- format_data_for_plot(data=subset(full_data,Theater!="Unlabeled"),
                                              share=TRUE,
                                              fy_var="dFYear",
                                              # start_fy=start_fy,
                                              # end_fy=end_fy,
                                              y_var="Obligation.2017",
                                              color_var="contingencyhumanitarianpeacekeepingoperationText",
                                              facet_var="Theater",
                                              labels_and_colors=full_labels_and_colors)


Tree1B<-build_plot(
  data=share_data,
  chart_geom = "Line Chart",
  share = TRUE,
  x_var="dFYear",
  y_var="Obligation.2017",
  color_var="contingencyhumanitarianpeacekeepingoperationText",
  facet_var="Theater",
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=full_labels_and_colors,
  column_key=full_column_key
)+labs(x="Fiscal Year",
       y="Percent of Obligations",
       legend.title="Operation Type")+
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))+
facet_wrap(~Theater,nrow=1)
  
# )+theme(legend.position="bottom")
  
# +facet_grid(primary ~ secondary
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")

Contradictions1B<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,Theater!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="dFYear", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1A", #VAR.y.series
  VAR.facet.primary="contingencyhumanitarianpeacekeepingoperationText", #VAR.facet.primary
  VAR.facet.secondary= "Theater", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+
  theme(legend.position="bottom")


Tree1B
Contradictions1B

ggsave600dpi("Output//Figure2_Tree1B.png", Tree1B, width=6.5, height= 3, units="in")
ggsave("Output//Figure2_Tree1B.eps", Tree1B, width=6.5, height= 3, units="in")
ggsave600dpi("Output//Tree1Bcontradictions.png", Contradictions1B, width=6.5, height= 4.5, units="in")

full_data$CrisisFunding1B<-full_data$CrisisFunding1A
full_data$CrisisFunding1B[full_data$CrisisFunding1B=="Unlabeled" & full_data$ConHumIsOCOcrisisFunding==1]<-"OCO"

summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding1A)
summary(full_data$CrisisFunding1B)



```



##Step 1C: National Action Interest Code
```{r Step1C}

summary(full_data$nationalinterestactioncodeText)

full_data %>% group_by(nationalinterestactioncodeText) %>% dplyr::summarise(Obligation.2017=sum(Obligation.2017))

Tree1CdetailIsDefense<-build_plot(
  data=subset(full_data,!nationalinterestactioncodeText %in% c("Unlabeled","None")
                     | nationalinterestactioncodeText=="Inauguration 2009"),
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="nationalinterestactioncodeText",
  y_var="Obligation.2017",
  color_var="Is.Defense",
  # facet_var="None",
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=full_labels_and_colors,
  column_key=full_column_key,
  format=TRUE
)+labs(x=NULL,
       y="Obligations (2017 $)",
       legend.title="National Interest Action")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  coord_flip()+theme(legend.position="bottom")


write.csv(subset(full_data, nationalinterestactioncodeText=="California Wildfires 2008") ,"Output//CaliforniaWildfires.csv")


#Remove the premature Californnia Wildfire 
full_data$NIAcrisisFunding[
  full_data$nationalinterestactioncodeText=="California Wildfires 2008" &
    full_data$Fiscal.Year<as.Date("2008-01-01")
]<-"Unlabeled"


#Facet by theater
Tree1Ctheater<-build_plot(
  data=subset(full_data,(!NIAcrisisFunding %in% c("Unlabeled","None")
                     | nationalinterestactioncodeText=="Inauguration 2009") &
                       Theater != "Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="nationalinterestactioncodeText",
  y_var="Obligation.2017",
  color_var="Is.Defense",
  facet_var="Theater",
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=full_labels_and_colors,
  column_key=full_column_key,
  format=TRUE
)+labs(x=NULL,
       y="Obligations (2017 $)",
       legend.title="National Interest Action")+
  scale_y_continuous(label = unit_format(unit = "B", scale = 1e-9)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  coord_flip()+theme(legend.position="bottom")+
  facet_wrap(~Theater,nrow=1)


full_data$NIAcontradictions<-full_data$NIAcrisisFunding
full_data$NIAcontradictions<-factor(full_data$NIAcontradictions,
                                    levels=c("Disaster",
                                             "OCO",
                                             "Missed OCO",
                                             "Unlabeled"
                                             )
)

full_data$NIAcontradictions[full_data$NIAcrisisFunding=="Unlabeled" & 
                              full_data$CrisisFunding1B=="OCO" ]<-"Missed OCO"
full_labels_and_colors<-prepare_labels_and_colors(full_data,na_replaced=TRUE)
full_column_key<-get_column_key(full_data)


summary(full_data$NIAcontradictions)

unique(subset(full_data,NIAcontradictions!="Unlabeled"
              & Fiscal.Year<=as.Date("2008-01-01"))$nationalinterestactioncodeText)


Tree1CisDefense<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 1B",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,NIAcontradictions!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="dFYear", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1B", #VAR.y.series
  VAR.facet.primary= "NIAcontradictions", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE,
  caption=TRUE
  
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ secondary
              , scales="fixed" #The scales actually do stay fixed
              , space="fixed")+theme(legend.position="right") +
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))
  


Tree1Coco<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="National Interest Action",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,NIAcrisisFunding=="OCO" | (CrisisFunding1B=="OCO" & nationalinterestactioncodeText %in% c("None","Unlabeled"))),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1B", #VAR.y.series
  VAR.facet.primary= "nationalinterestactioncodeText", #VAR.facet.primary
  # VAR.facet.secondary="Theater", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_wrap(~primary,ncol=3)
# +facet_grid(primary ~ secondary
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")


  #NIAcrisisFunding
Tree1Ctheater
Tree1Coco
Tree1CdetailIsDefense
Tree1CisDefense

ggsave600dpi("Output//Figure3_Tree1CdetailIsDefense.png", Tree1CdetailIsDefense, width=4, height= 6, units="in")

ggsave("Output//Figure3_Tree1CdetailIsDefense.eps", Tree1CdetailIsDefense, width=4, height= 6, units="in")

ggsave600dpi("Output//Figure4_Tree1CisDefense.png", Tree1CisDefense, width=6.5, height= 3, units="in")

ggsave("Output//Figure4_Tree1CisDefense.eps", Tree1CisDefense, width=6.5, height= 3, units="in")


ggsave600dpi("Output//Tree1Coco.png", Tree1Coco, width=6.5, height= 3, units="in")

#Apply decisions
full_data$CrisisFunding1C<-full_data$CrisisFunding1B
full_data$CrisisFunding1C[full_data$CrisisFunding1C=="Unlabeled" & full_data$NIAcrisisFunding=="OCO"]<-"OCO"
full_data$CrisisFunding1C[full_data$CrisisFunding1C=="Unlabeled" & full_data$NIAcrisisFunding=="Disaster"]<-"Disaster"



summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding1A)
summary(full_data$CrisisFunding1B)
summary(full_data$CrisisFunding1C)


```


##Step 1D: Revealing Waivers to the CCR Reporting Requirement
```{r Step1D}
# CCRexception 

Tree1DisDefense<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 1C",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,SAMexception.sum!="No Exception"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1C", #VAR.y.series
  VAR.facet.primary= "SAMexception.sum", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+theme(legend.position="bottom")

Tree1DisDefense
summary(full_data$CCRexception)

full_data %>%
       group_by(CCRexception) %>%
       dplyr::summarise(
           Obligation.2017=sum(Obligation.2017)
       )

sum(full_data$Obligation.2017[full_data$CCRexception %in% c(3,4)])
save(
     file="Output//full_data_after_step_1.Rdata")


```

Only relevant to a few million in contract obligations, skipping.

#Step 2: Iraq and Afghanistan


```{r Step2}



full_labels_and_colors<-prepare_labels_and_colors(full_data,na_replaced=TRUE)
full_column_key<-get_column_key(full_data)



Tree2isDefense<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 1C",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,Theater=="Afghanistan and Iraq"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding1C", #VAR.y.series
  VAR.facet.primary= "Is.Defense", #VAR.facet.primary
  VAR.facet.secondary="CrisisFundingTheater", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE,
  caption=TRUE,
  legend=TRUE
)+theme(legend.position="right")


# +facet_grid(primary 
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")+theme(legend.position="bottom")
# 


ggsave600dpi("Output//Figure5_Tree2.png", Tree2isDefense, width=6.5, height= 3, units="in")
ggsave("Output//Figure5_Tree2.eps", Tree2isDefense, width=6.5, height= 3, units="in")

full_data$CrisisFunding2<-full_data$CrisisFunding1C
full_data$CrisisFunding2[full_data$CrisisFunding2=="Unlabeled" & full_data$Theater=="Afghanistan and Iraq"]<-"OCO"


summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding1A)
summary(full_data$CrisisFunding1B)
summary(full_data$CrisisFunding1C)
summary(full_data$CrisisFunding2)


```

#Step 3 Multiyear procurement and R&D
```{r Step3}
# load(file="Data//full_data_after_step_2.Rdata")
full_data<-replace_nas_with_unlabeled(full_data,"UnmodifiedUltimateDurationCategory")


Tree3<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 2",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Defense Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,Customer=="Defense" &
      dFYear>=as.Date("2011-01-01")),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding2", #VAR.y.series
  VAR.facet.primary= "UnmodifiedUltimateDurationCategory", #VAR.facet.primary
  VAR.facet.secondary="IsMultipleYearProcRnD", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")
# +facet_grid(primary 
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")+theme(legend.position="bottom")
# 
Tree3
ggsave600dpi("Output//Figure6_Tree3.png", Tree3, width=4, height= 6, units="in")
full_data$CrisisFunding3<-full_data$CrisisFunding2

full_data$CrisisFunding3<-factor(full_data$CrisisFunding3,
  levels=c("OCO","Disaster","ARRA","Excluded","Unlabeled"))
full_data$CrisisFunding3[full_data$CrisisFunding3=="Unlabeled" & full_data$IsMultipleYearProcRnD==1]<-"Excluded"

summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding3)
save(
     file="Output//full_data_after_step_3.Rdata")


```

# Step 4: Does the transaction’s product or service code or transaction’s contracting office have no history of contingency contracting
##Step 4A: Does the transaction’s product or service code have no history of contingency contracting?
```{r Step4a}
# load(file="Data//full_data_after_step_3.Rdata")
full_data<-replace_nas_with_unlabeled(full_data,"UnmodifiedUltimateDurationCategory")

full_data$IsExcludedPSC<-0
full_data$IsExcludedPSC[full_data$PSCOCOcrisisScore==-1]<-1



Tree4a<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 3",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,Customer=="Defense" &
      ProductServiceOrRnDarea.sum!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding3", #VAR.y.series
  VAR.facet.primary= "IsExcludedPSC", #VAR.facet.primary
  VAR.facet.secondary="ProductServiceOrRnDarea.sum", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")+
  facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+theme(legend.position="bottom")+
    scale_x_date(
            breaks=date_breaks("5 years"),
            labels=date_format("'%y"))
# 

  Tree4a
ggsave600dpi("Output//Tree4a.png", Tree4a, width=6, height= 3.5, units="in")

full_data$CrisisFunding4A<-full_data$CrisisFunding3
full_data$CrisisFunding4A[full_data$CrisisFunding4A=="Unlabeled" & full_data$IsExcludedPSC==1]<-"Excluded"



summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding4A)


```
##Step 4B Does the transaction’s contracting office have no history of contingency contracting?
```{r Step4b}
# load(file="Data//full_data_after_step_4a.Rdata")

full_data$IsExcludedCO<-0
full_data$IsExcludedCO[full_data$OfficeOCOcrisisScore==-1]<-1


Tree4b<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 4A",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,Customer=="Defense"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding4A", #VAR.y.series
  VAR.facet.primary= "IsExcludedCO", #VAR.facet.primary
  VAR.facet.secondary="SubCustomer.detail", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")
#   facet_grid(primary ~ secondary
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")+theme(legend.position="bottom")
# # 

Tree4b
ggsave600dpi("Output//Tree4b.png", Tree4b, width=6, height= 3.5, units="in")

full_data$CrisisFunding4B<-full_data$CrisisFunding4A
full_data$CrisisFunding4B[full_data$CrisisFunding4B=="Unlabeled" & full_data$IsExcludedCO==1]<-"Excluded"


summary(full_data$DecisionTree)
summary(full_data$DecisionTreeStep4)
summary(full_data$CrisisFunding4B)

save(full_data,file="Data//full_data_after_step_4b.Rdata")


Tree5<-build_plot(
  data=subset(full_data,Theater!="Unlabeled" & full_data$IsOMBocoList==1),
  chart_geom = "Line Chart",
  share = TRUE,
  x_var="dFYear",
  y_var="Obligation.2017",
  color_var="CrisisFunding4B",
  facet_var="Theater",
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=full_labels_and_colors,
  column_key=full_column_key,
  format=TRUE
)+labs(x="Fiscal Year",
       y="Percent of Obligations",
       legend.title="Operation Type")+
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))+
facet_wrap(~Theater,nrow=1)+labs(
  y="Percent of Obligations",
  line="Classification\nAfter Step 4B"
)+theme(legend.position="bottom")

#Switch to build_plot
# Tree5<-LatticePercentLineWrapper(
  # VAR.color.legend.label="Classification\nAfter Step 4B",
  # VAR.main.label=NULL,
  # VAR.X.label="Fiscal Year",
  # VAR.Y.label="Percent of Obligations",
  # VAR.Coloration=full_labels_and_colors,
  # VAR.long.DF=subset(full_data,Theater!="Unlabeled" & full_data$IsOMBocoList==1),
  # NA, #VAR.ncol
  # VAR.x.variable="Fiscal.Year", #VAR.x.variable
  # VAR.y.variable="Obligation.2017", #VAR.y.variable
  # VAR.y.series="CrisisFunding4B", #VAR.y.series
  # VAR.facet.primary= "Theater", #VAR.facet.primary
  # VAR.facet.secondary="contingencyhumanitarianpeacekeepingoperationText", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
# )+theme(legend.position="bottom")+
#   scale_x_date(
#             # breaks=date_breaks("5 years"),
#             labels=date_format("'%y"))
  
# +facet_grid(primary ~ secondary
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")


```


#Step 5: Calculate the contracts contingency likelihood score.
##Step 5A Calculate the Funding Source Score
```{r Step5A}
# load(file="Data//full_data_after_step_4b.Rdata")
defense_data<-subset(full_data,ContractingCustomer=="Defense")
defense_data$PercentFundingAccountOCO<-as.numeric(defense_data$PercentFundingAccountOCO)
defense_data<-replace_nas_with_unlabeled(defense_data,"CrisisFunding4B")
defense_data$PercentFundingAccountOCORound1<-round(defense_data$PercentFundingAccountOCO,2)
summary(defense_data$CrisisFunding4B)
Tree5A<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 4B",
  VAR.main.label=NULL,
  VAR.X.label="Percent Funded by OCO",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(defense_data,Customer=="Defense" &
      CrisisFunding4B %in% c("OCO","Unlabeled","Excluded" ) & 
      Fiscal.Year >=2012),
  # NA, #VAR.ncol
  VAR.x.variable="PercentFundingAccountOCORound1", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding4B", #VAR.y.series
  VAR.facet.primary= "CrisisFunding4B", #VAR.facet.primary
  # VAR.facet.secondary="SubCustomer.detail", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ .
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+
  scale_x_continuous(labels = percent_format())+geom_vline(aes(xintercept=0.25))  
Tree5A
ggsave600dpi("Output//Tree5A.png", Tree5A, width=6.5, height= 3, units="in")
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012&
    defense_data$PercentFundingAccountOCORound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012],na.rm=TRUE)
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012&
    defense_data$PercentFundingAccountOCORound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012],na.rm=TRUE)
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012&
    defense_data$PercentFundingAccountOCORound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"& 
      defense_data$Fiscal.Year >=2012],na.rm=TRUE)


```


##Step 5B Calculate the Product or Service Score
```{r Step5B}



defense_data$pscOCOcrisisPercentRound1<-round(sqrt(defense_data$pscOCOcrisisPercentSqrt),2)


Tree5B<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 4B",
  VAR.main.label=NULL,
  VAR.X.label="Square Root of the Share of Product or Service Code Going to Official Contingency Contracts",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(defense_data,Customer=="Defense" &
      CrisisFunding4B %in% c("OCO","Unlabeled","Excluded")),
  # NA, #VAR.ncol
  VAR.x.variable="pscOCOcrisisPercentRound1", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding4B", #VAR.y.series
  VAR.facet.primary= "CrisisFunding4B", #VAR.facet.primary
  # VAR.facet.secondary="SubCustomer.detail", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ .
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+
  scale_x_continuous(labels = percent_format())+geom_vline(aes(xintercept=0.16))  
Tree5B
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"&
    defense_data$pscOCOcrisisPercentRound1>=0.16])/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"])
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"&
    defense_data$pscOCOcrisisPercentRound1>=0.16])/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"])
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"&
    defense_data$pscOCOcrisisPercentRound1>=0.16],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"],na.rm=TRUE)

sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"&
    defense_data$pscOCOcrisisPercentRound1>=0.25])/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"])


ggsave600dpi("Output//Tree5B.png", Tree5B, width=6.5, height= 3, units="in",dpi=600)


```



##Step 5C Calculate the Customer Score
```{r Step5C}
defense_data$OfficeOCOcrisisPercent<-as.numeric(defense_data$OfficeOCOcrisisPercent)

defense_data$OfficeOCOcrisisPercentRound1<-defense_data$OfficeOCOcrisisPercent
defense_data$OfficeOCOcrisisPercentRound1[
  defense_data$OfficeOCOcrisisPercentRound1<0]<-0
defense_data$OfficeOCOcrisisPercentRound1<-round(sqrt(defense_data$OfficeOCOcrisisPercentSqrt),2)

Tree5C<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Classification\nAfter Step 4C",
  VAR.main.label=NULL,
  VAR.X.label="Square Root of the Share of Office Obligations Going to Official Contingency Contracts",
  VAR.Y.label="Obligations (2017 $)",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(defense_data,Customer=="Defense" &
      CrisisFunding4B %in% c("OCO","Unlabeled","Excluded")),
  # NA, #VAR.ncol
  VAR.x.variable="OfficeOCOcrisisPercentRound1", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisFunding4B", #VAR.y.series
  VAR.facet.primary= "CrisisFunding4B", #VAR.facet.primary
  # VAR.facet.secondary="SubCustomer.detail", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+facet_grid(primary ~ .
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+
  scale_x_continuous(labels = percent_format())+geom_vline(aes(xintercept=0.25))  
Tree5C
ggsave("Output//Tree5C.png", Tree5C, width=6.5, height= 3, units="in",dpi=600)
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"& 
    defense_data$OfficeOCOcrisisPercentRound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="OCO"&
      defense_data$Customer=="Defense"],na.rm=TRUE)
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"&
    defense_data$OfficeOCOcrisisPercentRound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Excluded"&
      defense_data$Customer=="Defense"],na.rm=TRUE)
sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"&
    defense_data$OfficeOCOcrisisPercentRound1>=0.25],na.rm=TRUE)/
  sum(defense_data$Obligation.2017[defense_data$CrisisFunding4B=="Unlabeled"&
      defense_data$Customer=="Defense"],na.rm=TRUE)

```


#Step 6 Adding up the points
```{r Step1B}
full_data<-replace_nas_with_unlabeled(full_data,"DecisionTree")
full_data$CrisisPoints<-as.character(full_data$CrisisFunding4B)
full_data$CrisisPoints[(full_data$pscOCOcrisisPoint+
    full_data$OfficeOCOcrisisPoint+
    full_data$FundingAccountOCOpoint)==1 &
    full_data$CrisisPoints=="Unlabeled"]<-"1 point"
full_data$CrisisPoints[(full_data$pscOCOcrisisPoint+
    full_data$OfficeOCOcrisisPoint+
    full_data$FundingAccountOCOpoint)==2 &
    full_data$CrisisPoints=="Unlabeled"]<-"2 points"
full_data$CrisisPoints[(full_data$pscOCOcrisisPoint+
    full_data$OfficeOCOcrisisPoint+
    full_data$FundingAccountOCOpoint)==3 &
    full_data$CrisisPoints=="Unlabeled"]<-"3 points"
full_data$CrisisPoints[full_data$CrisisPoints %in%
    c("ARRA","Excluded","Unlabeled","Disaster"
  )]<-"All Non-OCO"



full_data$OMBtheater<-as.character(full_data$Theater)
full_data$OMBtheater[full_data$IsOMBocoList==1 & 
    full_data$OMBtheater!="Afghanistan and Iraq"]<-"Other OMB OCO list"
full_data$OMBtheater<-factor(full_data$OMBtheater)
# ConHumIsOCOcrisisFunding=1
# ,[ContingencyHumanitarianPeacekeepingOperation]


Tree6percent<-LatticePercentLineWrapper(
  VAR.color.legend.label="Classification\nAfter Step 5",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,!Theater %in% c("Unlabeled")),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisPoints", #VAR.y.series
  VAR.facet.primary= "OMBtheater", #VAR.facet.primary
  # VAR.facet.secondary="contingencyhumanitarianpeacekeepingoperationText", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")+
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))+geom_line(size=1)
# +facet_grid(primary ~ secondary
#               , scales="free_y" #The scales actually do stay fixed
#               , space="fixed")

Tree6final<-LatticePlotWrapper_csis360(
  VAR.color.legend.label="Final Classification",
  VAR.main.label=NULL,
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligations",
  VAR.Coloration=full_labels_and_colors,
  VAR.long.DF=subset(full_data,!Theater %in% c("Unlabeled") &
      CrisisPoints %in% c("OCO","1 point", "2 points", "3 points")),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2017", #VAR.y.variable
  VAR.y.series="CrisisPoints", #VAR.y.series
  VAR.facet.primary= "OMBtheater", #VAR.facet.primary
  VAR.facet.secondary="DecisionTree", # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")+
  scale_x_date(
            # breaks=date_breaks("5 years"),
            labels=date_format("'%y"))+facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="free_y")


Tree6final
# csis360::get_column_key(full_data)
Tree6percent<-Tree6percent+geom_line(size=1)


ggsave("Output//Tree6percent.png", Tree6percent, width=6.5, height= 3.5, units="in",dpi=600)
ggsave("Output//Tree6final.png", Tree6final, width=4, height= 7.5, units="in",dpi=600)

full_data$CrisisFunding[full_data$CrisisFunding=="Unlabeled" & full_data$DecisionTree=="OCO"]<-"OCO"
save(full_data,file="Data//full_data_after_step_6.Rdata")

#Examining the data
```

