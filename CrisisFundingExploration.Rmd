---
title: "Crisis Funding Exploration"
author: "Greg Sanders"
date: "March 28, 2017"
output: html_document
---


```{r setup, include=FALSE}

library(plyr)
library(dplyr)
library(reshape2)
library(diigtheme1)
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))

diigtheme1:::diiggraph()

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


##Import Data
```{r Import}
# read in data    
ZipFile<-unz(file.path("Data","Defense_budget_SP_LocationVendorCrisisFundingHistoryBucketCustomer.zip"),
             "Defense_budget_SP_LocationVendorCrisisFundingHistoryBucketCustomer.csv")
FullData <- read.csv(ZipFile,
                     na.strings="NULL")
rm(ZipFile)

FullData<-apply_lookups(Path,FullData)
FullData<-subset(FullData, year(Fiscal.Year)>=2000)


# PSC data
ZipFile<-unz(file.path("Data","Budget.SP_CrisisFundingExploration_ProductOrServiceCode.zip"),
             "Budget.SP_CrisisFundingExploration_ProductOrServiceCode.csv")
PSCdata <- read.csv(ZipFile,
                     na.strings="NULL")
rm(ZipFile)

PSCdata<-apply_lookups(Path,PSCdata)
PSCdata<-subset(PSCdata, year(Fiscal.Year)>=2000)

#Countracting Office
ZipFile<-unz(file.path("Data","Budget.SP_CrisisFundingExploration_ContractingOfficeID.zip"),
             "Budget.SP_CrisisFundingExploration_ContractingOfficeID.csv")
OfficeData <- read.csv(ZipFile,
                     na.strings="NULL")

OfficeData<-apply_lookups(Path,OfficeData)
OfficeData<-subset(OfficeData, year(Fiscal.Year)>=2000)


```

## Including Plots

You can also embed plots, for example:

#NIA
```{r NIA, echo=FALSE}




NIAdata<-ddply(FullData,.(Fiscal.Year,
                 ContractingCustomer,
                 nationalinterestactioncodeText,
                 NIAcrisisFunding,
                 CrisisFunding
                 ),
               plyr::summarise,
               Obligation.2015=sum(Obligation.2015))

NIAcrisisData<-subset(NIAdata,!is.na(NIAcrisisFunding))

ggplot(ddply(NIAcrisisData,.(Fiscal.Year,
                 ContractingCustomer,
                 NIAcrisisFunding
                 ),
               plyr::summarise,
               Obligation.2015=sum(Obligation.2015)),
       aes(y=Obligation.2015,
            x=Fiscal.Year,
            color=ContractingCustomer,
           group=ContractingCustomer))+geom_line()+facet_wrap( ~ NIAcrisisFunding)


ggplot(ddply(NIAcrisisData,.(Fiscal.Year,
                 ContractingCustomer,
                 nationalinterestactioncodeText
                 ),
               plyr::summarise,
               Obligation.2015=sum(Obligation.2015)),
       aes(y=Obligation.2015,
            x=Fiscal.Year,
            color=ContractingCustomer,
           group=ContractingCustomer))+geom_line()+facet_wrap( ~ nationalinterestactioncodeText)


write.csv(ddply(NIAcrisisData,.(
                 NIAcrisisFunding,
                 nationalinterestactioncodeText
                 ),
               plyr::summarise,
               Obligation.2015=sum(Obligation.2015),
               MinOfFiscalYear=min(Fiscal.Year),
               MaxOfFiscalYear=max(Fiscal.Year))
          ,file.path("Output","nationalinterestactioncodeSummary.csv"))


write.csv(dcast(ddply(FullData,.(
                PlaceCountryText,
                 nationalinterestactioncodeText
                 ),
               plyr::summarise,
               Obligation.2015=sum(Obligation.2015),
               MinOfFiscalYear=min(Fiscal.Year),
               MaxOfFiscalYear=max(Fiscal.Year))
            ,"PlaceCountryText ~ nationalinterestactioncodeText"
            ,value.var="Obligation.2015")
          ,file.path("Output","nationalinterestactioncodeCountry.csv"))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


##PSC
```{r PSC}

PSCdata$OCOobligation.2015<-0
PSCdata$OCOobligation.2015[PSCdata$IsOCOcrisisFunding==1 & !is.na(PSCdata$IsOCOcrisisFunding)]<-
  PSCdata$Obligation.2015[PSCdata$IsOCOcrisisFunding==1 & !is.na(PSCdata$IsOCOcrisisFunding)]

if(is.Date(PSCdata$Fiscal.Year)) PSCdata$Fiscal.Year<-year(PSCdata$Fiscal.Year)

PSCdata$OCOfiscalYear<-NA
PSCdata$OCOfiscalYear[PSCdata$IsOCOcrisisFunding==1 & !is.na(PSCdata$IsOCOcrisisFunding)]<-
  PSCdata$Fiscal.Year[PSCdata$IsOCOcrisisFunding==1 & !is.na(PSCdata$IsOCOcrisisFunding)]


PSCscore<-ddply(PSCdata,
                .(ProductOrServiceArea,
                  ProductOrServiceCode,
                  ProductOrServiceCodeText),
                plyr::summarise,
                Total=sum(Obligation.2015),
                OCO=sum(OCOobligation.2015),
                MinOfTotalFiscalYear=min(Fiscal.Year,na.rm=TRUE),
                MaxOfTotalFiscalYear=max(Fiscal.Year,na.rm=TRUE),
                MinOfOCOfiscalYear= suppressWarnings(min(OCOfiscalYear,na.rm=TRUE)),
                MaxOfOCOfiscalYear=suppressWarnings(max(OCOfiscalYear,na.rm=TRUE))
                )
PSCscore$MinOfOCOfiscalYear[is.infinite(PSCscore$MinOfOCOfiscalYear)]<-NA
PSCscore$MaxOfOCOfiscalYear[is.infinite(PSCscore$MaxOfOCOfiscalYear)]<-NA
PSCscore$OCOrate<-PSCscore$OCO/PSCscore$Total

write.csv(PSCscore,file.path("Output","PSC_OCObreakdown.csv"))

RateCutoffHigh<-0.25
RateCutoffLow<-0.1
BillionsCutoff<-1



#All Thresholds are met
PSCupdates<-UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',3,
                  PSCscore$ProductOrServiceCode[PSCscore$OCOrate>=RateCutoffHigh & PSCscore$OCO>=BillionsCutoff])

#HighRate Cutoff alone is met
PSCupdates<-rbind(PSCupdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',2,
                  PSCscore$ProductOrServiceCode[PSCscore$OCOrate>=RateCutoffHigh & PSCscore$OCO<BillionsCutoff])
)

#Low Rate Cutoff alone is met along with billions cutoff
PSCupdates<-rbind(PSCupdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',2,
                  PSCscore$ProductOrServiceCode[PSCscore$OCOrate>=RateCutoffLow & PSCscore$OCOrate<RateCutoffHigh &
                                                PSCscore$OCO>=BillionsCutoff])
)

#Low Rate Cutoff exclusive or billions cutoff is met
PSCupdates<-rbind(PSCupdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',1,
                  PSCscore$ProductOrServiceCode[xor(PSCscore$OCOrate>=RateCutoffLow,PSCscore$OCO>=BillionsCutoff)&
                                                  PSCscore$OCOrate<RateCutoffHigh 
                                                ])
)

#Negative score for PSCcodes with no OCO spending and significant $s
PSCupdates<-rbind(PSCupdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',-1,
                  PSCscore$ProductOrServiceCode[PSCscore$OCOrate==0 & PSCscore$Total>=BillionsCutoff
                                                ])
)


#No criteria, goosd or bad, met
PSCupdates<-rbind(PSCupdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',0,
                  PSCscore$ProductOrServiceCode[PSCscore$OCOrate<RateCutoffLow & PSCscore$OCO<BillionsCutoff
                                                & (PSCscore$OCOrate>0 | PSCscore$Total<BillionsCutoff)
                                                ])
)

write(PSCupdates,file.path("Output","PSCupdateList.txt"))


```



##Office
```{r PSC}

OfficeData$OCOobligation.2015<-0
OfficeData$OCOobligation.2015[OfficeData$IsOCOcrisisFunding==1 & !is.na(OfficeData$IsOCOcrisisFunding)]<-
  OfficeData$Obligation.2015[OfficeData$IsOCOcrisisFunding==1 & !is.na(OfficeData$IsOCOcrisisFunding)]

if(is.Date(OfficeData$Fiscal.Year)) OfficeData$Fiscal.Year<-year(OfficeData$Fiscal.Year)

OfficeData$OCOfiscalYear<-NA
OfficeData$OCOfiscalYear[OfficeData$IsOCOcrisisFunding==1 & !is.na(OfficeData$IsOCOcrisisFunding)]<-
  OfficeData$Fiscal.Year[OfficeData$IsOCOcrisisFunding==1 & !is.na(OfficeData$IsOCOcrisisFunding)]


OfficeScore<-ddply(OfficeData,
                .(ContractingCustomer,
                  ContractingSubCustomer,
                  Contracting.Agency.ID,
                  MajorCommandCode,
                  MajorCommandName,
                  ContractingOfficeID,
                  ContractingOfficeCode,
                  ContractingOfficeName),
                plyr::summarise,
                Total=sum(Obligation.2015),
                OCO=sum(OCOobligation.2015),
                MinOfTotalFiscalYear=min(Fiscal.Year,na.rm=TRUE),
                MaxOfTotalFiscalYear=max(Fiscal.Year,na.rm=TRUE),
                MinOfOCOfiscalYear= suppressWarnings(min(OCOfiscalYear,na.rm=TRUE)),
                MaxOfOCOfiscalYear=suppressWarnings(max(OCOfiscalYear,na.rm=TRUE))
                )
OfficeScore$MinOfOCOfiscalYear[is.infinite(OfficeScore$MinOfOCOfiscalYear)]<-NA
OfficeScore$MaxOfOCOfiscalYear[is.infinite(OfficeScore$MaxOfOCOfiscalYear)]<-NA
OfficeScore$OCOrate<-OfficeScore$OCO/OfficeScore$Total

write.csv(OfficeScore,file.path("Output","Office_OCObreakdown.csv"))

RateCutoffHigh<-0.25
RateCutoffLow<-0.1
BillionsCutoff<-1



#All Thresholds are met
OfficeUpdates<-UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',3,
                  OfficeScore$ProductOrServiceCode[OfficeScore$OCOrate>=RateCutoffHigh & OfficeScore$OCO>=BillionsCutoff])

#HighRate Cutoff alone is met
OfficeUpdates<-rbind(OfficeUpdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',2,
                  OfficeScore$ProductOrServiceCode[OfficeScore$OCOrate>=RateCutoffHigh & OfficeScore$OCO<BillionsCutoff])
)

#Low Rate Cutoff alone is met along with billions cutoff
OfficeUpdates<-rbind(OfficeUpdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',2,
                  OfficeScore$ProductOrServiceCode[OfficeScore$OCOrate>=RateCutoffLow & OfficeScore$OCOrate<RateCutoffHigh &
                                                OfficeScore$OCO>=BillionsCutoff])
)

#Low Rate Cutoff exclusive or billions cutoff is met
OfficeUpdates<-rbind(OfficeUpdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',1,
                  OfficeScore$ProductOrServiceCode[xor(OfficeScore$OCOrate>=RateCutoffLow,OfficeScore$OCO>=BillionsCutoff)&
                                                  OfficeScore$OCOrate<RateCutoffHigh 
                                                ])
)

#Negative score for Officecodes with no OCO spending and significant $s
OfficeUpdates<-rbind(OfficeUpdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',-1,
                  OfficeScore$ProductOrServiceCode[OfficeScore$OCOrate==0 & OfficeScore$Total>=BillionsCutoff
                                                ])
)


#No criteria, goosd or bad, met
OfficeUpdates<-rbind(OfficeUpdates,UpdateLookupTable('FPDStypeTable','ProductOrServiceCode','OCOcrisisScore',0,
                  OfficeScore$ProductOrServiceCode[OfficeScore$OCOrate<RateCutoffLow & OfficeScore$OCO<BillionsCutoff
                                                & (OfficeScore$OCOrate>0 | OfficeScore$Total<BillionsCutoff)
                                                ])
)

write(OfficeUpdates,file.path("Output","OfficeUpdateList.txt"))


```