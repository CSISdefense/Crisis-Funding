---
title: "Crisis Funding Exploration"
author: "Greg Sanders"
date: "March 28, 2017"
output:
  html_document: 
    keep_md: yes
  pdf_document: default
---

#Setup
```{r setup, include=FALSE}

library(plyr)
library(dplyr)
library(reshape2)
library(Hmisc)
library(csis360)

Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
# Path<-"C:\\Users\\gsand_000.ALPHONSE\\Documents\\Development\\R-scripts-and-data\\"
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))

# diigtheme1:::diiggraph()

Coloration<-read.csv(
    paste(Path,"Lookups\\","lookup_coloration.csv",sep=""),
    header=TRUE, sep=",", na.strings="", dec=".", strip.white=TRUE, 
    stringsAsFactors=FALSE
    )

Coloration<-ddply(Coloration
                  , c(.(R), .(G), .(B))
                  , transform
                  , ColorRGB=as.character(
                      if(min(is.na(c(R,G,B)))) {NA} 
                      else {rgb(max(R),max(G),max(B),max=255)}
                      )
                  )


axis.text.size<-12
strip.text.size<-12
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-2
note.text.size<-1.40


```


##Import Data
```{r Import}
# read in data    

oad(file="LargeDataSets//full_data_after_step_4b.Rdata")
full_data$CrisisDisplay<-as.character(full_data$CrisisFunding)
full_data$CrisisDisplay[full_data$CrisisDisplay  %in% c("Unlabeled","Excluded")]<-"All Other"

full_data$Reachback<-cut2(full_data$OfficeOCOcrisisScore,c(2))

full_data$Reachback<-factor(full_data$Reachback,levels=c( "[ 2, 3]","[-1, 2)"), 
                                   labels=c( "Contigency-Contracting-Intensive Contracting Offices","All Other Offices"))
```

#Analysis



```{r Summary}


OCOdetail<-LatticePlotWrapper(
  VAR.color.legend.label="Crisis Category",
  VAR.main.label="Defense Contracts with Labeled Location",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligations (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,!is.na(International)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="Is.Defense", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="International" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+  facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+theme(legend.position="bottom")
OCOdetail
ggsave("Output//AnalysisTopline.png", OCOdetail, width=6.5, height= 4, units="in",dpi=300)

```


```{r Competition}

Comp1<-  LatticePercentLineWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,
                     SupplyServiceERS!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))

ggsave("Output//Comp1.png", OCOdetail, width=6.5, height= 4, units="in",dpi=300)

Comp2<-  LatticePercentLineWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=full_data,
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))


Comp3<-  LatticePlotWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=full_data,
  # NA, #VAR.ncol
  VAR.x.variable="No.Competition.sum", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  ,DataLabels=TRUE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+  facet_grid(primary ~ secondary
              , scales="free_y" #The scales actually do stay fixed
              , space="fixed")+theme(legend.position="bottom")
    # scale_x_date("Fiscal Year",labels = date_format("'%y"))+
 Comp3<-Comp3+ theme(axis.text.x = element_text(angle=270))


ggsave("Output//Comp2.png", Comp2, width=6.5, height= 4, units="in",dpi=300)

ggsave("Output//Comp3.png", Comp3, width=6.5, height= 4, units="in",dpi=300)

full_data$isUCA<-factor(full_data$isUndefinitizedAction,levels=c(1,0,NA),labels=c("UCA","Not UCA"))
full_data$isUCA<-factor(full_data$isUCA,levels=c("UCA","Not UCA","Unlabeled"))
full_data$isUCA[is.na(full_data$isUCA)]<-"Unlabeled"
UCA<-LatticePercentLineWrapper(
  VAR.color.legend.label="Is Undefinitized Contract Action (UCA)",
  VAR.main.label="Defense Contracts with Labeled Cector",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=full_data,
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="isUCA", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="Is.Defense" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))


ggsave("Output//UCA.png", UCA, width=6.5, height= 4, units="in",dpi=300)


```

##Labeling
```{r Labeling}

full_data$OCOlabelDetail<-full_data$OCOscoreBuckets
levels(full_data$OCOlabelDetail) <- 
  c(levels(full_data$OCOlabelDetail),"Confirmed OCO")
full_data$OCOlabelDetail[full_data$CrisisFunding=="OCO"]<-"Confirmed OCO"


full_data$CrisisDisplay<-"All Other"
full_data$CrisisDisplay[full_data$CrisisFunding=="OCO"|full_data$OCOcrisisScore>=6]<-"Confident OCO"



Dollars<-ddply(full_data,
                .(
                  Fiscal.Year,
                  OCOlabelDetail,
                  CrisisDisplay
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )



LatticePlotWrapper(
  VAR.color.legend.label="OCO labeling detail",
  VAR.main.label="All Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=Dollars,
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="OCOlabelDetail", #VAR.y.series
  VAR.facet.primary="CrisisDisplay" #VAR.facet.primary
  # VAR.facet.secondary= NULL # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")



DollarsTheater<-ddply(full_data,
                .(
                  Fiscal.Year,
                  OCOlabelDetail,
                  CrisisDisplay,
                  Theater
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )


full_data[full_data$PlaceCountryText %in% c("Jordan","Turkey"),]



LatticePlotWrapper(
  VAR.color.legend.label="OCO labeling detail",
  VAR.main.label="Defense Contracts with Labeled Theater",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(DollarsTheater,!is.na(Theater)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="OCOlabelDetail", #VAR.y.series
  VAR.facet.primary="Theater", #VAR.facet.primary
  VAR.facet.secondary="CrisisDisplay" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="right")


DollarsInternational<-ddply(full_data,
                .(
                  Fiscal.Year,
                  OCOlabelDetail,
                  CrisisDisplay,
                  International
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )


full_data[full_data$PlaceCountryText %in% c("Jordan","Turkey"),]




OCOdetail<-LatticePlotWrapper(
  VAR.color.legend.label="OCO labeling detail",
  VAR.main.label="Defense Contracts with Labeled Location",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(DollarsInternational,!is.na(International)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="OCOlabelDetail", #VAR.y.series
  VAR.facet.primary="International", #VAR.facet.primary
  VAR.facet.secondary="CrisisDisplay" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)

OCOdetail+theme(legend.position="right")

```


##Country
```{r Country}

Country<-ddply(full_data,
                .(Fiscal.Year,
                  CrisisDisplay,
                  PlaceCountryText,
                  Theater
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

write.csv(Country,file.path("Output","Country.csv"))


LatticePlotWrapper(
  VAR.color.legend.label="OCO labeling detail",
  VAR.main.label="All Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=Dollars,
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="OCOlabelDetail", #VAR.y.series
  VAR.facet.primary="CrisisDisplay" #VAR.facet.primary
  # VAR.facet.secondary= NULL # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  ,DataLabels=FALSE
  #                       ,VAR.override.coloration=NA
)+theme(legend.position="bottom")



OCOdetailZoom<-LatticePlotWrapper(
  VAR.color.legend.label="OCO labeling detail",
  VAR.main.label="Confident OCO or International Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(DollarsInternational,
                     (CrisisDisplay=="Confident OCO" | 
                       International=="International") & 
                       !is.na(International)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="OCOlabelDetail", #VAR.y.series
  VAR.facet.primary="International", #VAR.facet.primary
  VAR.facet.secondary="CrisisDisplay" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)

OCOdetailZoom+theme(legend.position="bottom")

```


##Competition
```{r Competition}
full_data$No.Competition.sum<-ordered(
  full_data$No.Competition.sum,
  c("2+ Offers","1 Offer", 
    "No Comp. (Only 1 Source)",
    "Follow on to Competed Action",
    "No Comp. (Other)",
    "No Comp. (Unlabeled)"    ,
    "Unlabeled"
                                                        ))



#Competition and Simple Area
CompetitionSupplyServiceERS<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  No.Competition.sum,
                  SupplyServiceERS
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

CompetitionSupplyServiceERS<-ddply(CompetitionSupplyServiceERS,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  SupplyServiceERS
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )




  LatticePercentLineWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,
                     SupplyServiceERS!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))



LatticePlotWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="Confident OCO and Labeled Product or Service Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(CompetitionSupplyServiceERS,
                     SupplyServiceERS!="Unlabeled"&
                       CrisisDisplay=="Confident OCO"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")





#Competition and Duration
CompetitionDuration<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  UnmodifiedUltimateDurationCategory,
                  Competition.sum
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

CompetitionDuration<-ddply(CompetitionDuration,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  UnmodifiedUltimateDurationCategory
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )



#Breakdown by number of offers
LatticePlotWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="Confident OCO and Labeled Duration Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,
                     !is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
   facet_grid(  primary~ secondary,scales="free_y")

  LatticePercentLineWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(CompetitionDuration,
                     !is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))



#Breakdown by reason not competed 
LatticePlotWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="Confident OCO and Labeled Duration Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,
                     !is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
   facet_grid(  primary~ secondary,scales="free_y")

  LatticePercentLineWrapper(
  VAR.color.legend.label="Competition",
  VAR.main.label="",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(full_data,
                     !is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))



#Breakdown by reason not competed 
#Start Fiscal Year 
```


##Undefinitized Contract Actions
```{r UCA}
# full_data$isUCA<-"Not UCA"
# full_data$isUCA[full_data$isUndefinitizedAction==1]
# full_data$isUndefinitizedAction[is.na(full_data$isUndefinitizedAction)]<-"Not UCA"
full_data$isUCA<-factor(full_data$isUndefinitizedAction,levels=c(1,0,NA),labels=c("UCA","Not UCA"))

full_data$isUCA<-addNA(full_data$isUCA,ifany=TRUE)
levels(full_data$isUCA)[is.na(levels(full_data$isUCA))] <- "Unlabeled"
unique(full_data$isUndefinitizedAction)

#UCA and Simple Area
UCASupplyServiceERS<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  isUCA,
                  SupplyServiceERS
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

UCASupplyServiceERS<-ddply(UCASupplyServiceERS,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  SupplyServiceERS
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )


# UCASupplyServiceERS$Graph<-TRUE
# UCASupplyServiceERS$Graph[UCASupplyServiceERS$isUCA=='Not UCA']<-FALSE

LatticePercentLineWrapper(
  VAR.color.legend.label="Is Undefinitized Contract Action (UCA)",
  VAR.main.label="Defense Contracts with Labeled Cector",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(UCASupplyServiceERS,SupplyServiceERS!="Unlabeled"),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="isUCA", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="SupplyServiceERS" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))



#UCA and Duration
UCADuration<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  UnmodifiedUltimateDurationCategory,
                  isUCA
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

UCADuration<-ddply(UCADuration,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  UnmodifiedUltimateDurationCategory
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )

LatticePercentLineWrapper(
  VAR.color.legend.label="Is Undefinitized Contract Action (UCA)",
  VAR.main.label="Defense Contracts with Labeled Cector",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(UCADuration,!is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="isUCA", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))



#Breakdown by reason not competed 
LatticePlotWrapper(
  VAR.color.legend.label="Undefinitized Contract Action (UCA)",
  VAR.main.label="Labeled UCA Status and Duration Defense Contracts",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Obligation (2016 $ Billions)",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(UCADuration,
                     !is.na(UnmodifiedUltimateDurationCategory)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="isUCA", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="UnmodifiedUltimateDurationCategory" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
   facet_grid(  primary~ secondary,scales="free_y")


```


##Reachback
```{r Reachback}


#Competition and Reachback
CompetitionReachback<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  Reachback,
                  No.Competition.sum
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

CompetitionReachback<-ddply(CompetitionReachback,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  Reachback
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )


LatticePercentLineWrapper(
  VAR.color.legend.label="Is Undefinitized Contract Action (UCA)",
  VAR.main.label="Defense Contracts with Labeled Reachback",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(CompetitionReachback,!is.na(Reachback)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="No.Competition.sum", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="Reachback" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))


#UCA and Reachback
UCAReachback<-ddply(full_data,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  Reachback,
                  isUCA
                  ),
                plyr::summarise,
                Obligation.2016=sum(Obligation.2016)
                )

UCAReachback<-ddply(UCAReachback,
                .(
                  Fiscal.Year,
                  CrisisDisplay,
                  Reachback
                  ),
                plyr::mutate,
                pObligation=Obligation.2016/sum(Obligation.2016)
                )


LatticePercentLineWrapper(
  VAR.color.legend.label="Is Undefinitized Contract Action (UCA)",
  VAR.main.label="Defense Contracts with Labeled Reachback",
  VAR.X.label="Fiscal Year",
  VAR.Y.label="Percent of Obligation.2016",
  VAR.Coloration=Coloration,
  VAR.long.DF=subset(UCAReachback,!is.na(Reachback)),
  # NA, #VAR.ncol
  VAR.x.variable="Fiscal.Year", #VAR.x.variable
  VAR.y.variable="Obligation.2016", #VAR.y.variable
  VAR.y.series="isUCA", #VAR.y.series
  VAR.facet.primary="CrisisDisplay", #VAR.facet.primary
  VAR.facet.secondary="Reachback" # VAR.facet.secondary=NA
  # ,MovingAverage=0
  # ,MovingSides=1
  # ,DataLabels=NA
  #                       ,VAR.override.coloration=NA
)+theme(legend.position = "bottom")+
    scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(strip.text.y = element_text(angle=270))

```
#Output to Shiny
```{r Output }

full_data<-replace_nas_with_unlabeled(full_data,"UnmodifiedUltimateDurationCategory")
full_data<-replace_nas_with_unlabeled(full_data,"isUndefinitizedAction")
full_data<-replace_nas_with_unlabeled(full_data,"Theater")
full_data<-replace_nas_with_unlabeled(full_data,"International")

full_data<-replace_nas_with_unlabeled(full_data,"Reachback")


labels_and_colors<-prepare_labels_and_colors(full_data)


column_key<-csis360::get_column_key(full_data)

save(labels_and_colors,column_key,full_data,file="Shiny/Crisis_Funding.RData")
```
