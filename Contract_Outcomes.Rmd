---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2117"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(arm)
library(R2WinBUGS)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

## Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  


##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
  load(file="Data/Federal_contract_CSIScontractID_detail.Rdata")

head(fed)
# undebug(transform_contract)
fed<-csis360::transform_contract(fed)

 #b_CBre
summary(fed$b_Urg)
fed$b_Urg<-NA
  fed$b_Urg<-ifelse(fed$Urg=="Urgency Except.",1,NA)
  fed$b_Urg[fed$Urg=="Not Urgency"]<-0

  fed$Crisis<-as.character(fed$MaxOfDecisionTree)
fed$Crisis[fed$Crisis=="Excluded" | is.na(fed$Crisis)]<-"Other"
fed$Crisis<-factor(fed$Crisis)
summary(fed$Crisis)

# fed<-decision_tree(fed)


```



* b_CBre is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(fed$b_CBre)
NA_stats(fed,"b_CBre")')
* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(fed$b_Comp);
NA_stats(fed,"b_Comp")'
* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(fed$EffComp);
NA_stats(fed,"n_Comp")' 
* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(fed$n_Offr);
NA_stats(fed,"n_Offr")' 

* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(fed$Urg);
NA_stats(fed,"b_Urg")' 
* l_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(fed$l_Offr)
NA_stats(fed,"l_Offr")'
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(fed$l_Ceil,"dollars")
NA_stats(fed,"l_Ceil")'
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(fed$l_Days,"days");
NA_stats(fed,"l_Days")' 
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(fed$SIDV);
summary(fed$MIDV);
summary(fed$FSSGWAC);
summary(fed$BPABOA);
NA_stats(fed,"Veh")'
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(fed$n_Fixed);
NA_stats(fed,"n_Fixed")')
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. ('r summary(fed$n_Incent);
NA_stats(fed,"n_Incent")')
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(fed$b_UCA);
NA_stats(fed,"b_UCA")'
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(fed$b_Intl);
NA_stats(fed,"b_Intl")'


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.


Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

###Computational Sample Creation
```{r Sample}

crisis<-fed[fed$Crisis %in% c("ARRA","Disaster"),]
oco<-fed[fed$Crisis %in% c("OCO"),]
oco<-oco[sample(nrow(oco),100000),]
crisis<-rbind(crisis,oco)
rm(oco)
other<-fed[fed$Crisis %in% c("Other"),]
other<-other[sample(nrow(other),100000),]
crisis<-rbind(crisis,other)
rm(other)
# summary(crisis$b_Comp )
# summary(crisis$n_Comp )
# summary(crisis$Comp )
# summary(crisis$CompOffr )
# summary(crisis$EffComp )

complete<-!is.na(crisis$b_Term)&
  !is.na(crisis$b_CBre)&
  !is.na(crisis$b_Comp)&
  !is.na(crisis$b_Urg)&
  !is.na(crisis$l_Ceil)&
  !is.na(crisis$l_Days)&
  !is.na(crisis$Veh) &
  !is.na(crisis$n_Fixed)&
  !is.na(crisis$b_Intl)&
  !is.na(crisis$b_UCA)&
  !is.na(crisis$ProdServ)&
  !is.na(crisis$ARRA)&
!is.na(crisis$Dis)&
!is.na(crisis$OCO)
  # !is.na(crisis$cl_HHI_lag1)

summary(crisis$Crisis)

# crisis<-crisis[complete,]


#8818392  to 8818392
nrow(crisis[!complete,])/nrow(crisis)
sum(crisis[!complete,]$Action.Obligation,na.rm=TRUE)/sum(crisis$Action.Obligation,na.rm=TRUE)

crisis_smp<-crisis[complete,]

head(crisis_smp)

```

The sample is created by including the entirity of the ARRA and Disaster datasets, as well as 100,000 records each from the OCO datase and another 100,000 from all remaining records.

#Initial Logit Model

##Crisis Dataset
### Model 01A Crisis Dataset
```{r Model01A}
levels(crisis_smp$MaxOfDecisionTree)[levels(crisis_smp$MaxOfDecisionTree)=="Excluded"]<-
  "None"
crisis_smp$MaxOfDecisionTree[is.na(crisis_smp$MaxOfDecisionTree)]<-"None"
#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"MaxOfDecisionTree")

#Percent Terminated Plot
discrete_percent_cbre_plot(crisis_smp,"MaxOfDecisionTree")

#Model
CBre_11A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO, family=binomial(link="logit"))
display(CBre_11A)



```
In line with literature, crisis contracting is higher risk than conventional contracting, with all three datasets having a termination rate well above the termination rate for the remaining contracts. OCO is closest to that typical rate.

## Competition Variables

Competition has the potential to reduce terminations by giving the government more options in vendors and encouraging better behavior from the contractor that was chosen. 
###Model 02A: No Competition / Competition
```{r Model02A}

#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"Comp"),
                        discrete_percent_term_plot(crisis_smp,"Comp"))

gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"Urg"),
                        discrete_percent_term_plot(crisis_smp,"Urg"))


#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"Comp"),
             discrete_percent_cbre_plot(crisis_smp,"Comp"))

gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"Urg"),
             discrete_percent_cbre_plot(crisis_smp,"Urg"))



#Model
CBre_02A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cb_Comp, family=binomial(link="logit"))
display(CBre_02A)

Term_02A <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cb_Comp, family=binomial(link="logit"))
display(Term_02A)


stargazer::stargazer(CBre_02A,Term_02A,type="text",
                     digits=2)


#Plot the fitted values vs actual results
gridExtra::grid.arrange(binned_fitted_versus_cbre_residuals(CBre_02A),
                        binned_fitted_versus_term_residuals(Term_02A)
                        )

# residuals_cbre_plot(CBre_02A)+
  # labs(x="Estimated  Pr (Ceiling Breach)"),
# residuals_cbre_plot(Term_02A)+
  # labs(x="Estimated  Pr (Termination)"),


#Plot residuals versus fitted
# residuals_cbre_plot(CBre_03B)+
  # labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_03B,"cl_Ceil")+
  # labs(x="Centered Log(Ceiling)")
  

```
Binary competition is associated with a significantly decreased risk of ceiling breaches but a slightly greater risk of terminations. Urgency is associated with a lower risk of termination and a lower risk of ceiling breaches, though neither is significant. The increased risk of ceiling breach is the only finding in line with the hypotheses. The next step is to add interactions between the competition and the crisis datasets.


###Model 02B: No Competition / Competition
```{r Model02B}

#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"Comp","Crisis"),
                        discrete_percent_cbre_plot(crisis_smp,"Comp","Crisis"))
                        
#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"Comp","Crisis"),
                        discrete_percent_term_plot(crisis_smp,"Comp","Crisis"))


#Model
CBre_02B <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cb_Comp +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(CBre_02B)

Term_02B <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cb_Comp +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(Term_02B)


stargazer::stargazer(CBre_02B,Term_02B,type="text",
                     digits=2)



#Plot the new variable and coefficients
#Add the fitted regression line
discrete_fitted_cbre_model(crisis_smp,"cb_Comp") + 
  stat_function(fun = fit_curve, args=list(a=coef(CBre_02B)[1],                                                        b=coef(CBre_02B)[2]),color="blue")
str(crisis_smp)


```

The results are complicated. With the interactions, terminations are now associated with competition, but for all three crisis datasets, competition counters this relationship. Things are more complex with ceiing breahes, where the interaction of competition with ARRA and OCO is associated with a lower likelihood of a breach, but the relationship goes the other way for disasters.

The next step is to look at a more detailed model, where single offer competition is broken out as a middle option between competition and no competion.


###Model 02C: No Competition / Single Offer / Competition
```{r Model02C}

#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"EffComp"),
             discrete_percent_cbre_plot(crisis_smp,"EffComp"))


#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"EffComp"),
                        discrete_percent_term_plot(crisis_smp,"EffComp"))





#Model
CBre_02C <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +n_Comp ,
                 family=binomial(link="logit"))
display(CBre_02C)

Term_02C <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +n_Comp ,
                 family=binomial(link="logit"))
display(Term_02C)


stargazer::stargazer(CBre_02C,Term_02C,type="text",
                     digits=2)




#Plot the Fitted
#Add the fitted regression line
# discrete_fitted_cbre_model(crisis_smp,"n_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(CBre_02C)[1],
#                                            b=coef(CBre_02C)[2]),
#                 color="blue")




```
The results when single-offer and multi-offer competition are split are quite odd and somewhat peculiar to the crisis datasets.

###Model 02D: No Competition / Single Offer / Competition
```{r Model02D}


#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"EffComp","Crisis"),
             discrete_percent_cbre_plot(crisis_smp,"EffComp","Crisis"))


#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"EffComp","Crisis"),
                        discrete_percent_term_plot(crisis_smp,"EffComp","Crisis"))


#Model
CBre_02D <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +n_Comp+
                   ARRA:n_Comp + Dis:n_Comp + OCO:n_Comp,
                 family=binomial(link="logit"))
display(CBre_02D)

Term_02D <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +n_Comp+
                   ARRA:n_Comp + Dis:n_Comp + OCO:n_Comp,
                 family=binomial(link="logit"))
display(Term_02D)


stargazer::stargazer(CBre_02D,Term_02D,type="text",
                     digits=2)



#Plot the Fitted
#Add the fitted regression line
# discrete_fitted_cbre_model(crisis_smp,"n_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(CBre_02D)[1],
#                                            b=coef(CBre_02D)[2]),
#                 color="blue")




```
These results confirm that it is the crisis datasets that drive this phenomenon, but 

The correlation between the three categories of competition has a larger  coefficent and standard error, in a perplexing direction. The next step looks at the number of offers in greater detail.

###Model 02E: No Competition / Number of Offer Categories 
```{r Model02E}
#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"CompOffr"),
             discrete_percent_cbre_plot(crisis_smp,"CompOffr"))


#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"CompOffr"),
                        discrete_percent_term_plot(crisis_smp,"CompOffr"))



#Model
CBre_02E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cn_Offr, family=binomial(link="logit"))
display(CBre_02E)

Term_02E <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cn_Offr, family=binomial(link="logit"))
display(Term_02E)

stargazer::stargazer(CBre_02E,Term_02E,type="text",
                     digits=2)


```

The more detailed breakout still doesn't make a great deal of sense.

###Model 02F: No Competition / Number of Offer Categories 
```{r Model02F}

#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"CompOffr","Crisis"),
             discrete_percent_cbre_plot(crisis_smp,"CompOffr","Crisis"))


#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"CompOffr","Crisis"),
                        discrete_percent_term_plot(crisis_smp,"CompOffr","Crisis"))


#Model
CBre_02F <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +n_Comp+
                   ARRA:n_Comp + Dis:n_Comp + OCO:n_Comp,
                 family=binomial(link="logit"))
display(CBre_02F)

Term_02F <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +n_Comp+
                   ARRA:n_Comp + Dis:n_Comp + OCO:n_Comp,
                 family=binomial(link="logit"))
display(Term_02F)


stargazer::stargazer(CBre_02F,Term_02F,type="text",
                     digits=2)



#Plot the Fitted
#Add the fitted regression line
# discrete_fitted_cbre_model(crisis_smp,"n_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(CBre_02F)[1],
#                                            b=coef(CBre_02F)[2]),
#                 color="blue")




```
The patterns are roughly similar to those found when only single offer competition is broken out, unfortunately the greater detail is not that illuminating.

###Model 02G: Number of Offer Categories 
```{r Model02G}

#Ceiling Breaches
gridExtra::grid.arrange(freq_continuous_cbre_plot(crisis_smp,"l_Offr"),
             binned_percent_cbre_plot(crisis_smp,"l_Offr"))


#Terminations
gridExtra::grid.arrange(freq_continuous_term_plot(crisis_smp,"l_Offr"),
                        binned_percent_term_plot(crisis_smp,"l_Offr"))


#Vehicle Crossreference
gridExtra::grid.arrange(binned_percent_cbre_plot(crisis_smp,"l_Offr","Veh"),
                        binned_percent_term_plot(crisis_smp,"l_Offr","Veh"))




#Percent Terminated Plot
binned_percent_cbre_plot(crisis_smp,"l_Offr","Veh")


#Model
CBre_02G <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cl_Offr, family=binomial(link="logit"))
display(CBre_02G)

Term_02G <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cl_Offr, family=binomial(link="logit"))
display(Term_02G)

stargazer::stargazer(CBre_02G,Term_02G,type="text",
                     digits=2)

#Plot the data and fitted curve
CBre_02G_plot<-ggplot(data=crisis_smp,
       aes(y=j_Term,x=cl_Offr))+geom_jitter(alpha=0.11,height=0)+scale_y_sqrt() +
  labs(title="Fitted Linear Model", caption="Source: FPDS, CSIS Analysis")

#Plot the Fitted
#Add the fitted regression line
discrete_fitted_cbre_model(crisis_smp,"cl_Offr") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_02G)[1],
                                           b=coef(CBre_02G)[2]),
                             color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_02G)



#Plot residuals versus fitted
residuals_cbre_plot(CBre_02G,bins=3)+
  labs(x="Estimated  Pr (Termination)")




```
Similar story with number of offers. Closer examination finds that the nature of the relationship varies greatly depending on the contract vehicle. 


###Model 02H: Number of Offer Categories 
```{r Model02H}


#Ceiling Breaches
gridExtra::grid.arrange(freq_continuous_cbre_plot(crisis_smp,"l_Offr","Crisis"),
             binned_percent_cbre_plot(crisis_smp,"l_Offr","Crisis"))


#Terminations
gridExtra::grid.arrange(freq_continuous_term_plot(crisis_smp,"l_Offr","Crisis"),
                        binned_percent_term_plot(crisis_smp,"l_Offr","Crisis"))



#Model
CBre_02H <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cl_Offr+
                   cl_Offr:ARRA + cl_Offr:Dis + cl_Offr:OCO, family=binomial(link="logit"))
display(CBre_02H)

#Model
Term_02H <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cl_Offr+
                   cl_Offr:ARRA + cl_Offr:Dis + cl_Offr:OCO, family=binomial(link="logit"))
display(Term_02H)
stargazer::stargazer(CBre_02H,Term_02H,type="text",
                     digits=2)

#Variant Model
crisis_smp$clsqr_Offer<-crisis_smp$cl_Offr^2
CBre_11E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cl_Offr +clsqr_Offer, family=binomial(link="logit"))
display(CBre_11E)

#Plot the data and fitted curve
CBre_02H_plot<-ggplot(data=crisis_smp,
       aes(y=j_Term,x=cl_Offr))+geom_jitter(alpha=0.11,height=0)+scale_y_sqrt() +
  labs(title="Fitted Linear Model", caption="Source: FPDS, CSIS Analysis")

#Plot the Fitted
#Add the fitted regression line
discrete_fitted_cbre_model(crisis_smp,"cl_Offr") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_02H)[1],
                                           b=coef(CBre_02H)[2]),
                             color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_02H)



#Plot residuals versus fitted
residuals_cbre_plot(CBre_02H,bins=3)+
  labs(x="Estimated  Pr (Termination)")




```
Interestingly, unlike prior models, the interactios with the log of the number of offers now all have positive coefficient. After all this analysis, sticking with binary competition seems the best choice. The next step will be to add in a consideration of non-competition for urgency reasons.



###Model 02I: No Competition / Competition
```{r Model02I}

#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"Urg"),
                        discrete_percent_cbre_plot(crisis_smp,"Urg"))
                        
#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"Urg"),
                        discrete_percent_term_plot(crisis_smp,"Urg"))


#Model
CBre_02I <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cb_Comp + b_Urg +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(CBre_02I)

Term_02I <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cb_Comp +  b_Urg +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(Term_02I)


stargazer::stargazer(CBre_02B,CBre_02I,Term_02B,Term_02I,type="text",
                     digits=2)



#Plot the new variable and coefficients
#Add the fitted regression line
discrete_fitted_cbre_model(crisis_smp,"cb_Comp") + 
  stat_function(fun = fit_curve, args=list(a=coef(CBre_02I)[1],                                                        b=coef(CBre_02I)[2]),color="blue")
str(crisis_smp)


```
Urgency estimates a higher probability of ceiling breaches and a lower probability of terminations, but the coefficients are small and not significant.

###Model 02J: No Competition / Competition
```{r Model02J}

#Ceiling Breaches
gridExtra::grid.arrange(freq_discrete_cbre_plot(crisis_smp,"Urg","Crisis"),
                        discrete_percent_cbre_plot(crisis_smp,"Urg","Crisis"))
                        
#Terminations
gridExtra::grid.arrange(freq_discrete_term_plot(crisis_smp,"Urg","Crisis"),
                        discrete_percent_term_plot(crisis_smp,"Urg","Crisis"))


#Model
CBre_02J <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +cb_Comp + b_Urg +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO+
                   b_Urg:ARRA + b_Urg:Dis + b_Urg:OCO, 
                 family=binomial(link="logit"))
display(CBre_02J)

Term_02J <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +cb_Comp +  b_Urg +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO+
                   b_Urg:ARRA + b_Urg:Dis + b_Urg:OCO, 
                 family=binomial(link="logit"))
display(Term_02J)


stargazer::stargazer(CBre_02B,CBre_02I,CBre_02J,Term_02B,Term_02I,Term_02J,type="text",
                     digits=2)



#Plot the new variable and coefficients
#Add the fitted regression line
discrete_fitted_cbre_model(crisis_smp,"cb_Comp") + 
  stat_function(fun = fit_curve, args=list(a=coef(CBre_02I)[1],                                                        b=coef(CBre_02I)[2]),color="blue")
str(crisis_smp)


```
The interaction of OCO and urgency is perhaps most interesting, as it is significantly associated with higher rates of contract termiantion. That said, the small sample sizes result in large standard errors.  It is probably best to leave it out, or include it for OCO only.
##Scope Variables
###Model 03A: Cost Ceiling

The model starts by examing the influence of large ceilings on contracts, the core idea here, as observed in the fixed priced paper, is that larger contracts are at greater risk of termination. This can be explained by both the inherent risk in the contract and high transaction costs of contract termination which discourage making the effort for smaller contracts.

```{r Model03A}
#Frequency Plot for unlogged ceiling
freq_continuous_cbre_plot(crisis_smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
freq_continuous_cbre_plot(subset(crisis_smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)

#Frequency Plot for logged ceiling
freq_continuous_cbre_plot(crisis_smp,"l_Ceil")

#Percent Terminated Plot
binned_percent_cbre_plot(crisis_smp,"l_Ceil")


#Model
CBre_03A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +
                   cb_Comp + b_Urg +
                   cl_Ceil +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(CBre_03A)

Term_03A <- glm (data=crisis_smp,
                 b_Term ~ ARRA + Dis + OCO +
                   cb_Comp +  b_Urg +
                   cl_Ceil +
                   cb_Comp:ARRA + cb_Comp:Dis + cb_Comp:OCO, 
                 family=binomial(link="logit"))
display(Term_03A)


stargazer::stargazer(CBre_02I,CBre_03A,Term_02I,Term_03A,type="text",
                     digits=2)



#Plot the fitted model plot
CBre_03B_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_03B))}

#Competition curves
fitted_cbre_model(crisis_smp,"cl_Ceil") + stat_function(fun = CBre_03B_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_03B_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03A)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03A)+
  labs(x="Estimated  Pr (Termination)")

residuals_cbre_plot(CBre_03A,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")
  

```

Contract ceiling has a significant relationship, though the residuals show a possible non-linear patterns. When the initial contract ceiling is particularly low or high, the fitted model underestimates the risk of terminations. This suggests that addding the log(Ceil)^2 might better capture the underlying data. 



###Model 03B: Cost Ceiling Squared

```{r Model03B}



#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"lsqr_Ceil")

#Percent Terminated Plot
binned_percent_cbre_plot(crisis_smp,"lsqr_Ceil")

#Model
CBre_03D <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + cl_Ceil + clsqr_Ceil, family=binomial(link="logit"))
display(CBre_03D)

#Plot the fitted model plot
CBre_03D_curve<-function(x, Comp){invlogit(cbind(1,Comp,x, x^2) %*%  coef(CBre_03D))}

#Competition curves
fitted_cbre_model(crisis_smp,"cl_Ceil") + stat_function(fun = CBre_03D_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_03D_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03D)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03D)+
  labs(x="Estimated  Pr (Termination)")

residuals_cbre_plot(CBre_03D,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```

Contracts with very small or very large ceilings appear have a negative coefficient for calculating termination. On the upper end, this might represent contracts that are "too large to fail"" or simply that above a certain size, risk stops rising. Adding the log(Ceiling) squared greatly reduces the apparent pattern in the residuals, although more than 5 percent of the binned residuals still fall outside the 95% confidence interval.

###Model 03C: Cost Ceiling and Competition

```{r Model03C}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Ceil","EffComp")

#Plot the percent terminated across cost ceiling and competition
binned_percent_cbre_plot(crisis_smp,"l_Ceil","EffComp")

#Create the model
CBre_03E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + cl_Ceil + clsqr_Ceil + n_Comp:cl_Ceil, family=binomial(link="logit"))
display(CBre_03E)

CBre_03E_curve<-function(x, Comp){invlogit(cbind(1,Comp,x,x^2,Comp*x) %*%  coef(CBre_03E))}

#Competition Curves
fitted_cbre_model(crisis_smp,"cl_Ceil") + stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03E)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03E)+
  labs(x="Estimated  Pr (Termination)")

residuals_cbre_plot(CBre_03E,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")
```
The interaction went in the expected direction, but is surprisingly powerful. Competition heightens the importance of contract ceiling, and larger contract ceilings mitigate the importance of competition. The other powerful part of this interaction was the dramatic increase in the coefficient for competition and the comparative reduction in the correlation of ceiling.

###Model 03D: Maximum Duration

```{r Model03D}
#Frequency Plot for max duration
freq_continuous_cbre_plot(crisis_smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
freq_continuous_cbre_plot(crisis_smp,"l_Days")

#Percent Terminated Plot
binned_percent_cbre_plot(crisis_smp,"l_Days")


#Model
CBre_03G <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days + clsqr_Ceil +
                   n_Comp:cl_Ceil , family=binomial(link="logit"))
display(CBre_03G)


CBre_03G_curve<-function(x, Comp,Ceil){invlogit(cbind(1,Comp,Ceil,Ceil^2,x,Comp*Ceil) %*%  coef(CBre_03G))}

#Competition Curves
fitted_cbre_model(crisis_smp,"cl_Days") + stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(crisis_smp,"cl_Days") +  stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03G)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_03G)+
  labs(x="Estimated  Pr (Termination)")
# debug(binned.resids)
# residuals_cbre_plot(CBre_03G,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")


```
The initial model results are surprising as ceiling change direction, reducing and correlates with a lower risk of termiation now, although the interaction between competition and ceiling remains roughly the same. The graph of the fitted values shows that this model The next step will be to look at the interaction of ceiling and duration. The difference in deviance for residual difference has more than trippled, an indication of the correlative power of duration. However, the residuals do show a clear pattern that indicates another exponential variable may be necessary. However, the interaction between ceiling and duration is a more important analytical question and will be the next variable added.

###Model 03E: Interation of Ceiling and Duration

```{r Mode03E}

#First a quick scatter plot for terminations by duration and ceiling
ggplot(data=subset(crisis_smp,!is.na(l_Ceil)),
       aes(x=l_Days,y=l_Ceil))+geom_point(alpha=0.1)+facet_grid(Term~.)+
  labs(title="Frequency by Termination",
          caption="Source: FPDS, CSIS Analysis")


#Create the model
CBre_03E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days, family=binomial(link="logit"))
display(CBre_03E)

CBre_03E_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,x,
        Comp*Ceil,x*Ceil) %*%  coef(CBre_03E))}



#Competition Curves
fitted_cbre_model(crisis_smp,"cl_Days") + stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(crisis_smp,"cl_Days") +  stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_03E_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03E)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_03E)+
  labs(x="Estimated  Pr (Termination)")
# debug(binned.resids)
# residuals_cbre_plot(CBre_03E,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")


```


The interaction of ceiling and duration is correlated with a lower rate of termination, which is to say that when either factor is high, the other has less effect. Thus long contracts with fewer dollars or high ceiling contract with shorter durations are at higher risk than more balanced contracts. This interaction also restores the positive coefficient for ceiling and switches ceiling squared to positive. The residuals still show a pattern tht could be explained by an exponential. Examining that possibility will be the next step.

###Model 03F: Duration Squared

```{r Model03F}



#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"lsqr_Days")

#Percent Terminated Plot
binned_percent_cbre_plot(crisis_smp,"lsqr_Days")


#Create the model
CBre_03F <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days, family=binomial(link="logit"))
display(CBre_03F)

CBre_03F_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,x,x^2,
        Comp*Ceil,x*Ceil) %*%  coef(CBre_03F))}

#Competition curves
fitted_cbre_model(crisis_smp,"cl_Ceil") + stat_function(fun = CBre_03F_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_03F_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03F)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03F)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_03F,"cl_days")+
#   labs(x="Centered Log(Days)")


residuals_cbre_plot(CBre_03F,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")


```
Adding log(initial duration)^2 does seem to address the troubling pattern present in the residuals, namely the parabolic curve and the large number of data bins falling outside of the 95% confidence interval. Both of the ceiling coefficients remain positive but they are no longer coefficient. The next step is to see whether log(initial cost ceiling)^2 is still useful in this model now that the square of duration is included.

###Model 03G: Testing the removal of Ceiling^2 

```{r Model03G}

#Create the model
CBre_03G <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ clsqr_Days +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days, family=binomial(link="logit"))
display(CBre_03G)

CBre_03G_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,x,x^2,
        Comp*Ceil,x*Ceil) %*%  coef(CBre_03E))}

#Competition curves
fitted_cbre_model(crisis_smp,"cl_Ceil") + stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_03G_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03G)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03G)+
  labs(x="Estimated  Pr (Termination)")

residuals_cbre_plot(CBre_03G,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```

While the effect on the residual deviance is fairly minor, it does still appear that the ceiling^2 does reduce the incidence of non-linear patterns in the residuals. So for now we will be leaving it in.

###Model 03H: Interaction of Duration and Competition
```{r Mode03H}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Days","EffComp")

#Plot the percent terminated across cost ceiling and competition
binned_percent_cbre_plot(crisis_smp,"l_Days","EffComp")

#Create the model
CBre_03H <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days, family=binomial(link="logit"))
display(CBre_03H)

CBre_03H_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,x,x^2,
        Comp*Ceil,x*Ceil,x*Comp) %*%  coef(CBre_03H))}

#Competition curves
fitted_cbre_model(crisis_smp,"cl_Days") + stat_function(fun = CBre_03H_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_03H_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03G)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03G)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_03F,"cl_days")+
#   labs(x="Centered Log(Days)")



```
The interaction of competition and duration is significant in itself and also has interesting consequences for other variables, notably boosting the cooeficient for ceiling and reducing the coefficient for duration. Competed contracts have a greater coefficient for termination. For short duration contracts, competition has a negative and significant coefficient but for long duration the relationship reverses itself. This would be consistent with the benefits of competition fading as the competition slipped further into the past. Unfortunately the residuals still show questionable patterns that merit continued observation.

##Contract Vehicle
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). 

###Model 13A: Single-Award, Multi-Award, and Other Indefinite Delivery Vehicles


```{r Model13A}
#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Veh")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Veh")


#Create the model
CBre_03A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days, family=binomial(link="logit"))
display(CBre_03A)

#Plot the model and Vehicle for SIDV
CBre_03A_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,x,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_03A))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_03A_SIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03A_SIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")

CBre_03A_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,x,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_03A))}

#Plot the model and Vehicle for MIDV
#Competition curves
discrete_fitted_cbre_model(crisis_smp,"MIDV") +
  stat_function(fun = CBre_03A_MIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03A_MIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")

CBre_03A_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,MIDV,x,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_03A))}

#Plot the model and Vehicle for OIDV
#Competition curves
discrete_fitted_cbre_model(crisis_smp,"OIDV") +
  stat_function(fun = CBre_03A_OIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")+
  stat_function(fun = CBre_03A_OIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03A)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_03F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The first check lumps looks at three categories of IDVs, each facing a notably lower a risk of termination. The largest negative coefficient is for single award IDCs, multiple award IDVs second, and other IDVs third. The deviation residual notably creeps up after this addition, though this is likely attributable to a missing data problem rather than the new information not being useful. Unfortunately, while the for both ceiling^2 and duration^2 were notably reduced in magnitude, the residuals show significant patterns, underestimating the risk of termination in the fitted range from around 0.005 to 0.11 and overestimating by 0.02. There's no exponential cbre that makes sense to add here, which leaves the hope that interactions may address this phenomenon.

This may reflect that the Ceiling and Days entries reflect only the task order and not the larger contract. The next step is to check the intersections with ceiling.


###Model 13B: Vehicle and Duration
```{r Model13B}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Days","Veh")


#Percent Terminated Plot 
binned_percent_cbre_plot(crisis_smp,"l_Days","Veh")

#Create the model
CBre_03B <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days, family=binomial(link="logit"))
display(CBre_03B)

# Plot the model and Vehicle for SIDV
CBre_03B_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,x,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*x,Days*MIDV,Days*OIDV) %*%  coef(CBre_03B))}

#Duration curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_03B_SIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=-1,
                                       MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03B_SIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=1,
                                       MIDV=0,OIDV=0),color="blue")


CBre_03B_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,x,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*x,Days*OIDV) %*%  coef(CBre_03B))}

#Plot the model and Vehicle for MIDV
#Duration Curves
discrete_fitted_cbre_model(crisis_smp,"MIDV") +
  stat_function(fun = CBre_03B_MIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=-1,
                                       SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03B_MIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=1,
                                       SIDV=0,OIDV=0),color="blue")


CBre_03B_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,MIDV,x,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*x) %*%  coef(CBre_03B))}

#Plot the model and Vehicle for OIDV
#Duration curves
discrete_fitted_cbre_model(crisis_smp,"OIDV") +
  stat_function(fun = CBre_03B_OIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=-1,
                                       SIDV=0,MIDV=0),color="blue")+
  stat_function(fun = CBre_03B_OIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=1,
                                       SIDV=0,MIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03B)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_03B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The vast majority of very short duration contracts are IDVs. The distribution in each of the categories is typically not normal, Other IDVs in particularly being prone to two peaks. Interestingly enough, definitive contracts and purchase orders have the most consistent relationship with terminations, and single-award IDVs the most noisy. For the MIDVs and OIDVs, below l_days=2, or about the average point, there's almost no risk of termination, but that risk steadily rises above that level. 

Interactions:
* Single-Award IDVs have a large negative coefficient, but as the duration grows longer this affect is diminished and the importance of duration grows. 
* Multiple-Award IDVs now have the largest negative coefficient, but to an even greater degree than with Single-Award IDVs, as the duration grows longer this affect is diminished and the importance of duration grows. 
* Other IDVs now have a no longer signicant risk of termination, but the relationship with duration is the reverse of the other two, OIDVs dampen the rise in termination risk for longer contracts.



###Model 13C: Vehicle and Competition

The next step is to check interactions with the contract vehicles. Each has a slightly different approach to competition. For example, the competition for a Single-Award IDV happens at the start of the IDV, after that, contracts awarded through that vehicle go to that single winning vendor.


```{r Model13C}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"EffComp","Veh")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"EffComp","Veh")


#Create the model
CBre_03C <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp , family=binomial(link="logit"))
display(CBre_03C)

# Plot the model and Vehicle for SIDV
CBre_03C_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,x,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_03C))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_03C_SIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03C_SIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")


CBre_03C_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,x,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*x,Days*OIDV,
        Comp*SIDV,Comp*x,Comp*OIDV) %*%  coef(CBre_03C))}

#Plot the model and Vehicle for MIDV
#Competition Curves
discrete_fitted_cbre_model(crisis_smp,"MIDV") +
  stat_function(fun = CBre_03C_MIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03C_MIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")


CBre_03C_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,MIDV,x,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*x,
        Comp*SIDV,Comp*MIDV,Comp*x) %*%  coef(CBre_03C))}

#Plot the model and Vehicle for OIDV
#Competition curves
discrete_fitted_cbre_model(crisis_smp,"OIDV") +
  stat_function(fun = CBre_03C_OIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")+
  stat_function(fun = CBre_03C_OIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03C)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_03C)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
The average plots did show varying relationships and slopes between different types of vehicles. However, 
the coeficient for competition itself remains negative, though not significant, despite the baseline vehicle state, definitive/purchase, having higher termination rates among competed contracts. Given the other interactions, this suggests that this phenomenon is already captured by other inputs and interactions in the dataset. 

Interactions
* For single-award IDVs, competition magnifies the lower termination coeffient. This is somewhat surprising, as competition reflects the competed status of the IDV, not the individual task order. Nonetheless, that rate appears to very much matter, and suggests that uncompeted IDVs lose some of their termination reduction correlation.
* For multiple-award IDVs, competition also dampens the termination rate. This also magnificies the import of duration for multiple-award IDVs, which now can complete overcome the base termination coefficient of the vehicle.
* Competition dampens the termination reduction coefficient for other IDVs. It is not significant, I am tempted to leave it out, though it may be appropriate to always leave in the triples.

Unlike the existance of competition, having more offers does not have the same dramatic relationship with multi-award IDVs that it does with competition. This does raise the question as to whether the long tail of high numbers of offers might be undercutting the relationship. However, for now, we will stick with competition. 

###Model 13D: Vehicle and Contract Ceiling
```{r Model13D}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Ceil","Veh")


#Percent Terminated Plot 
binned_percent_cbre_plot(crisis_smp,"l_Ceil","Veh")

#Create the model

#Create the model
CBre_03D <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   SIDV:cl_Ceil+MIDV:cl_Ceil+OIDV:cl_Ceil, family=binomial(link="logit"))
display(CBre_03D)

# Plot the model and Vehicle for SIDV
CBre_03D_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,x,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Ceil*x,Ceil*MIDV,Ceil*OIDV) %*%  coef(CBre_03D))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_03D_SIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03D_SIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,OIDV=0),color="blue")


CBre_03D_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,x,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*x,Days*OIDV,
        Comp*SIDV,Comp*x,Comp*OIDV,
        Ceil*SIDV,Ceil*x,Ceil*OIDV) %*%  coef(CBre_03D))}

#Plot the model and Vehicle for MIDV
#Competition Curves
discrete_fitted_cbre_model(crisis_smp,"MIDV") +
  stat_function(fun = CBre_03D_MIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_03D_MIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,OIDV=0),color="blue")


CBre_03D_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,Days,Days^2,SIDV,MIDV,x,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*x,
        Comp*SIDV,Comp*MIDV,Comp*x,
        Ceil*SIDV,Ceil*MIDV,Ceil*x) %*%  coef(CBre_03D))}

#Plot the model and Vehicle for OIDV
#Competition curves
discrete_fitted_cbre_model(crisis_smp,"OIDV") +
  stat_function(fun = CBre_03D_OIDV_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")+
  stat_function(fun = CBre_03D_OIDV_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03D)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_03D)+
  labs(x="Estimated  Pr (Termination)")



# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The interaction with contract ceiling only has a significant relationship with other IDV, and the 3 terms together do little to reduce the divergence of the model. Leaving it out.

###Model 13E: Testing the removal of Ceiling^2 

```{r Model13E}

#Create the model
CBre_03E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil  + cl_Days+ clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp, family=binomial(link="logit"))
display(CBre_03E)


# Plot the model and Vehicle for SIDV
CBre_03E_SIDV_curve<-function(x, Comp,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,x,Days,Days^2,SIDV,MIDV,OIDV,
        Comp*x,Days*x,Days*Comp,
        Days*SIDV,Days*MIDV,Days*OIDV,
        Comp*SIDV,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_03E))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"cl_Ceil") +
  stat_function(fun = CBre_03E_SIDV_curve,
                             args=list(Comp=0,Days=0,
                                       MIDV=0,OIDV=0,SIDV=0),color="blue")+
  stat_function(fun = CBre_03E_SIDV_curve,
                             args=list(Comp=2,Days=0,
                                       MIDV=0,OIDV=0,SIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03E)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_03E)+
  labs(x="Estimated  Pr (Termination)")

residuals_cbre_plot(CBre_03D,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")


residuals_cbre_plot(CBre_03E,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```
Ceiling squared does little to reduce deviance and only slightly mitigates, rather than removing, any patterns in the residuals. Removing it from the model.


###Model 13F: Testing the removal of Duration^2 

```{r Model13F}

#Create the model
CBre_03F <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil  + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp, family=binomial(link="logit"))
display(CBre_03F)


# Plot the model and Vehicle for SIDV
CBre_03F_SIDV_curve<-function(x, Comp,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,x,Days,Days^2,SIDV,MIDV,OIDV,
        Comp*x,Days*x,Days*Comp,
        Days*SIDV,Days*MIDV,Days*OIDV,
        Comp*SIDV,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_03F))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"cl_Ceil") +
  stat_function(fun = CBre_03F_SIDV_curve,
                             args=list(Comp=0,Days=0,
                                       MIDV=0,OIDV=0,SIDV=0),color="blue")+
  stat_function(fun = CBre_03F_SIDV_curve,
                             args=list(Comp=2,Days=0,
                                       MIDV=0,OIDV=0,SIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_03F)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_03E)+
  labs(x="Estimated  Pr (Termination)")


#Plot residuals versus fitted
residuals_cbre_plot(CBre_03F)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_03E,"cl_Days")+
  # labs(x="Centered Log(Duration)")


# residuals_cbre_plot(CBre_03F,"cl_Days")+
  # labs(x="Centered Log(Duration)")
```

The benefits of duration squared are fairly minimal as well at this point.

##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.

###Model 14A: Fixed-Price
```{r Model14A}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"FxCb")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"FxCb")


#Create the model
CBre_14A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp , family=binomial(link="logit"))
display(CBre_14A)

# Plot the model and Vehicle 
CBre_14A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_14A))}

#Competition curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_14A_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 

###Model 14B: Fixed-Price and Maximum Duration Intersection 
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a longer duration means more opportunity for changed circumstance.

```{r Model14B}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Days","FxCb")

#Percent Terminated Plot 
binned_percent_cbre_plot(crisis_smp,"l_Days","FxCb")


#Create the model
CBre_14B <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed +
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   cl_Days:n_Fixed , family=binomial(link="logit"))
display(CBre_14B)

# Plot the model and Vehicle 
CBre_14B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Days*x) %*%  coef(CBre_14B))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_14B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14B)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
The probability of termination by duration chart is more clearcut with fixed price than with cost-based contracts. However, the variable does not appreciably decrease the deviation, is not significant, and undercuts the significance of other variables. It will not be added tto the model.

###Model 14C: Fixed-Price and Vehicle
```{r Model14C}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"FxCb","Veh")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"FxCb","Veh")

#Create the model
CBre_14C <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   SIDV:n_Fixed+MIDV:n_Fixed+OIDV:n_Fixed, family=binomial(link="logit"))
display(CBre_14C)

# Plot the model and Vehicle for SIDV
CBre_14C_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        n_Fixed,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*OIDV,
        Comp*SIDV,Comp*MIDV,Comp*OIDV,
        x*SIDV,x*MIDV,x*OIDV
        ) %*%  coef(CBre_14C))}

#Vehicle curves
discrete_fitted_cbre_model(crisis_smp,"n_Fixed") +
  stat_function(fun = CBre_14C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=1,MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = CBre_14C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=1,OIDV=0),color="blue")+
  stat_function(fun = CBre_14C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0,OIDV=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14C)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14C)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
The interactions are not significant and do little to reduce the residual deviance. They will not be added to the model.


###Model 14D: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. That could help avoid terminations, but it's an indirect connection at best. Unfortunately, incentive fees are incredibly rare, which makes them challenging to examine directly.


```{r Model14D}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Fee")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Fee")



#Create the model
CBre_14D <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ clsqr_Ceil + clsqr_Days +
                   SIDV + MIDV + FSSGWAC + BPABOA + 
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + n_Incent + n_NoFee +
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp 
                    , family=binomial(link="logit"))
display(CBre_14D)

# Plot the model and Vehicle 
CBre_14D_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_14D))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"n_Incent") +
  stat_function(fun = CBre_14D_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,Fixed=1),color="blue")+
  stat_function(fun = CBre_14D_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14D)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14D)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The effect of incentive fees are not significant. They do have a noteworthy coefficient, however, given prior research on their ability to prevent cost overruns, their lowered heightened probably of terminations lacks an immdetiate explaintation. There's also a fair amount of unlabeled data, which reduces the samplle size. It's still worth checking the interaction with fixed price, as they are based on a common field in FPDS and the two are closely related in concept.

###Model 14E: Incentive Fees and Fixed-Price  

```{r Model14E}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Fee","FxCb")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Fee","FxCb")+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))



#Create the model
CBre_14E <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + n_Incent + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   n_Fixed:n_Incent
                    , family=binomial(link="logit"))
display(CBre_14E)

# Plot the model and Vehicle 
CBre_14E_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        x*Fixed) %*%  coef(CBre_14E))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14E_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=0),color="blue")+
  stat_function(fun = CBre_14E_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14E)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14E)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
Looking at Incentive Fees and Fixed-Price interactions undercuts the significance of both base variables. Incentive will not be added to the model.

###Model 14F: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. They have been found by the GAO and the Performance of the Defense Acquisition studies to contain notable risks, primarily    relating to cost overruns. Will these risks also carry into terminations?

```{r Model14F}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"UCA")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"UCA")



#Create the model
CBre_14F <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp 
                    , family=binomial(link="logit"))
display(CBre_14F)

# Plot the model and Vehicle 
CBre_14F_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_14F))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14F_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = CBre_14F_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14F)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14F)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
###Model 14G: UCA and Competition


```{r Model14G}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"UCA","n_Comp")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"UCA","n_Comp")



#Create the model
CBre_14G <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   b_UCA:n_Comp
                 
                    , family=binomial(link="logit"))
display(CBre_14G)

# Plot the model and Vehicle 
CBre_14G_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_14G))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14G_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = CBre_14G_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14G)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14G)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
  # labs(x="Centered Log(Days)")

```
The interaction of UCA and Comp does align with the findings of the GAO as to the heightened risk of uncompeted UCA. The magnitude of the coefficentsis is considerable, although the rarity of UCAs means the effect on deviation is fairly small. This can also be seen in the residuals where there is a substantial gap between 0.03 and 0.05 in estimated risk of termination.

###Model 14H: UCA and Duration


```{r Model14H}

#Frequency Plot
freq_continuous_cbre_plot(crisis_smp,"l_Days","UCA")

#Percent Terminated Plot 
binned_percent_cbre_plot(crisis_smp,"l_Days","UCA")


#Create the model
CBre_14H <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp +
                   b_UCA:n_Comp + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
display(CBre_14H)

# Plot the model and Vehicle 
CBre_14H_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Comp*x,Days*x) %*%  coef(CBre_14H))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_14H_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = CBre_14H_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_14H)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_14H)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
  # labs(x="Centered Log(Days)")

```
The intersection of initial duration and UCA had a negative coefficient that was not significant. This is the opposite of what we would expect from the literature, which notes the risks of long periods under an undefinitized contract. This may simply reflect a limitation of the variable, which tracks the initial maximum duration and would not differentiate between a contract that went a day before being definitized and one that went a year. This interaction will not be added to the model.

##Place of Performance
###Model 15A: Any International

```{r Model15A}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Intl")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Intl")



#Create the model
CBre_15A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(CBre_15A)

# Plot the model and Vehicle 
CBre_15A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_15A))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_15A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_15A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_15A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_15A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

International performance of contract unexpectedly had a negative coefficent. It is a variable of interest  to the study and will be left in.

###Model 15B: Fixed Price and Any International

```{r Model15B}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Intl","FxCb")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Intl","FxCb")



#Create the model
CBre_15A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   n_Fixed:b_Intl
                    , family=binomial(link="logit"))
display(CBre_15A)

# Plot the model and Vehicle 
CBre_15A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_15A))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_15A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_15A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_15A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_15A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

###Model 15C: Vehicle and Any International

```{r Model15C}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Intl","Veh")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Intl","Veh")



#Create the model
CBre_15C <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   SIDV:b_Intl+MIDV:b_Intl+OIDV:b_Intl
                    , family=binomial(link="logit"))
display(CBre_15C)

# Plot the model and Vehicle 
CBre_15C_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_15C))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_15C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_15C_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_15C)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_15C)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```


##Who
Adding who resulted in a range of models that failed to converge. The one exception was combining Product/Service/R&D alone and Who, which did require removing multiple interactions from the model before convergence could be reached, but did allow the continued inclusion of  the combination of Product/Service/R&D and competition. All other models have been commented out to allow for the Markdown file  to  be created in a manageable amount of time. The study team initially considered using start year or contracting office identity as additional non-nested levels. However, those models failed to converge or had eigenvalue related challenges. As a result, the study team chose to focus on the question of what is being acquired. Who is acquiring is instead being handled by individual dummy variables or group level summary variables where appropriate, but not by seperate intercepts or slopes. Start year is not included in the model because of the complicatitons related to durations. Namely longer duration contracts from recent years have not yet had the opportunity to live out their natural life span. This means  that recent years will have an artificially high termination rate for longer contracts, because we only know about those that ended before their maximum duration, often due to termination.


###Model 16A: Sub Customer other DoD
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. 
```{r Model16A}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"Who")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Who")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


crisis_smp$b_ODoD<-crisis_smp$Who
levels(crisis_smp$b_ODoD)<- list("1"=c("Other DoD"), 
                                "0"=c("Air Force","Army","Navy"))
crisis_smp$b_ODoD[crisis_smp$b_ODoD=="Uncategorized"]<-NA
crisis_smp$b_ODoD<-as.integer(as.character(crisis_smp$b_ODoD))

#Create the model
CBre_16A <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + b_ODoD +
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(CBre_16A)


# Plot the model and Vehicle 
CBre_16A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,Intl,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_16A))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"b_ODoD") +
  stat_function(fun = CBre_16A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")+
  stat_function(fun = CBre_16A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_16A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_16A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

After inclusion of DLA, the Competition correlates significantly predicts a greater risk of termination. Studying that interaction will be our next step.

#Other DoD & Competition
```{r Model16B}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"EffComp","Who")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"EffComp","Who")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


crisis_smp$b_ODoD<-crisis_smp$Who
levels(crisis_smp$b_ODoD)<- list("1"=c("Other DoD"), 
                                "0"=c("Air Force","Army","Navy"))
crisis_smp$b_ODoD[crisis_smp$b_ODoD=="Uncategorized"]<-NA
crisis_smp$b_ODoD<-as.integer(as.character(crisis_smp$b_ODoD))

#Create the model
CBre_16B <- glm (data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + b_ODoD +
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   b_ODoD:n_Comp
                    , family=binomial(link="logit"))
display(CBre_16B)


# Plot the model and Vehicle 
CBre_16B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,Intl,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_16B))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"b_ODoD") +
  stat_function(fun = CBre_16B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")+
  stat_function(fun = CBre_16B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_16B)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_16B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

#Multi-Level Model

##What
###Model 18A: Product/Service/R&D
```{r Model18A}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"PSR")

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"PSR")



#Create the model
CBre_18A <- glmer(data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   (1 | PSR)
                    , family=binomial(link="logit"))
display(CBre_18A)

# Plot the model and Vehicle 
CBre_18A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*Comp) %*%  coef(CBre_18A))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_18A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_18A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_18A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_18A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.

###Model 18B: Product/Service/R&D and Platform
```{r Model18B}

#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"PSR_What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"PSR_What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))



#Create the model
CBre_18B <- glmer(data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO + n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   (1 | PSR) + (1 | PSR_What)
                    , family=binomial(link="logit"))
display(CBre_18B)

# Plot the model and Vehicle 
CBre_18B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*Comp) %*%  coef(CBre_18B))}

#Days curves
discrete_fitted_cbre_model(crisis_smp,"SIDV") +
  stat_function(fun = CBre_18B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_18B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_18B)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_18B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_cbre_plot(CBre_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

###Model 18C: Interactions
```{r Model 6 Exploration}
#, fig.height = 10, fig.width = 6.5
#Effective Competition
#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"PSR_What","EffComp")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"EffComp","PSR")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"EffComp","What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"EffComp","PSR_What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


#Effective Competition
#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"PSR_What","Veh")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"Veh","PSR")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"Veh","What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"Veh","PSR_What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

#FxCb
#Frequency Plot
freq_discrete_cbre_plot(crisis_smp,"PSR_What","FxCb")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_cbre_plot(crisis_smp,"FxCb","PSR")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"FxCb","What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

discrete_percent_cbre_plot(crisis_smp,"FxCb","PSR_What")+ theme(axis.text.x = element_text(angle = 90, hjust = 1))


CBre_18C <- glmer(data=crisis_smp,
                 b_CBre ~ #n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   (1 + n_Comp | PSR) + (1 | PSR_What)
                    , family=binomial(link="logit"))
display(CBre_18C)


CBre_18D <- glmer(data=crisis_smp,
                 b_CBre ~ ARRA + Dis + OCO +n_Comp + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
                   b_UCA:n_Comp+
                   (1  | PSR) + (1 + n_Comp| PSR_What)
                    , family=binomial(link="logit"))
display(CBre_18D)

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_18C)


#Plot residuals versus fittedO
residuals_cbre_plot(CBre_18C)+
  labs(x="Estimated  Pr (Termination)")


# CBre_18E <- glmer(data=crisis_smp,
#                  b_CBre ~ ARRA + Dis + OCO +n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    n_Comp:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    n_Comp:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp+
#                    b_UCA:n_Comp+
#                    (1+n_Comp  | PSR) + (1+ n_Comp | PSR_What)
#                     , family=binomial(link="logit"))
# display(CBre_18E)
# failure to converge in 10000 evaluations

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_18C)


#Plot residuals versus fittedO
residuals_cbre_plot(CBre_18C)+
  labs(x="Estimated  Pr (Termination)")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_18D)


#Plot residuals versus fittedO
residuals_cbre_plot(CBre_18D)+
  labs(x="Estimated  Pr (Termination)")

```
The use of Comp as 

