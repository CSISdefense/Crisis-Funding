---
title: "Account Processing"
author: "Greg Sanders"
date: "December 16, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
require(ggplot2)
require(scales)
require(XLConnect)


Path<-"K:/2007-01 PROFESSIONAL SERVICES/R scripts and data/"
Path<-"D:/Users/Greg Sanders/Documents/Development/R-scripts-and-data/"
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))


Coloration<-read.csv(
  paste(Path,"Lookups/","Lookup_coloration.csv",sep=""),
  header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE, 
  stringsAsFactors=FALSE
)

#Clear out lines from the coloration CSV where no variable is listed.
Coloration<-subset(Coloration, variable!="")

```

## C-1

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r C-1}

# Load workbook C1
c1xls <- loadWorkbook(file.path("Data","FY2016","c1.xlsx"))
c1data <- readWorksheet(c1xls, sheet = "FY 2015", header=TRUE,startRow=2)
c1data$BudgetType<-'Base'
c1dataOCO <- readWorksheet(c1xls, sheet = "FY 2015 OCO", header=TRUE,startRow=2)
c1dataOCO$BudgetType<-'OCO'
c1data<-rbind(c1data,c1dataOCO)
rm(c1dataOCO)

c1data<-standardize_variable_names(Path,c1data)


colnames(c1data)
c1data$SourceFiscalYear<-2016
c1data<-melt(c1data,
                  id.vars=c("SourceFiscalYear",
                            "Account",
                            "MilDeptDW",
                            "AccountTitle",
                            "Organization" ,
                            "BudgetActivity",
                            "BudgetActivityTitle",
                            "StateCountry",
                            "StateCountryTitle",
                            "Fiscal.Year",
                            "FacilityCategoryTitle",
                            "LocationTitle",
                            "ConstructionProject",
                            "ConstructionProjectTitle",
                            "Classified",
                            "BudgetType"
                         )
)


c1sum<-ddply(c1data,
      .(Account,AccountTitle,Organization,Fiscal.Year,BudgetType,variable),
      plyr::summarise,
      value=sum(value)
      )



```


##M-1
```{r M-1}
# Load workbook M1
m1xls <- loadWorkbook(file.path("Data","FY2016","m1.xlsx"))
m1data <- readWorksheet(m1xls, sheet = "Exhibit M-1", header=TRUE,startRow=2)
m1data<-standardize_variable_names(Path,m1data)


colnames(m1data)[colnames(m1data)=="Account"]<-"AccountDSI"
colnames(m1data)
m1data$SourceFiscalYear<-2016
m1data<-melt(m1data,
                  id.vars=c("SourceFiscalYear",
                            "AccountDSI",
                            "AccountTitle",
                            "Organization" ,
                            "BudgetActivity",
                            "BudgetActivityTitle",
                            "BudgetSubActivity",
                            "BudgetSubActivityTitle",
                            "AddOrNonAdd",
                            "IncludeInTOA",
                            "Classified"
                         )
)


m1sum<-ddply(m1data,
      .(AccountDSI,AccountTitle,Organization,variable),
      plyr::summarise,
      value=sum(value)
      )



```


##O-1
```{r o-1}
# Load workbook o1
o1xls <- loadWorkbook(file.path("Data","FY2016","o1.xlsx"))
o1data <- readWorksheet(o1xls, sheet = "Total O&M Title plus Indefinite", header=TRUE,startRow=2)
o1data<-standardize_variable_names(Path,o1data)

colnames(o1data)[colnames(o1data)=="Account"]<-"AccountDSI"
colnames(o1data)
o1data$SourceFiscalYear<-2016
o1data<-melt(o1data,
                  id.vars=c("SourceFiscalYear",
                            "AccountDSI",
                            "AccountTitle",
                            "Organization" ,
                            "BudgetActivity",
                            "BudgetActivityTitle",
                            "AGtitle",
                            "LineNumber",
                            "SAG",
                            "SAGtitle",
                            "IncludeInTOA",
                            "Classified"
                         )
)


o1sum<-ddply(o1data,
      .(AccountDSI,AccountTitle,Organization,variable),
      plyr::summarise,
      value=sum(value)
      )

```

##RF-1

```{r rf-1}
# Load workbook rf1
rf1xls <- loadWorkbook(file.path("Data","FY2016","rf1.xlsx"))
rf1data <- readWorksheet(rf1xls, sheet = "RF Title", header=TRUE,startRow=2)
rf1data<-standardize_variable_names(Path,rf1data)
colnames(rf1data)[colnames(rf1data)=="Account"]<-"AccountDSI"
colnames(rf1data)
rf1data$SourceFiscalYear<-2016
rf1data<-melt(rf1data,
                  id.vars=c("SourceFiscalYear",
                            "AccountDSI",
                            "AccountTitle",
                            "Organization" ,
                            "BudgetActivity",
                            "BudgetActivityTitle",
                            "AGtitle",
                            "LineNumber",
                            "SAG",
                            "SAGtitle",
                            "Classified"
                         )
)


rf1sum<-ddply(rf1data,
      .(AccountDSI,AccountTitle,Organization,variable),
      plyr::summarise,
      value=sum(value)
      )



```

##Procurement

```{r Procurement}
# debug(create_procedural_graphs
Procurement <- read.xlsx2("./Data/p1_FY2017.xlsx", 
                            sheetName = "Exhibit P-1",
                            startRow=2)

Procurement$SourceFiscalYear<-2017
Procurement<-standardize_variable_names(Path,Procurement)
colnames(Procurement)[colnames(Procurement)=="Account"]<-"AccountDSI"

colnames(Procurement)
Procurement$FY.2015..Base...OCO..Quantity <- as.numeric(as.character(Procurement$FY.2015..Base...OCO..Quantity))
Procurement$FY.2015..Base...OCO..Amount <- as.numeric(as.character(Procurement$FY.2015..Base...OCO..Amount))
Procurement$FY.2016.Base.Enacted.Quantity <- as.numeric(as.character(Procurement$FY.2016.Base.Enacted.Quantity))
Procurement$FY.2016.Base.Enacted.Amount <- as.numeric(as.character(Procurement$FY.2016.Base.Enacted.Amount))
Procurement$FY.2016.OCO.Enacted.Quantity <- as.numeric(as.character(Procurement$FY.2016.OCO.Enacted.Quantity))
Procurement$FY.2016.OCO.Enacted.Amount <- as.numeric(as.character(Procurement$FY.2016.OCO.Enacted.Amount))
Procurement$FY.2016.Total.Enacted.Quantity <- as.numeric(as.character(Procurement$FY.2016.Total.Enacted.Quantity))
Procurement$FY.2016.Total.Enacted.Amount <- as.numeric(as.character(Procurement$FY.2016.Total.Enacted.Amount))
Procurement$FY.2017.Base.Quantity <- as.numeric(as.character(Procurement$FY.2017.Base.Quantity))
Procurement$FY.2017.Base.Amount <- as.numeric(as.character(Procurement$FY.2017.Base.Amount))
Procurement$FY.2017.OCO.Quantity <- as.numeric(as.character(Procurement$FY.2017.OCO.Quantity))
Procurement$FY.2017.OCO.Amount <- as.numeric(as.character(Procurement$FY.2017.OCO.Amount))
Procurement$FY.2017.Total.Quantity <- as.numeric(as.character(Procurement$FY.2017.Total.Quantity))
Procurement$FY.2017.Total.Amount <- as.numeric(as.character(Procurement$FY.2017.Total.Amount))
Procurement$FY.2017.OCO.Quantity <- as.numeric(as.character(Procurement$FY.2017.OCO.Quantity))

# View(subset(Procurement,FY.2016.Total.Enacted.Amount>0))

Procurement<-melt(Procurement,
                  id.vars=c("SourceFiscalYear"
                            ,"AccountDSI"
                         ,"AccountTitle"
                         ,"Organization"
                         ,"BudgetActivity"
                         ,"BudgetActivityTitle"
                         ,"LineNumber"
                         ,"BSA"
                         ,"BSAtitle"
                         ,"LineItem"
                         ,"LineItemTitle"
                         ,"CostType"
                         ,"CostTypeTitle"
                         ,"AddOrNonAdd"
                         ,"Classified"
                         )
)




Procurement$FiscalYear<-as.numeric(substring(as.character(Procurement$variable),4,7))
Procurement$variable<-substring(as.character(Procurement$variable),9,999)


 
#I'm probably going to switch this to a CSV
Procurement<-read_and_join(
    ""
    ,"RenameComptrollerColumns.csv"
    ,Procurement
)

# 
# unique(Procurement$variable)
# View(subset(Procurement,variable=="Total.Enacted.Amount"))


#     
# Procurement$AllColumns<-ordered(Procurement$AllColumns,c("PB",
#                                                      "App",
#                                                      "Actual",
#                                                      "CR",
#                                                      "CR_OCO",
#                                                      "OCO_PB",
#                                                      "Base_PB",
#                                                      "OCO_App",
#                                                      "Base_App",
#                                                      "OCO_Sup",
#                                                      "Quant_PB",
#                                                      "Quant_App",
#                                                      "Quant_Actual",
#                                                      "Quant_CR",
#                                                      "Quant_CR_OCO",
#                                                      "Quant_OCO_PB",
#                                                      "Quant_Base_PB",
#                                                      "Quant_OCO_App",
#                                                      "Quant_Base_App",
#                                                      "Quant_OCO_Sup"
# ))
# unique(Procurement$AllColumns)
unique(Procurement$Consolidate)


Procurement<-subset(Procurement,!is.na(value))


str(Procurement)

# 
# 
# ProcurementAllColumns<-dcast(subset(Procurement,select=-c(variable,SourceColumn,Consolidate,OriginType)), 
#                    Account
#                    +BudgetActivity
#                    +BudgetActivityTitle
#                    +BSA
#                    +BSAtitle
#                    +LineItem
#                    +LineItemTitle
#                    +CostType
#                    +CostTypeTitle
#                    +AddOrNonAdd
#                    +Classified
#                    + FiscalYear~ AllColumns ,
#                    sum, 
#                    fill=NA_real_ )
# 
# write.csv(ProcurementAllColumns,paste("Data\\","P12016_AllColumns.csv",sep=""), row.names=FALSE,na="")
# str(ProcurementAllColumns)


ProcurementConsolidated<-reshape2::dcast(subset(Procurement,select=-c(variable,SourceColumn,AllColumns)), 
                             SourceFiscalYear
                             +AccountDSI
                             +AccountTitle
                             +Organization
                             +BudgetActivity
                             +BudgetActivityTitle
                             +LineNumber
                             +BSA
                             +BSAtitle
                             +LineItem
                             +LineItemTitle
                             +CostType
                             +CostTypeTitle
                             +Classified
                             +AddOrNonAdd
                             + FiscalYear
                             + OriginType ~  Consolidate   ,
                             sum, 
                             fill=NA_real_ )




ProcurementsqlColumns<-c(	"ID"  ,
                          "SourceFiscalYear"  ,
                          "AccountDSI"  ,
                          "TreasuryAgencyCode"  ,
                          "MainAccountCode"  ,
                          "AccountTitle"  ,
                          "Organization"  ,
                          "BudgetActivity"  ,
                          "BudgetActivityTitle"  ,
                          "LineNumber" ,
                          "BSA"   ,
                          "BSAtitle"  ,
                          "LineItem"  ,
                          "LineItemTitle"  ,
                          "CostType"  ,
                          "CostTypeTitle"  ,
                          "AddOrNonAdd"  ,
                          "Classified"  ,
                          "Category"  ,
                          "FiscalYear"  ,
                          "OriginType" ,
                          "PBtotal" ,
                          "PBtype"  ,
                          "EnactedTotal"  ,
                          "EnactedType"  ,
                          "SpecialType"  ,
                          "ActualTotal"  ,
                          "QuantPBtotal"  ,
                          "QuantPBtype"  ,
                          "QuantEnactedTotal"  ,
                          "QuantEnactedType"  ,
                          "QuantSpecialTotal"  ,
                          "QuantActualTotal"  
) 

Missing<-ProcurementsqlColumns[!ProcurementsqlColumns %in% colnames(ProcurementConsolidated)]
ProcurementConsolidated[,Missing]<-NA

ProcurementConsolidated<-ProcurementConsolidated[,ProcurementsqlColumns]

write.csv(ProcurementConsolidated,paste("Data\\","P1_2017_Consolidated.csv",sep=""), 
          row.names=FALSE,
          na="")
str(ProcurementConsolidated)

```
##RnD

```{r RnD}


RnD <- read.xlsx2("./Data/r1_display_FY2017.xlsx", 
                            sheetName = "Exhibit R-1",
                            startRow=2)

RnD$SourceFiscalYear<-2017


RnD<-standardize_variable_names(Path,RnD)
colnames(RnD)[colnames(RnD)=="Account"]<-"AccountDSI"
colnames(RnD)


RnD$FY.2015..Base...OCO. <- as.numeric(as.character(RnD$FY.2015..Base...OCO.))
RnD$FY.2016.Base.Enacted <- as.numeric(as.character(RnD$FY.2016.Base.Enacted))
RnD$FY.2016.OCO.Enacted <- as.numeric(as.character(RnD$FY.2016.OCO.Enacted))
RnD$FY.2016.Total.Enacted <- as.numeric(as.character(RnD$FY.2016.Total.Enacted))
RnD$FY.2017.Base <- as.numeric(as.character(RnD$FY.2017.Base))
RnD$FY.2017.OCO <- as.numeric(as.character(RnD$FY.2017.OCO))
RnD$FY.2017.Total <- as.numeric(as.character(RnD$FY.2017.Total))


RnD$LineNumber <- as.numeric(as.character(RnD$LineNumber))


RnD<-melt(RnD
          , id.vars =c("SourceFiscalYear"
                       ,"AccountDSI"
                 ,"AccountTitle"
                 ,"Organization"
                 ,"BudgetActivity"
                 ,"BudgetActivityTitle"
                 ,"LineNumber"
                 ,"ProgramElement"
                 ,"ProgramElementTitle"
                 ,"IncludeInTOA"
                 ,"Classified"
                 )
          # ,value.name="DollarsThousands"
)



RnD$FiscalYear<-as.numeric(substring(as.character(RnD$variable),4,7))
RnD$variable<-substring(as.character(RnD$variable),9,999)
str(RnD$variable)

RnD<-read_and_join(
    ""
    ,"RenameComptrollerColumns.csv"
    ,RnD
)


# RnD$variable[RnD$variable==".Base...OCO."]<-"Actual" #"(Base & OCO)
# RnD$variable[RnD$variable=="Base.Enacted"]<-"Base.App"
# RnD$variable[RnD$variable=="OCO.Enacted"]<-"OCO.App"
# RnD$variable[RnD$variable=="Total.Enacted"]<-"Quant.App"
# RnD$variable[RnD$variable=="Base"]<-"Base.PB"
# RnD$variable[RnD$variable=="OCO"]<-"OCO.PB"
# RnD$variable[RnD$variable=="Total"]<-"PB"


RnD$variable<-ordered(RnD$variable,c("PB",
                                     "App",
                                     "Actual",
                                     "CR",
                                     "CR_OCO",
                                     "OCO_PB",
                                     "OCO_App",
                                     "OCO_Sup"
                                     
))


colnames(RnD)
RnD<-subset(RnD,!is.na(value))
str(RnD)

# 
# RnDallColumns<-dcast(subset(RnD,select=-c(variable,SourceColumn,Consolidate,OriginType)),
#                      Account+
#                AccountTitle+
#                Organization+
#                BudgetActivity+
#                BudgetActivityTitle+
#                LineNumber+
#                ProgramElement+
#             ProgramElementTitle+
#                IncludeInTOA+
#                Classified+ 
#                FiscalYear ~ AllColumns ,
#            sum, 
#            fill=NA_real_ )
# 
# 
# 
# 
# write.csv(RnDallColumns,paste("Data\\","R12016_AllColumns.csv",sep=""), row.names=FALSE,na="")
# 

RnDconsolidated<-dcast(subset(RnD,select=-c(variable,AllColumns)),
                     SourceFiscalYear+
                         AccountDSI+
                         AccountTitle+
                         Organization+
                         BudgetActivity+
                         BudgetActivityTitle+
                         LineNumber+
                         ProgramElement+
                         ProgramElementTitle+
                         IncludeInTOA+
                         Classified+ 
                         FiscalYear+
                         OriginType ~ Consolidate ,
                     sum, 
                     fill=NA_real_ )



RnDsqlColumns<-c("ID"
                 ,"SourceFiscalYear"
                 ,"AccountDSI"
                 ,"TreasuryAgencyCode"
                 ,"MainAccountCode"
                 ,"AccountTitle"
                 ,"Organization"
                 ,"BudgetActivity"
                 ,"BudgetActivityTitle"
                 ,"LineNumber"
                 ,"ProgramElement"
                 ,"ProgramElementTitle"
                 ,"IncludeInTOA"
                 ,"Classified"
                 ,"FiscalYear"
                 ,"OriginType"
                 ,"PBtotal"
                 ,"PBtype"
                 ,"EnactedTotal"
                 ,"EnactedType"
                 ,"SpecialType"
                 ,"ActualTotal") 


Missing<-RnDsqlColumns[!RnDsqlColumns %in% colnames(RnDconsolidated)]
RnDconsolidated[,Missing]<-NA
RnDconsolidated<-RnDconsolidated[,RnDsqlColumns]


write.csv(RnDconsolidated,paste("Data\\","R1_2017_Consolidated.csv",sep=""), 
          row.names=FALSE,
          na="")

```